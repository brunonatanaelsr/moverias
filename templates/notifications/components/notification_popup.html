{% load notification_tags %}

<div class="notification-popup" id="notificationPopup">
    <div class="relative">
        <button class="mm-btn mm-btn-outline-primary mm-dropdown-toggle relative" type="button" 
                onclick="toggleNotificationDropdown()" aria-expanded="false" id="notificationButton">
            <i class="fas fa-bell"></i>
            <span class="notification-count mm-badge mm-badge-danger absolute -top-1 -right-1 rounded-full" 
                  id="notificationCount" style="display: none;">0</span>
        </button>
        
        <div class="mm-dropdown-menu hidden" id="notificationDropdown" style="width: 400px; max-height: 400px; overflow-y: auto;">
            <div class="mm-dropdown-header flex justify-between items-center">
                <h6 class="mb-0 font-medium">Notificações</h6>
                <button class="mm-btn mm-btn-sm mm-btn-outline-primary" onclick="markAllAsRead()">
                    <i class="fas fa-check-double"></i> Marcar todas como lidas
                </button>
            </div>
            
            <div class="mm-dropdown-divider"></div>
            
            <div id="notificationList" class="notification-list">
                <div class="text-center text-gray-500 p-3">
                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                    <p class="mb-0">Nenhuma notificação</p>
                </div>
            </div>
            
            <div class="mm-dropdown-divider"></div>
            
            <div class="mm-dropdown-item-text text-center">
                <a href="{% url 'notifications:list' %}" class="mm-btn mm-btn-sm mm-btn-primary">
                    Ver todas as notificações
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notificationButton = document.getElementById('notificationButton');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    
    // Atualizar notificações
    function updateNotifications() {
        fetch('{% url "notifications:popup" %}')
            .then(response => response.json())
            .then(data => {
                const notifications = data.notifications || [];
                
                // Atualizar contador
                if (notifications.length > 0) {
                    notificationCount.textContent = notifications.length;
                    notificationCount.style.display = 'block';
                } else {
                    notificationCount.style.display = 'none';
                }
                
                // Atualizar lista
                if (notifications.length > 0) {
                    notificationList.innerHTML = notifications.map(notification => `
                        <div class="mm-dropdown-item notification-item" data-id="${notification.id}">
                            <div class="flex">
                                <div class="mr-3">
                                    <i class="fas fa-circle text-purple-move" style="font-size: 8px;"></i>
                                </div>
                                <div class="flex-grow">
                                    <h6 class="mb-1 text-sm font-medium">${notification.title}</h6>
                                    <p class="mb-1 text-sm text-gray-600">${notification.message}</p>
                                    <text-sm class="text-gray-500">${notification.created_at}</text-sm>
                                </div>
                                <div class="ml-2">
                                    <button class="mm-btn mm-btn-sm mm-btn-outline-secondary" onclick="markAsRead(${notification.id})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    notificationList.innerHTML = `
                        <div class="text-center text-gray-500 p-3">
                            <i class="fas fa-bell-slash text-2xl mb-2"></i>
                            <p class="mb-0">Nenhuma notificação</p>
                        </div>
                    `;
                }
            })
            .catch(error => console.error('Erro ao carregar notificações:', error));
    }
    
    // Função para toggle do dropdown
    window.toggleNotificationDropdown = function() {
        const dropdown = document.getElementById('notificationDropdown');
        dropdown.classList.toggle('hidden');
    };
    
    // Fechar dropdown quando clicar fora
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('notificationDropdown');
        const button = document.getElementById('notificationButton');
        
        if (!button.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Atualizar a cada 30 segundos
    updateNotifications();
    setInterval(updateNotifications, 30000);
    
    // Atualizar quando o dropdown for aberto
    notificationButton.addEventListener('click', updateNotifications);
});

function markAsRead(notificationId) {
    fetch(`{% url "notifications:mark_read" 0 %}`.replace('0', notificationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remover notificação da lista
            const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);
            if (notificationItem) {
                notificationItem.remove();
            }
            
            // Atualizar contador
            const countElement = document.getElementById('notificationCount');
            const currentCount = parseInt(countElement.textContent) - 1;
            if (currentCount > 0) {
                countElement.textContent = currentCount;
            } else {
                countElement.style.display = 'none';
            }
        }
    })
    .catch(error => console.error('Erro ao marcar como lida:', error));
}

function markAllAsRead() {
    fetch('{% url "notifications:mark_all_read" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpar lista
            document.getElementById('notificationList').innerHTML = `
                <div class="text-center text-gray-500 p-3">
                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                    <p class="mb-0">Nenhuma notificação</p>
                </div>
            `;
            
            // Ocultar contador
            document.getElementById('notificationCount').style.display = 'none';
        }
    })
    .catch(error => console.error('Erro ao marcar todas como lidas:', error));
}
</script>
