{% extends 'components/list_base.html' %}

{% block page_title %}Notificações{% endblock %}

{% block breadcrumb_items %}
<span>Notificações</span>
{% endblock %}

{% block filters %}
{{ block.super }}

<div class="flex-1 min-w-48">
    <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        Status
    </label>
    <select id="status" name="status" class="mm-input">
        <option value="">Todos</option>
        <option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>
            Não lidas
        </option>
        <option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>
            Lidas
        </option>
    </select>
</div>

<div class="flex-1 min-w-48">
    <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
        Tipo
    </label>
    <select id="type" name="type" class="mm-input">
        <option value="">Todos os tipos</option>
        {% for type_code, type_name in types %}
        <option value="{{ type_code }}" {% if request.GET.type == type_code %}selected{% endif %}>
            {{ type_name }}
        </option>
        {% endfor %}
    </select>
</div>
{% endblock %}

{% block stats %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="mm-card p-4">
        <div class="flex items-center">
            <div class="p-2 bg-blue-100 rounded-lg">
                <i class="fas fa-bell text-blue-600"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ page_obj.paginator.count }}</p>
            </div>
        </div>
    </div>
    
    <div class="mm-card p-4">
        <div class="flex items-center">
            <div class="p-2 bg-yellow-100 rounded-lg">
                <i class="fas fa-envelope text-yellow-600"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Não lidas</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ unread_count }}</p>
            </div>
        </div>
    </div>
    
    <div class="mm-card p-4">
        <div class="flex items-center">
            <div class="p-2 bg-green-100 rounded-lg">
                <i class="fas fa-check text-green-600"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Lidas</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ page_obj.paginator.count|add:"-"|add:unread_count }}</p>
            </div>
        </div>
    </div>
    
    <div class="mm-card p-4">
        <div class="flex items-center">
            <div class="p-2 bg-purple-100 rounded-lg">
                <i class="fas fa-clock text-purple-600"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Hoje</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ today_count|default:0 }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block header_actions %}
{% if user_permissions.can_create_notifications %}
<a href="{% url 'notifications:create' %}" class="mm-btn mm-btn-primary">
    <i class="fas fa-plus"></i>
    Nova Notificação
</a>
{% endif %}

<button onclick="markAllAsRead()" class="mm-btn mm-btn-secondary">
    <i class="fas fa-check-double"></i>
    Marcar Todas como Lidas
</button>
{% endblock %}

{% block table_headers %}
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
    <i class="fas fa-envelope mr-1"></i>
    Notificação
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
    <i class="fas fa-tag mr-1"></i>
    Tipo
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
    <i class="fas fa-flag mr-1"></i>
    Prioridade
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
    <i class="fas fa-calendar mr-1"></i>
    Data
</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
    <i class="fas fa-cog mr-1"></i>
    Ações
</th>
{% endblock %}

{% block table_row %}
<td class="px-6 py-4">
    <div class="flex items-start">
        <div class="flex-shrink-0 mr-3">
            <div class="w-2 h-2 rounded-full mt-2 {% if object.status == 'pending' %}bg-blue-500{% else %}bg-gray-300{% endif %}"></div>
        </div>
        <div class="flex-1">
            <div class="text-sm font-medium text-gray-900 dark:text-white {% if object.status == 'pending' %}font-semibold{% else %}font-normal{% endif %}">
                {{ object.title }}
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                {{ object.message|truncatechars:100 }}
            </div>
        </div>
    </div>
</td>
<td class="px-6 py-4 whitespace-nowrap">
    <span class="mm-badge mm-badge-info">
        {{ object.get_type_display }}
    </span>
</td>
<td class="px-6 py-4 whitespace-nowrap">
    {% if object.priority == 1 %}
        <span class="mm-badge mm-badge-success">
            <i class="fas fa-arrow-down mr-1"></i>
            Baixa
        </span>
    {% elif object.priority == 2 %}
        <span class="mm-badge mm-badge-info">
            <i class="fas fa-minus mr-1"></i>
            Normal
        </span>
    {% elif object.priority == 3 %}
        <span class="mm-badge mm-badge-warning">
            <i class="fas fa-arrow-up mr-1"></i>
            Alta
        </span>
    {% else %}
        <span class="mm-badge mm-badge-error">
            <i class="fas fa-exclamation mr-1"></i>
            Urgente
        </span>
    {% endif %}
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
    <div>{{ object.created_at|date:"d/m/Y" }}</div>
    <div class="text-xs">{{ object.created_at|date:"H:i" }}</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
    <div class="flex items-center space-x-2">
        {% if object.status == 'pending' %}
        <button onclick="markAsRead({{ object.id }})" 
                class="text-blue-600 hover:text-blue-900 dark:text-blue-400"
                title="Marcar como lida">
            <i class="fas fa-check"></i>
        </button>
        {% endif %}
        
        <a href="{% url 'notifications:detail' object.id %}" 
           class="text-move-purple-600 hover:text-move-purple-900 dark:text-move-purple-400"
           title="Ver detalhes">
            <i class="fas fa-eye"></i>
        </a>
        
        {% if user_permissions.can_edit_notifications %}
        <a href="{% url 'notifications:edit' object.id %}" 
           class="text-blue-600 hover:text-blue-900 dark:text-blue-400"
           title="Editar">
            <i class="fas fa-edit"></i>
        </a>
        {% endif %}
        
        <button onclick="confirmDelete({{ object.id }}, '{{ object.title }}')" 
                class="text-red-600 hover:text-red-900 dark:text-red-400"
                title="Excluir">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</td>
{% endblock %}

{% block empty_icon %}bell{% endblock %}
{% block empty_title %}Nenhuma notificação encontrada{% endblock %}
{% block empty_message %}Você não tem notificações no momento.{% endblock %}

{% block list_js %}
function markAsRead(notificationId) {
    fetch(`{% url 'notifications:mark_read' 0 %}`.replace('0', notificationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Notificação marcada como lida', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Erro ao marcar notificação', 'error');
        }
    })
    .catch(error => {
        showToast('Erro ao marcar notificação', 'error');
    });
}

function markAllAsRead() {
    if (confirm('Marcar todas as notificações como lidas?')) {
        showLoading();
        
        fetch('{% url "notifications:mark_all_read" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message || 'Todas as notificações foram marcadas como lidas', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Erro ao marcar notificações', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('Erro ao marcar notificações', 'error');
        });
    }
}

// Auto-refresh notifications count
setInterval(() => {
    fetch('{% url "notifications:count" %}')
        .then(response => response.json())
        .then(data => {
            // Update notification count in header if needed
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                badge.textContent = data.count;
                badge.style.display = data.count > 0 ? 'block' : 'none';
            }
        })
        .catch(error => {
            console.error('Error updating notification count:', error);
        });
}, 30000); // Update every 30 seconds
{% endblock %}
