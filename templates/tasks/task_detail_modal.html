{% load static %}

<div class="modal-header">
    <h5 class="modal-title">
        <span class="badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
        {{ task.title }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <div class="grid-optimized grid-optimized-2">
        <!-- Coluna Principal -->
        <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
            <!-- Descrição -->
            <div class="section-spacing-sm">
                <h6>Descrição</h6>
                {% if task.description %}
                    <div class="border rounded p-3 bg-light">
                        {{ task.description|linebreaks }}
                    </div>
                {% else %}
                    <p class="text-gray-600">Nenhuma descrição fornecida.</p>
                {% endif %}
            </div>

            <!-- Comentários -->
            <div class="section-spacing-sm">
                <div class="flex justify-between items-center mb-3">
                    <h6>Comentários ({{ task.comments.count }})</h6>
                    <button class="mm-btn mm-btn-sm mm-btn-primary" onclick="toggleCommentForm()">
                        <i class="fas fa-comment"></i> Comentar
                    </button>
                </div>

                <!-- Formulário de Comentário -->
                <div id="commentForm" class="mm-card mb-3" style="display: none;">
                    <div class="mm-card-body">
                        <form id="newCommentForm">
                            <div class="mb-3">
                                <textarea class="mm-form-textarea" name="content" rows="3" placeholder="Adicione um comentário..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button type="button" class="mm-btn mm-btn-sm mm-btn-secondary" onclick="toggleCommentForm()">Cancelar</button>
                                <button type="button" class="mm-btn mm-btn-sm mm-btn-primary" onclick="saveComment({{ task.id }})">Comentar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de Comentários -->
                <div class="comments-list">
                    {% for comment in task.comments.all %}
                    <div class="comment mb-3" data-comment-id="{{ comment.id }}">
                        <div class="flex">
                            <img src="{{ comment.author.profile.photo.url|default:'/static/img/default-avatar.png' }}" 
                                 class="rounded-full mr-3" width="40" height="40" alt="Avatar">
                            <div class="flex-grow">
                                <div class="bg-light rounded p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <strong>{{ comment.author.get_full_name }}</strong>
                                        <text-sm class="text-gray-600">{{ comment.created_at|timesince }} atrás</text-sm>
                                    </div>
                                    <p class="mb-0">{{ comment.content|linebreaks }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-2x text-gray-600 mb-2"></i>
                        <p class="text-gray-600">Nenhum comentário ainda. Seja o primeiro!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Anexos -->
            <div class="section-spacing-sm">
                <div class="flex justify-between items-center mb-3">
                    <h6>Anexos ({{ task.attachments.count }})</h6>
                    <button class="mm-btn mm-btn-sm mm-btn-outline-primary" onclick="openFileUpload()">
                        <i class="fas fa-paperclip"></i> Anexar Arquivo
                    </button>
                </div>

                <input type="file" id="fileUpload" multiple style="display: none;" onchange="uploadFiles({{ task.id }})">

                <div class="attachments-list">
                    {% for attachment in task.attachments.all %}
                    <div class="attachment-item border rounded p-3 mb-2">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <i class="fas fa-file fa-2x text-gray-600 mr-3"></i>
                                <div>
                                    <div class="font-bold">{{ attachment.file_name }}</div>
                                    <text-sm class="text-gray-600">
                                        {{ attachment.file_size|filesizeformat }} • 
                                        {{ attachment.uploaded_at|date:"d/m/Y H:i" }} • 
                                        {{ attachment.uploaded_by.get_full_name }}
                                    </text-sm>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <a href="{{ attachment.file.url }}" class="mm-btn mm-btn-sm mm-btn-outline-primary" download>
                                    <i class="fas fa-download"></i>
                                </a>
                                <button class="mm-btn mm-btn-sm mm-btn-outline-danger" onclick="deleteAttachment({{ attachment.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-paperclip fa-2x text-gray-600 mb-2"></i>
                        <p class="text-gray-600">Nenhum arquivo anexado.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Histórico de Atividades -->
            <div class="section-spacing-sm">
                <h6>Histórico de Atividades</h6>
                <div class="activity-timeline">
                    {% for activity in task.activities.all %}
                    <div class="activity-item flex mb-3">
                        <div class="activity-icon mr-3">
                            <i class="fas fa-{{ activity.get_action_icon }} text-gray-600"></i>
                        </div>
                        <div class="activity-content">
                            <div class="font-bold">{{ activity.user.get_full_name }}</div>
                            <div class="text-gray-600">{{ activity.description }}</div>
                            <text-sm class="text-gray-600">{{ activity.created_at|timesince }} atrás</text-sm>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-2x text-gray-600 mb-2"></i>
                        <p class="text-gray-600">Nenhuma atividade registrada.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="task-sidebar">
                <!-- Informações da Tarefa -->
                <div class="card mb-3">
                    <div class="card-padding-md border-b">
                        <h6 class="mb-0">Informações da Tarefa</h6>
                    </div>
                    <div class="card-padding-md">
                        <div class="mb-3">
                            <label class="form-label-optimized">Status</label>
                            <select class="form-select" id="taskStatus" onchange="updateTaskStatus({{ task.id }})">
                                <option value="backlog" {% if task.status == 'backlog' %}selected{% endif %}>Backlog</option>
                                <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>Em Progresso</option>
                                <option value="review" {% if task.status == 'review' %}selected{% endif %}>Em Revisão</option>
                                <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Concluído</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-optimized">Responsável</label>
                            <select class="form-select" id="taskAssignee" onchange="updateTaskAssignee({{ task.id }})">
                                <option value="">Não atribuído</option>
                                {% for member in task.board.members.all %}
                                <option value="{{ member.id }}" {% if task.assignee == member %}selected{% endif %}>
                                    {{ member.get_full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-optimized">Data de Vencimento</label>
                            <input type="date" class="input-field" id="taskDueDate" 
                                   value="{{ task.due_date|date:'Y-m-d' }}" 
                                   onchange="updateTaskDueDate({{ task.id }})">
                        </div>

                        <div class="mb-3">
                            <label class="form-label-optimized">Prioridade</label>
                            <select class="form-select" id="taskPriority" onchange="updateTaskPriority({{ task.id }})">
                                <option value="low" {% if task.priority == 'low' %}selected{% endif %}>Baixa</option>
                                <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>Média</option>
                                <option value="high" {% if task.priority == 'high' %}selected{% endif %}>Alta</option>
                            </select>
                        </div>

                        <div class="grid-optimized grid-optimized-2">
                            <div class="col-6">
                                <label class="form-label-optimized">Horas Estimadas</label>
                                <input type="number" class="input-field" id="taskEstimatedHours" 
                                       value="{{ task.estimated_hours }}" step="0.5"
                                       onchange="updateTaskEstimatedHours({{ task.id }})">
                            </div>
                            <div class="col-6">
                                <label class="form-label-optimized">Custo (R$)</label>
                                <input type="number" class="input-field" id="taskEstimatedCost" 
                                       value="{{ task.estimated_cost }}" step="0.01"
                                       onchange="updateTaskEstimatedCost({{ task.id }})">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Labels -->
                <div class="card mb-3">
                    <div class="card-padding-md border-b">
                        <h6 class="mb-0">Labels</h6>
                    </div>
                    <div class="card-padding-md">
                        <div class="labels-container">
                            {% for label in task.labels.all %}
                            <span class="badge mr-1 mb-1" style="background-color: {{ label.color }}">
                                {{ label.name }}
                                <button class="btn-close ml-1" onclick="removeLabel({{ task.id }}, {{ label.id }})" style="font-size: 0.7em;"></button>
                            </span>
                            {% endfor %}
                        </div>
                        <div class="mt-2">
                            <select class="form-select" id="addLabel" onchange="addLabel({{ task.id }})">
                                <option value="">Adicionar label...</option>
                                {% for label in task.board.labels.all %}
                                {% if label not in task.labels.all %}
                                <option value="{{ label.id }}">{{ label.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Watchers -->
                <div class="card mb-3">
                    <div class="card-padding-md border-b">
                        <h6 class="mb-0">Observadores</h6>
                    </div>
                    <div class="card-padding-md">
                        <div class="watchers-list">
                            {% for watcher in task.watchers.all %}
                            <div class="flex items-center mb-2">
                                <img src="{{ watcher.profile.photo.url|default:'/static/img/default-avatar.png' }}" 
                                     class="rounded-full mr-2" width="30" height="30" alt="Avatar">
                                <span class="flex-grow">{{ watcher.get_full_name }}</span>
                                <button class="mm-btn mm-btn-sm mm-btn-outline-danger" onclick="removeWatcher({{ task.id }}, {{ watcher.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-2">
                            <select class="mm-form-select" id="addWatcher" onchange="addWatcher({{ task.id }})">
                                <option value="">Adicionar observador...</option>
                                {% for member in task.board.members.all %}
                                {% if member not in task.watchers.all %}
                                <option value="{{ member.id }}">{{ member.get_full_name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Ações -->
                <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                    <div class="card-padding-md border-b">
                        <h6 class="mb-0">Ações</h6>
                    </div>
                    <div class="mm-card-body">
                        <div class="grid gap-2">
                            <button class="mm-btn mm-btn-outline-primary" onclick="duplicateTask({{ task.id }})">
                                <i class="fas fa-copy"></i> Duplicar Tarefa
                            </button>
                            <button class="mm-btn mm-btn-outline-warning" onclick="editTask({{ task.id }})">
                                <i class="fas fa-edit"></i> Editar Tarefa
                            </button>
                            <button class="mm-btn mm-btn-outline-danger" onclick="deleteTask({{ task.id }})">
                                <i class="fas fa-trash"></i> Excluir Tarefa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn-secondary" data-bs-dismiss="modal">Fechar</button>
    <button type="button" class="btn-primary" onclick="saveTaskChanges({{ task.id }})">Salvar Alterações</button>
</div>

<script>
function toggleCommentForm() {
    const form = document.getElementById('commentForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function saveComment(taskId) {
    const form = document.getElementById('newCommentForm');
    const formData = new FormData(form);
    
    fetch(`{% url "tasks:task_comment_add" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao adicionar comentário');
        }
    });
}

function openFileUpload() {
    document.getElementById('fileUpload').click();
}

function uploadFiles(taskId) {
    const files = document.getElementById('fileUpload').files;
    if (files.length === 0) return;
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    fetch(`/tasks/upload/${taskId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao fazer upload');
        }
    });
}

function updateTaskStatus(taskId) {
    const status = document.getElementById('taskStatus').value;
    updateTaskField(taskId, 'status', status);
}

function updateTaskAssignee(taskId) {
    const assignee = document.getElementById('taskAssignee').value;
    updateTaskField(taskId, 'assignee', assignee);
}

function updateTaskDueDate(taskId) {
    const dueDate = document.getElementById('taskDueDate').value;
    updateTaskField(taskId, 'due_date', dueDate);
}

function updateTaskPriority(taskId) {
    const priority = document.getElementById('taskPriority').value;
    updateTaskField(taskId, 'priority', priority);
}

function updateTaskEstimatedHours(taskId) {
    const hours = document.getElementById('taskEstimatedHours').value;
    updateTaskField(taskId, 'estimated_hours', hours);
}

function updateTaskEstimatedCost(taskId) {
    const cost = document.getElementById('taskEstimatedCost').value;
    updateTaskField(taskId, 'estimated_cost', cost);
}

function updateTaskField(taskId, field, value) {
    const data = {};
    data[field] = value;
    
    fetch(`{% url "tasks:task_update_ajax" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Erro ao atualizar tarefa');
        }
    });
}

function addLabel(taskId) {
    const labelId = document.getElementById('addLabel').value;
    if (!labelId) return;
    
    fetch(`{% url "tasks:task_label_add" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: JSON.stringify({ label_id: labelId }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function removeLabel(taskId, labelId) {
    fetch(`{% url "tasks:task_label_remove" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: JSON.stringify({ label_id: labelId }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function addWatcher(taskId) {
    const watcherId = document.getElementById('addWatcher').value;
    if (!watcherId) return;
    
    fetch(`{% url "tasks:task_watcher_add" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: JSON.stringify({ watcher_id: watcherId }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function removeWatcher(taskId, watcherId) {
    fetch(`{% url "tasks:task_watcher_remove" 0 %}`.replace('0', taskId), {
        method: 'POST',
        body: JSON.stringify({ watcher_id: watcherId }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
