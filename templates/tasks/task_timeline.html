{% extends 'base.html' %}
{% load static %}

{% block title %}Timeline - {{ task.title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/task-timeline.css' %}">
{% endblock %}

{% block content %}
<div class="timeline-container" x-data="taskTimeline()">
    <!-- Header -->
    <div class="timeline-header">
        <div class="header-content">
            <div class="header-nav">
                <nav class="breadcrumb">
                    <a href="{% url 'tasks:dashboard' %}" class="breadcrumb-link">
                        <svg class="breadcrumb-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        </svg>
                        Dashboard
                    </a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <a href="{% url 'tasks:board_detail' task.board.id %}" class="breadcrumb-link">
                        {{ task.board.name }}
                    </a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <a href="{% url 'tasks:task_detail' task.id %}" class="breadcrumb-link">
                        {{ task.title }}
                    </a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span class="breadcrumb-current">Timeline</span>
                </nav>
                
                <div class="title-section">
                    <h1 class="page-title">Timeline da Tarefa</h1>
                    <p class="page-subtitle">
                        Histórico completo de atividades e mudanças da tarefa #{{ task.id }}
                    </p>
                </div>
            </div>
            
            <div class="header-actions">
                <button type="button" @click="exportTimeline()" class="btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exportar Timeline
                </button>
                
                <a href="{% url 'tasks:task_detail' task.id %}" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Ver Tarefa
                </a>
            </div>
        </div>
    </div>
    
    <!-- Task Summary -->
    <div class="task-summary">
        <div class="summary-content">
            <div class="task-info">
                <div class="task-header">
                    <div class="task-priority" :class="'priority-' + task.priority"></div>
                    <h2 class="task-title">{{ task.title }}</h2>
                    <div class="task-status" :class="'status-' + task.status">
                        {{ task.get_status_display }}
                    </div>
                </div>
                
                <div class="task-meta">
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2H9z"/>
                        </svg>
                        <span>{{ task.board.name }}</span>
                    </div>
                    
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4h6M5 21h14a2 2 0 002-2V10a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z"/>
                        </svg>
                        <span>{{ task.column.name }}</span>
                    </div>
                    
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>
                            {% if task.assignees.count > 0 %}
                                {{ task.assignees.count }} responsáveis
                            {% else %}
                                Não atribuída
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="meta-item">
                        <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4h6M5 21h14a2 2 0 002-2V10a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z"/>
                        </svg>
                        <span>
                            Criada em {{ task.created_at|date:"d/m/Y H:i" }}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="timeline-stats">
                <div class="stat-card">
                    <div class="stat-value" x-text="timeline.totalEvents">{{ timeline_events.count }}</div>
                    <div class="stat-label">Eventos</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" x-text="timeline.totalDays">{{ task_age_days }}</div>
                    <div class="stat-label">Dias</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" x-text="timeline.totalComments">{{ total_comments }}</div>
                    <div class="stat-label">Comentários</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" x-text="timeline.totalChanges">{{ total_changes }}</div>
                    <div class="stat-label">Alterações</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-content">
            <div class="filter-tabs">
                <button 
                    type="button" 
                    @click="setFilter('all')" 
                    class="filter-tab"
                    :class="{ 'active': currentFilter === 'all' }"
                >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                    </svg>
                    Todos os Eventos
                    <span class="filter-count" x-text="getFilterCount('all')">{{ timeline_events.count }}</span>
                </button>
                
                <button 
                    type="button" 
                    @click="setFilter('comments')" 
                    class="filter-tab"
                    :class="{ 'active': currentFilter === 'comments' }"
                >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    Comentários
                    <span class="filter-count" x-text="getFilterCount('comments')">{{ comment_count }}</span>
                </button>
                
                <button 
                    type="button" 
                    @click="setFilter('changes')" 
                    class="filter-tab"
                    :class="{ 'active': currentFilter === 'changes' }"
                >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Alterações
                    <span class="filter-count" x-text="getFilterCount('changes')">{{ change_count }}</span>
                </button>
                
                <button 
                    type="button" 
                    @click="setFilter('status')" 
                    class="filter-tab"
                    :class="{ 'active': currentFilter === 'status' }"
                >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Status
                    <span class="filter-count" x-text="getFilterCount('status')">{{ status_change_count }}</span>
                </button>
                
                <button 
                    type="button" 
                    @click="setFilter('assignments')" 
                    class="filter-tab"
                    :class="{ 'active': currentFilter === 'assignments' }"
                >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Atribuições
                    <span class="filter-count" x-text="getFilterCount('assignments')">{{ assignment_count }}</span>
                </button>
            </div>
            
            <div class="filter-options">
                <select x-model="dateFilter" @change="applyFilters()" class="date-filter">
                    <option value="">Todos os períodos</option>
                    <option value="today">Hoje</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mês</option>
                    <option value="quarter">Este trimestre</option>
                </select>
                
                <button type="button" @click="toggleGroupByDate()" class="group-toggle" :class="{ 'active': groupByDate }">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4h6M5 21h14a2 2 0 002-2V10a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z"/>
                    </svg>
                    Agrupar por Data
                </button>
            </div>
        </div>
    </div>
    
    <!-- Timeline Content -->
    <div class="timeline-content">
        <div class="timeline-wrapper">
            <!-- Loading State -->
            <div x-show="loading" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Carregando timeline...</p>
            </div>
            
            <!-- Timeline List -->
            <div x-show="!loading && !groupByDate" class="timeline-list">
                <template x-for="(event, index) in filteredEvents" :key="event.id">
                    <div class="timeline-item" :class="'event-' + event.type">
                        <!-- Timeline Line -->
                        <div class="timeline-line">
                            <div class="timeline-dot" :class="'dot-' + event.type">
                                <!-- Event Icon -->
                                <svg x-show="event.type === 'comment'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                
                                <svg x-show="event.type === 'status_change'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                
                                <svg x-show="event.type === 'assignment'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                
                                <svg x-show="event.type === 'field_change'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                
                                <svg x-show="event.type === 'created'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                
                                <svg x-show="event.type === 'attachment'" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                </svg>
                            </div>
                            <div x-show="index < filteredEvents.length - 1" class="timeline-connector"></div>
                        </div>
                        
                        <!-- Event Content -->
                        <div class="event-content">
                            <div class="event-header">
                                <div class="event-user">
                                    <img 
                                        :src="event.user.avatar || '/static/images/default-avatar.png'" 
                                        :alt="event.user.name"
                                        class="user-avatar"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                                    >
                                    <div class="user-placeholder" style="display: none;">
                                        <span x-text="event.user.name.charAt(0).toUpperCase()"></span>
                                    </div>
                                    <div class="user-info">
                                        <span class="user-name" x-text="event.user.name"></span>
                                        <span class="user-role" x-text="event.user.role || 'Membro'"></span>
                                    </div>
                                </div>
                                
                                <div class="event-time">
                                    <span class="time-relative" x-text="formatTimeAgo(event.created_at)"></span>
                                    <span class="time-absolute" x-text="formatDateTime(event.created_at)"></span>
                                </div>
                            </div>
                            
                            <div class="event-body">
                                <!-- Comment Event -->
                                <div x-show="event.type === 'comment'" class="comment-event">
                                    <div class="comment-content" x-html="event.content"></div>
                                    <div x-show="event.attachments && event.attachments.length > 0" class="comment-attachments">
                                        <template x-for="attachment in event.attachments" :key="attachment.id">
                                            <a :href="attachment.url" class="attachment-link" target="_blank">
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                                </svg>
                                                <span x-text="attachment.name"></span>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Status Change Event -->
                                <div x-show="event.type === 'status_change'" class="status-change-event">
                                    <div class="change-description">
                                        <span>Mudou o status de </span>
                                        <span class="old-value" x-text="event.old_value"></span>
                                        <span> para </span>
                                        <span class="new-value" x-text="event.new_value"></span>
                                    </div>
                                    <div x-show="event.reason" class="change-reason">
                                        <strong>Motivo:</strong>
                                        <span x-text="event.reason"></span>
                                    </div>
                                </div>
                                
                                <!-- Assignment Event -->
                                <div x-show="event.type === 'assignment'" class="assignment-event">
                                    <div class="assignment-description">
                                        <span x-show="event.action === 'assigned'">
                                            Atribuiu a tarefa para 
                                            <span class="assignee-name" x-text="event.assignee_name"></span>
                                        </span>
                                        <span x-show="event.action === 'unassigned'">
                                            Removeu a atribuição de 
                                            <span class="assignee-name" x-text="event.assignee_name"></span>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Field Change Event -->
                                <div x-show="event.type === 'field_change'" class="field-change-event">
                                    <div class="field-change-description">
                                        <span>Alterou </span>
                                        <span class="field-name" x-text="event.field_name"></span>
                                        <template x-if="event.old_value && event.new_value">
                                            <span>
                                                de <span class="old-value" x-text="event.old_value"></span>
                                                para <span class="new-value" x-text="event.new_value"></span>
                                            </span>
                                        </template>
                                        <template x-if="!event.old_value && event.new_value">
                                            <span>
                                                para <span class="new-value" x-text="event.new_value"></span>
                                            </span>
                                        </template>
                                        <template x-if="event.old_value && !event.new_value">
                                            <span>
                                                removeu <span class="old-value" x-text="event.old_value"></span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Created Event -->
                                <div x-show="event.type === 'created'" class="created-event">
                                    <div class="created-description">
                                        <span>Criou a tarefa</span>
                                    </div>
                                </div>
                                
                                <!-- Attachment Event -->
                                <div x-show="event.type === 'attachment'" class="attachment-event">
                                    <div class="attachment-description">
                                        <span x-show="event.action === 'added'">Adicionou o anexo</span>
                                        <span x-show="event.action === 'removed'">Removeu o anexo</span>
                                        <a :href="event.attachment_url" class="attachment-name" x-text="event.attachment_name" target="_blank"></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Grouped Timeline -->
            <div x-show="!loading && groupByDate" class="timeline-grouped">
                <template x-for="(group, date) in groupedEvents" :key="date">
                    <div class="date-group">
                        <div class="date-header">
                            <h3 class="date-title" x-text="formatGroupDate(date)"></h3>
                            <span class="date-count" x-text="group.length + ' eventos'"></span>
                        </div>
                        
                        <div class="date-events">
                            <template x-for="(event, index) in group" :key="event.id">
                                <div class="timeline-item grouped-item" :class="'event-' + event.type">
                                    <div class="timeline-line">
                                        <div class="timeline-dot" :class="'dot-' + event.type">
                                            <!-- Event icons same as above -->
                                            <svg x-show="event.type === 'comment'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                            </svg>
                                            
                                            <svg x-show="event.type === 'status_change'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            
                                            <svg x-show="event.type === 'assignment'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                            </svg>
                                            
                                            <svg x-show="event.type === 'field_change'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                            
                                            <svg x-show="event.type === 'created'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                            
                                            <svg x-show="event.type === 'attachment'" width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                            </svg>
                                        </div>
                                        <div x-show="index < group.length - 1" class="timeline-connector"></div>
                                    </div>
                                    
                                    <div class="event-content compact">
                                        <div class="compact-header">
                                            <div class="compact-user">
                                                <img 
                                                    :src="event.user.avatar || '/static/images/default-avatar.png'" 
                                                    :alt="event.user.name"
                                                    class="user-avatar-small"
                                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                                                >
                                                <div class="user-placeholder-small" style="display: none;">
                                                    <span x-text="event.user.name.charAt(0).toUpperCase()"></span>
                                                </div>
                                                <span class="user-name-small" x-text="event.user.name"></span>
                                            </div>
                                            <span class="time-compact" x-text="formatTimeOnly(event.created_at)"></span>
                                        </div>
                                        
                                        <div class="compact-body">
                                            <span class="event-summary" x-text="getEventSummary(event)"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Empty State -->
            <div x-show="!loading && filteredEvents.length === 0" class="empty-timeline">
                <div class="empty-icon">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="empty-title">Nenhum evento encontrado</h3>
                <p class="empty-description">
                    Não há eventos para os filtros selecionados.
                </p>
                <button type="button" @click="setFilter('all')" class="btn-secondary">
                    Ver Todos os Eventos
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load More -->
    <div x-show="hasMore && !loading" class="load-more-section">
        <button type="button" @click="loadMore()" class="btn-secondary load-more-btn">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Carregar Mais Eventos
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function taskTimeline() {
    return {
        // Data
        task: {
            id: {{ task.id }},
            title: '{{ task.title|escapejs }}',
            status: '{{ task.status }}',
            priority: '{{ task.priority }}'
        },
        
        timeline: {
            totalEvents: {{ timeline_events.count }},
            totalDays: {{ task_age_days }},
            totalComments: {{ total_comments }},
            totalChanges: {{ total_changes }}
        },
        
        allEvents: {{ timeline_events_json|default:"[]"|safe }},
        filteredEvents: [],
        groupedEvents: {},
        
        // State
        loading: false,
        currentFilter: 'all',
        dateFilter: '',
        groupByDate: false,
        
        // Pagination
        currentPage: 1,
        itemsPerPage: 50,
        hasMore: false,
        
        init() {
            // Dados de exemplo - substituir pelos dados reais do Django
            this.allEvents = [
                {
                    id: 1,
                    type: 'created',
                    user: { id: 1, name: 'João Silva', avatar: null, role: 'Admin' },
                    created_at: '2024-01-10T08:00:00Z',
                    content: null
                },
                {
                    id: 2,
                    type: 'comment',
                    user: { id: 2, name: 'Maria Santos', avatar: null, role: 'Desenvolvedora' },
                    created_at: '2024-01-10T10:30:00Z',
                    content: 'Iniciando o desenvolvimento desta funcionalidade. Vou começar pela estrutura do banco de dados.',
                    attachments: []
                },
                {
                    id: 3,
                    type: 'assignment',
                    user: { id: 1, name: 'João Silva', avatar: null, role: 'Admin' },
                    created_at: '2024-01-10T14:15:00Z',
                    action: 'assigned',
                    assignee_name: 'Pedro Costa'
                },
                {
                    id: 4,
                    type: 'status_change',
                    user: { id: 3, name: 'Pedro Costa', avatar: null, role: 'Developer' },
                    created_at: '2024-01-11T09:20:00Z',
                    old_value: 'To Do',
                    new_value: 'In Progress',
                    reason: 'Iniciando desenvolvimento'
                },
                {
                    id: 5,
                    type: 'field_change',
                    user: { id: 2, name: 'Maria Santos', avatar: null, role: 'Desenvolvedora' },
                    created_at: '2024-01-12T16:45:00Z',
                    field_name: 'Priority',
                    old_value: 'Medium',
                    new_value: 'High'
                },
                {
                    id: 6,
                    type: 'comment',
                    user: { id: 3, name: 'Pedro Costa', avatar: null, role: 'Developer' },
                    created_at: '2024-01-15T11:30:00Z',
                    content: 'Funcionalidade implementada e testada. Pronta para review.',
                    attachments: [
                        { id: 1, name: 'screenshot.png', url: '#' }
                    ]
                },
                {
                    id: 7,
                    type: 'status_change',
                    user: { id: 3, name: 'Pedro Costa', avatar: null, role: 'Developer' },
                    created_at: '2024-01-15T11:35:00Z',
                    old_value: 'In Progress',
                    new_value: 'Review',
                    reason: 'Desenvolvimento concluído'
                }
            ];
            
            this.applyFilters();
        },
        
        // Filtering
        setFilter(filter) {
            this.currentFilter = filter;
            this.applyFilters();
        },
        
        applyFilters() {
            let filtered = [...this.allEvents];
            
            // Type filter
            if (this.currentFilter !== 'all') {
                const typeMap = {
                    'comments': ['comment'],
                    'changes': ['field_change'],
                    'status': ['status_change'],
                    'assignments': ['assignment']
                };
                
                if (typeMap[this.currentFilter]) {
                    filtered = filtered.filter(event => typeMap[this.currentFilter].includes(event.type));
                }
            }
            
            // Date filter
            if (this.dateFilter) {
                const now = new Date();
                const filterDate = new Date();
                
                switch (this.dateFilter) {
                    case 'today':
                        filterDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        filterDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        filterDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        filterDate.setMonth(now.getMonth() - 3);
                        break;
                }
                
                if (this.dateFilter !== '') {
                    filtered = filtered.filter(event => 
                        new Date(event.created_at) >= filterDate
                    );
                }
            }
            
            this.filteredEvents = filtered;
            
            if (this.groupByDate) {
                this.createGroupedEvents();
            }
        },
        
        toggleGroupByDate() {
            this.groupByDate = !this.groupByDate;
            if (this.groupByDate) {
                this.createGroupedEvents();
            }
        },
        
        createGroupedEvents() {
            const groups = {};
            
            this.filteredEvents.forEach(event => {
                const date = new Date(event.created_at).toISOString().split('T')[0];
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(event);
            });
            
            // Sort groups by date (newest first)
            const sortedGroups = {};
            Object.keys(groups)
                .sort((a, b) => new Date(b) - new Date(a))
                .forEach(date => {
                    sortedGroups[date] = groups[date].sort((a, b) => 
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                });
            
            this.groupedEvents = sortedGroups;
        },
        
        // Utilities
        getFilterCount(filter) {
            if (filter === 'all') return this.allEvents.length;
            
            const typeMap = {
                'comments': ['comment'],
                'changes': ['field_change'],
                'status': ['status_change'],
                'assignments': ['assignment']
            };
            
            if (typeMap[filter]) {
                return this.allEvents.filter(event => 
                    typeMap[filter].includes(event.type)
                ).length;
            }
            
            return 0;
        },
        
        getEventSummary(event) {
            switch (event.type) {
                case 'comment':
                    return 'Adicionou um comentário';
                case 'status_change':
                    return `Mudou status para ${event.new_value}`;
                case 'assignment':
                    return event.action === 'assigned' 
                        ? `Atribuiu para ${event.assignee_name}`
                        : `Removeu atribuição de ${event.assignee_name}`;
                case 'field_change':
                    return `Alterou ${event.field_name}`;
                case 'created':
                    return 'Criou a tarefa';
                case 'attachment':
                    return event.action === 'added' 
                        ? 'Adicionou anexo'
                        : 'Removeu anexo';
                default:
                    return 'Evento desconhecido';
            }
        },
        
        formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Agora há pouco';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} min atrás`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h atrás`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} dias atrás`;
            
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        },
        
        formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        formatTimeOnly(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        formatGroupDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Hoje';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Ontem';
            } else {
                return date.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
            }
        },
        
        // Actions
        loadMore() {
            this.loading = true;
            
            // Simular carregamento
            setTimeout(() => {
                this.currentPage++;
                this.loading = false;
                
                // Adicionar mais eventos se houver
                if (this.currentPage >= 3) {
                    this.hasMore = false;
                }
            }, 1000);
        },
        
        exportTimeline() {
            const data = {
                task: this.task,
                timeline: this.timeline,
                events: this.allEvents
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { 
                type: 'application/json' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timeline-tarefa-${this.task.id}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    }
}
</script>
{% endblock %}
