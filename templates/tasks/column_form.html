{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if column %}Editar Coluna{% else %}Nova Coluna{% endif %} - {{ block.super }}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/column-form.css' %}">
{% endblock %}

{% block content %}
<div class="column-form-container" x-data="columnForm()">
    <!-- Header -->
    <div class="column-form-header">
        <div class="header-content">
            <div class="header-nav">
                <nav class="breadcrumb">
                    <a href="{% url 'tasks:dashboard' %}" class="breadcrumb-link">
                        <svg class="breadcrumb-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        </svg>
                        Dashboard
                    </a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <a href="{% url 'tasks:board_list' %}" class="breadcrumb-link">Quadros</a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <a href="{% url 'tasks:board_detail' board.id %}" class="breadcrumb-link">{{ board.name }}</a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span class="breadcrumb-current">
                        {% if column %}Editar Coluna{% else %}Nova Coluna{% endif %}
                    </span>
                </nav>
                
                <div class="title-section">
                    <h1 class="page-title">
                        {% if column %}Editar Coluna{% else %}Criar Nova Coluna{% endif %}
                    </h1>
                    <p class="page-subtitle">
                        {% if column %}
                            Ajuste as configurações da coluna "{{ column.name }}"
                        {% else %}
                            Configure uma nova coluna para o quadro "{{ board.name }}"
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <div class="header-actions">
                <button type="button" @click="togglePreview()" class="btn-secondary" :class="{ 'active': showPreview }">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    <span x-text="showPreview ? 'Ocultar Preview' : 'Mostrar Preview'"></span>
                </button>
                
                <button type="submit" form="column-form" class="btn-primary" :disabled="!isValid">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {% if column %}Salvar Alterações{% else %}Criar Coluna{% endif %}
                </button>
                
                <a href="{% url 'tasks:board_detail' board.id %}" class="btn-cancel">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancelar
                </a>
            </div>
        </div>
    </div>
    
    <!-- Form Content -->
    <div class="form-content">
        <form id="column-form" method="post" class="form-layout" @submit.prevent="submitForm()">
            {% csrf_token %}
            
            <!-- Main Column -->
            <div class="main-column">
                <!-- Basic Information -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Configurações Básicas</h2>
                        <p class="card-subtitle">Defina o nome e comportamento da coluna</p>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="name" class="form-label required">Nome da Coluna</label>
                            <input 
                                type="text" 
                                id="name" 
                                name="name" 
                                class="form-input" 
                                x-model="formData.name"
                                @input="validateForm()"
                                placeholder="Ex: A Fazer, Em Progresso, Concluído..."
                                value="{% if column %}{{ column.name }}{% endif %}"
                                required
                            >
                            <p class="field-help">O nome deve ser claro e representar o estágio das tarefas</p>
                            <div class="field-errors">
                                {% for error in form.name.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description" class="form-label">Descrição</label>
                            <textarea 
                                id="description" 
                                name="description" 
                                class="form-textarea" 
                                x-model="formData.description"
                                placeholder="Descreva o propósito desta coluna e que tipo de tarefas devem ficar aqui..."
                                rows="3"
                            >{% if column %}{{ column.description }}{% endif %}</textarea>
                            <p class="field-help">Opcional: ajude sua equipe a entender quando usar esta coluna</p>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="position" class="form-label">Posição</label>
                                <select id="position" name="position" class="form-select" x-model="formData.position">
                                    <option value="0">Primeira coluna</option>
                                    <option value="1">Segunda coluna</option>
                                    <option value="2">Terceira coluna</option>
                                    <option value="3">Quarta coluna</option>
                                    <option value="4">Quinta coluna</option>
                                    <option value="-1">Última coluna</option>
                                </select>
                                <p class="field-help">Onde esta coluna deve aparecer no quadro</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="color" class="form-label">Cor da Coluna</label>
                                <div class="color-selector">
                                    <div class="selected-color" @click="showColorPicker = !showColorPicker">
                                        <div class="color-preview" :style="{ backgroundColor: formData.color }"></div>
                                        <span x-text="getColorName(formData.color)">Padrão</span>
                                        <svg class="dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </div>
                                    
                                    <div x-show="showColorPicker" x-cloak class="color-dropdown">
                                        <div class="color-grid">
                                            <template x-for="color in colors" :key="color.value">
                                                <button 
                                                    type="button"
                                                    class="color-option"
                                                    :class="{ 'selected': formData.color === color.value }"
                                                    :style="{ backgroundColor: color.value }"
                                                    @click="selectColor(color.value)"
                                                    :title="color.name"
                                                ></button>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="color" x-model="formData.color">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Configuration -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Configurações de Fluxo</h2>
                        <p class="card-subtitle">Configure como as tarefas se comportam nesta coluna</p>
                    </div>
                    <div class="card-content">
                        <div class="workflow-section">
                            <div class="workflow-option">
                                <div class="option-header">
                                    <label class="option-label">
                                        <input 
                                            type="checkbox" 
                                            x-model="formData.hasLimit"
                                            class="option-checkbox"
                                        >
                                        <span class="option-title">Limite de Trabalho em Progresso (WIP)</span>
                                    </label>
                                    <p class="option-description">
                                        Defina quantas tarefas podem existir nesta coluna simultaneamente
                                    </p>
                                </div>
                                
                                <div x-show="formData.hasLimit" x-cloak class="option-content">
                                    <div class="limit-configuration">
                                        <div class="limit-input-group">
                                            <label for="task_limit" class="limit-label">Número máximo de tarefas</label>
                                            <input 
                                                type="number" 
                                                id="task_limit"
                                                name="task_limit"
                                                x-model="formData.taskLimit"
                                                min="1"
                                                max="50"
                                                class="limit-input"
                                                placeholder="Ex: 5"
                                            >
                                        </div>
                                        
                                        <div class="limit-behavior">
                                            <label class="behavior-label">Quando o limite for atingido:</label>
                                            <div class="behavior-options">
                                                <label class="behavior-option">
                                                    <input type="radio" name="limit_behavior" value="block" x-model="formData.limitBehavior">
                                                    <span>Bloquear novas tarefas</span>
                                                </label>
                                                <label class="behavior-option">
                                                    <input type="radio" name="limit_behavior" value="warn" x-model="formData.limitBehavior">
                                                    <span>Apenas alertar</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="workflow-option">
                                <div class="option-header">
                                    <label class="option-label">
                                        <input 
                                            type="checkbox" 
                                            x-model="formData.autoAssign"
                                            class="option-checkbox"
                                        >
                                        <span class="option-title">Atribuição Automática</span>
                                    </label>
                                    <p class="option-description">
                                        Atribua automaticamente tarefas quando chegarem nesta coluna
                                    </p>
                                </div>
                                
                                <div x-show="formData.autoAssign" x-cloak class="option-content">
                                    <div class="assignee-selector">
                                        <label for="default_assignee" class="assignee-label">Atribuir para:</label>
                                        <select id="default_assignee" name="default_assignee" class="form-select" x-model="formData.defaultAssignee">
                                            <option value="">Nenhum usuário específico</option>
                                            <option value="creator">Criador da tarefa</option>
                                            <option value="random">Membro aleatório da equipe</option>
                                            <option value="least_busy">Membro menos ocupado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="workflow-option">
                                <div class="option-header">
                                    <label class="option-label">
                                        <input 
                                            type="checkbox" 
                                            x-model="formData.isDone"
                                            class="option-checkbox"
                                        >
                                        <span class="option-title">Coluna de Conclusão</span>
                                    </label>
                                    <p class="option-description">
                                        Marcar tarefas como concluídas quando chegarem nesta coluna
                                    </p>
                                </div>
                            </div>
                            
                            <div class="workflow-option">
                                <div class="option-header">
                                    <label class="option-label">
                                        <input 
                                            type="checkbox" 
                                            x-model="formData.allowTimeTracker"
                                            class="option-checkbox"
                                        >
                                        <span class="option-title">Rastreamento de Tempo</span>
                                    </label>
                                    <p class="option-description">
                                        Permitir que usuários registrem tempo gasto nas tarefas desta coluna
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Automation Rules -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Regras de Automação</h2>
                        <p class="card-subtitle">Configure ações automáticas para tarefas nesta coluna</p>
                    </div>
                    <div class="card-content">
                        <div class="automation-section">
                            <div class="automation-rules">
                                <template x-for="(rule, index) in formData.automationRules" :key="rule.id">
                                    <div class="automation-rule">
                                        <div class="rule-header">
                                            <div class="rule-icon">
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                </svg>
                                            </div>
                                            <div class="rule-info">
                                                <h4 class="rule-title">Regra de Automação #<span x-text="index + 1"></span></h4>
                                                <p class="rule-description">Quando uma tarefa <strong>entra</strong> nesta coluna</p>
                                            </div>
                                            <button type="button" @click="removeRule(index)" class="remove-rule">
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <div class="rule-configuration">
                                            <div class="rule-trigger">
                                                <label class="config-label">Gatilho:</label>
                                                <select x-model="rule.trigger" class="form-select">
                                                    <option value="task_enters">Tarefa entra na coluna</option>
                                                    <option value="task_stays">Tarefa fica X dias na coluna</option>
                                                    <option value="task_assigned">Tarefa é atribuída</option>
                                                </select>
                                            </div>
                                            
                                            <div class="rule-action">
                                                <label class="config-label">Ação:</label>
                                                <select x-model="rule.action" class="form-select">
                                                    <option value="add_label">Adicionar etiqueta</option>
                                                    <option value="set_priority">Definir prioridade</option>
                                                    <option value="assign_user">Atribuir usuário</option>
                                                    <option value="send_notification">Enviar notificação</option>
                                                    <option value="set_due_date">Definir data limite</option>
                                                </select>
                                            </div>
                                            
                                            <div class="rule-value">
                                                <label class="config-label">Valor:</label>
                                                <input type="text" x-model="rule.value" class="form-input" placeholder="Ex: etiqueta, usuário, dias...">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                
                                <button type="button" @click="addRule()" class="add-rule-btn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Adicionar Regra de Automação
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if column %}
                <!-- Danger Zone -->
                <div class="form-card danger-zone">
                    <div class="card-header">
                        <h2 class="card-title danger-title">Zona de Perigo</h2>
                        <p class="card-subtitle">Ações que afetam permanentemente a coluna</p>
                    </div>
                    <div class="card-content">
                        <div class="danger-actions">
                            <div class="danger-item">
                                <div class="danger-info">
                                    <h3 class="danger-action-title">Mover Tarefas</h3>
                                    <p class="danger-action-description">
                                        Mover todas as tarefas desta coluna para outra coluna antes de fazer alterações.
                                    </p>
                                </div>
                                <button type="button" @click="showMoveTasksModal = true" class="btn-warning">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                    </svg>
                                    Mover Tarefas
                                </button>
                            </div>
                            
                            <div class="danger-item">
                                <div class="danger-info">
                                    <h3 class="danger-action-title">Excluir Coluna</h3>
                                    <p class="danger-action-description">
                                        Esta ação é <strong>irreversível</strong>. A coluna e suas configurações serão permanentemente excluídas.
                                    </p>
                                </div>
                                <button type="button" @click="showDeleteModal = true" class="btn-danger">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Sidebar Column -->
            <div class="sidebar-column">
                <!-- Preview -->
                <div x-show="showPreview" x-cloak class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Preview da Coluna</h2>
                        <p class="card-subtitle">Como esta coluna aparecerá no quadro</p>
                    </div>
                    <div class="card-content">
                        <div class="column-preview">
                            <div class="preview-column" :style="{ backgroundColor: formData.color + '10' }">
                                <div class="preview-header" :style="{ borderTopColor: formData.color }">
                                    <div class="preview-title-row">
                                        <h3 class="preview-title" x-text="formData.name || 'Nome da Coluna'"></h3>
                                        <span x-show="formData.hasLimit" class="preview-limit" x-text="'0/' + formData.taskLimit"></span>
                                    </div>
                                    <p x-show="formData.description" class="preview-description" x-text="formData.description"></p>
                                </div>
                                
                                <div class="preview-tasks">
                                    <div class="preview-task">
                                        <div class="task-content">
                                            <h4 class="task-title">Exemplo de Tarefa</h4>
                                            <p class="task-description">Esta é uma tarefa de exemplo para demonstrar como ficará.</p>
                                        </div>
                                        <div class="task-meta">
                                            <span class="task-assignee">JD</span>
                                            <span class="task-priority priority-medium"></span>
                                        </div>
                                    </div>
                                    
                                    <div x-show="formData.hasLimit && formData.taskLimit <= 2" class="preview-limit-reached">
                                        <span>Limite atingido</span>
                                    </div>
                                    
                                    <div x-show="!formData.hasLimit || formData.taskLimit > 2" class="add-task-placeholder">
                                        <span>+ Adicionar tarefa</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Column Statistics -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Estatísticas</h2>
                        <p class="card-subtitle">Informações sobre esta coluna</p>
                    </div>
                    <div class="card-content">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value">{% if column %}{{ column.tasks.count }}{% else %}0{% endif %}</span>
                                    <span class="stat-label">Tarefas Atuais</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value">{% if column %}{{ column.avg_time_in_column|default:"--" }}{% else %}--{% endif %}</span>
                                    <span class="stat-label">Tempo Médio</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                    </svg>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-value">{% if column %}{{ column.tasks_completed_this_week|default:"0" }}{% else %}0{% endif %}</span>
                                    <span class="stat-label">Esta Semana</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Ações Rápidas</h2>
                    </div>
                    <div class="card-content">
                        <div class="quick-actions">
                            <button type="button" @click="duplicateColumn()" class="quick-action-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                Duplicar Coluna
                            </button>
                            
                            <button type="button" @click="createTemplate()" class="quick-action-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                                </svg>
                                Salvar como Template
                            </button>
                            
                            <button type="button" @click="exportRules()" class="quick-action-btn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Exportar Regras
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Help -->
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="card-title">Ajuda</h2>
                    </div>
                    <div class="card-content">
                        <div class="help-content">
                            <div class="help-item">
                                <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <div class="help-text">
                                    <strong>WIP Limits:</strong> Limites de trabalho em progresso ajudam a manter o foco e identificar gargalos.
                                </div>
                            </div>
                            
                            <div class="help-item">
                                <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <div class="help-text">
                                    <strong>Automação:</strong> Regras automáticas economizam tempo e garantem consistência no fluxo.
                                </div>
                            </div>
                            
                            <div class="help-item">
                                <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM7 21a4 4 0 004-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4"/>
                                </svg>
                                <div class="help-text">
                                    <strong>Posição:</strong> A ordem das colunas deve seguir seu fluxo de trabalho natural.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Move Tasks Modal -->
    <div x-show="showMoveTasksModal" x-cloak class="modal-overlay" @click.self="showMoveTasksModal = false">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Mover Tarefas</h3>
                <button type="button" @click="showMoveTasksModal = false" class="modal-close">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>Mover todas as <strong>{{ column.tasks.count }}</strong> tarefas desta coluna para:</p>
                <select x-model="targetColumn" class="form-select">
                    <option value="">Selecione uma coluna</option>
                    {% for col in board.columns.all %}
                        {% if col.id != column.id %}
                            <option value="{{ col.id }}">{{ col.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" @click="showMoveTasksModal = false" class="btn-cancel">Cancelar</button>
                <button type="button" @click="moveTasks()" class="btn-primary" :disabled="!targetColumn">
                    Mover Tarefas
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" x-cloak class="modal-overlay" @click.self="showDeleteModal = false">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Exclusão</h3>
                <button type="button" @click="showDeleteModal = false" class="modal-close">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <div class="warning-icon">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <div class="warning-content">
                        <h4>Excluir coluna "{{ column.name }}"?</h4>
                        <p>Esta ação não pode ser desfeita. Você perderá:</p>
                        <ul>
                            <li>Todas as configurações da coluna</li>
                            <li>Regras de automação</li>
                            <li>Histórico de atividades</li>
                        </ul>
                        <p><strong>As tarefas não serão excluídas</strong>, mas precisarão ser movidas para outra coluna.</p>
                        <p>Digite <strong>EXCLUIR</strong> para confirmar:</p>
                        <input 
                            type="text" 
                            x-model="deleteConfirmation" 
                            class="delete-confirmation-input"
                            placeholder="Digite EXCLUIR"
                        >
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" @click="showDeleteModal = false" class="btn-cancel">Cancelar</button>
                <button 
                    type="button" 
                    @click="deleteColumn()" 
                    class="btn-danger"
                    :disabled="deleteConfirmation !== 'EXCLUIR'"
                >
                    Excluir Permanentemente
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function columnForm() {
    return {
        showPreview: true,
        showColorPicker: false,
        showMoveTasksModal: false,
        showDeleteModal: false,
        deleteConfirmation: '',
        targetColumn: '',
        isValid: false,
        
        formData: {
            name: '{% if column %}{{ column.name|default:"" }}{% endif %}',
            description: '{% if column %}{{ column.description|default:"" }}{% endif %}',
            position: {% if column %}{{ column.position|default:"0" }}{% else %}0{% endif %},
            color: '{% if column %}{{ column.color|default:"#e5e7eb" }}{% else %}#e5e7eb{% endif %}',
            hasLimit: {% if column %}{{ column.task_limit|yesno:"true,false" }}{% else %}false{% endif %},
            taskLimit: {% if column %}{{ column.task_limit|default:"5" }}{% else %}5{% endif %},
            limitBehavior: '{% if column %}{{ column.limit_behavior|default:"warn" }}{% else %}warn{% endif %}',
            autoAssign: {% if column %}{{ column.auto_assign|yesno:"true,false" }}{% else %}false{% endif %},
            defaultAssignee: '{% if column %}{{ column.default_assignee|default:"" }}{% endif %}',
            isDone: {% if column %}{{ column.is_done|yesno:"true,false" }}{% else %}false{% endif %},
            allowTimeTracker: {% if column %}{{ column.allow_time_tracker|yesno:"true,false" }}{% else %}true{% endif %},
            automationRules: []
        },
        
        colors: [
            { name: 'Padrão', value: '#e5e7eb' },
            { name: 'Azul', value: '#3b82f6' },
            { name: 'Verde', value: '#10b981' },
            { name: 'Roxo', value: '#8b5cf6' },
            { name: 'Rosa', value: '#ec4899' },
            { name: 'Laranja', value: '#f59e0b' },
            { name: 'Vermelho', value: '#ef4444' },
            { name: 'Indigo', value: '#6366f1' },
            { name: 'Teal', value: '#14b8a6' },
            { name: 'Cinza', value: '#6b7280' }
        ],
        
        init() {
            this.validateForm();
            this.loadAutomationRules();
        },
        
        validateForm() {
            this.isValid = this.formData.name.trim().length > 0;
        },
        
        selectColor(colorValue) {
            this.formData.color = colorValue;
            this.showColorPicker = false;
        },
        
        getColorName(colorValue) {
            const color = this.colors.find(c => c.value === colorValue);
            return color ? color.name : 'Personalizada';
        },
        
        togglePreview() {
            this.showPreview = !this.showPreview;
        },
        
        loadAutomationRules() {
            // Carregar regras existentes ou criar exemplo
            {% if column and column.automation_rules %}
                this.formData.automationRules = {{ column.automation_rules|safe }};
            {% else %}
                this.formData.automationRules = [];
            {% endif %}
        },
        
        addRule() {
            this.formData.automationRules.push({
                id: Date.now(),
                trigger: 'task_enters',
                action: 'add_label',
                value: ''
            });
        },
        
        removeRule(index) {
            this.formData.automationRules.splice(index, 1);
        },
        
        submitForm() {
            if (!this.isValid) return;
            
            const formElement = document.getElementById('column-form');
            const formData = new FormData(formElement);
            
            // Adicionar dados JSON
            formData.append('automation_rules', JSON.stringify(this.formData.automationRules));
            
            // Campos booleanos
            formData.append('has_limit', this.formData.hasLimit);
            formData.append('auto_assign', this.formData.autoAssign);
            formData.append('is_done', this.formData.isDone);
            formData.append('allow_time_tracker', this.formData.allowTimeTracker);
            
            // Enviar formulário
            formElement.submit();
        },
        
        duplicateColumn() {
            console.log('Duplicar coluna');
        },
        
        createTemplate() {
            console.log('Criar template');
        },
        
        exportRules() {
            const rules = JSON.stringify(this.formData.automationRules, null, 2);
            const blob = new Blob([rules], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'automation-rules.json';
            a.click();
            URL.revokeObjectURL(url);
        },
        
        moveTasks() {
            if (!this.targetColumn) return;
            
            // Implementar movimentação de tarefas
            console.log('Mover tarefas para coluna:', this.targetColumn);
            this.showMoveTasksModal = false;
        },
        
        deleteColumn() {
            if (this.deleteConfirmation === 'EXCLUIR') {
                window.location.href = '{% if column %}{% url "tasks:column_delete" column.id %}{% endif %}';
            }
        }
    }
}
</script>
{% endblock %}
