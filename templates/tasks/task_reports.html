{% extends 'base.html' %}
{% load static %}

{% block title %}Relatórios - Tarefas - {{ block.super }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/task-reports.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
{% endblock %}

{% block content %}
<div class="reports-container" x-data="taskReports()">
    <!-- Header -->
    <div class="reports-header">
        <div class="header-content">
            <div class="header-nav">
                <nav class="breadcrumb">
                    <a href="{% url 'tasks:dashboard' %}" class="breadcrumb-link">
                        <svg class="breadcrumb-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                        </svg>
                        Dashboard
                    </a>
                    <svg class="breadcrumb-separator" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span class="breadcrumb-current">Relatórios</span>
                </nav>
                
                <div class="title-section">
                    <h1 class="page-title">Relatórios de Tarefas</h1>
                    <p class="page-subtitle">
                        Relatórios personalizados e análises avançadas para gestão de projetos
                    </p>
                </div>
            </div>
            
            <div class="header-actions">
                <button type="button" @click="createCustomReport()" class="btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Criar Relatório
                </button>
                
                <button type="button" @click="showScheduledReports()" class="btn-secondary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Agendados
                </button>
                
                <button type="button" @click="exportAllReports()" class="btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exportar Tudo
                </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Filters -->
    <div class="filters-section">
        <div class="filters-content">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Período</label>
                    <select x-model="filters.period" @change="applyFilters()" class="filter-select">
                        <option value="7d">Últimos 7 dias</option>
                        <option value="30d">Últimos 30 dias</option>
                        <option value="90d">Últimos 90 dias</option>
                        <option value="1y">Último ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                
                <div class="filter-group" x-show="filters.period === 'custom'" x-cloak>
                    <label class="filter-label">Data Inicial</label>
                    <input type="date" x-model="filters.startDate" @change="applyFilters()" class="filter-input">
                </div>
                
                <div class="filter-group" x-show="filters.period === 'custom'" x-cloak>
                    <label class="filter-label">Data Final</label>
                    <input type="date" x-model="filters.endDate" @change="applyFilters()" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Quadro</label>
                    <select x-model="filters.board" @change="applyFilters()" class="filter-select">
                        <option value="">Todos os quadros</option>
                        <template x-for="board in boards" :key="board.id">
                            <option :value="board.id" x-text="board.name"></option>
                        </template>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Responsável</label>
                    <select x-model="filters.assignee" @change="applyFilters()" class="filter-select">
                        <option value="">Todos os usuários</option>
                        <template x-for="user in users" :key="user.id">
                            <option :value="user.id" x-text="user.name"></option>
                        </template>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Prioridade</label>
                    <select x-model="filters.priority" @change="applyFilters()" class="filter-select">
                        <option value="">Todas as prioridades</option>
                        <option value="alta">Alta</option>
                        <option value="media">Média</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>
                
                <div class="filter-actions">
                    <button type="button" @click="resetFilters()" class="filter-reset">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Templates -->
    <div class="templates-section">
        <div class="templates-content">
            <div class="section-header">
                <h2 class="section-title">Modelos de Relatório</h2>
                <p class="section-subtitle">Escolha um modelo pré-configurado ou crie um relatório personalizado</p>
            </div>
            
            <div class="templates-grid">
                <template x-for="template in reportTemplates" :key="template.id">
                    <div class="template-card" @click="generateReport(template)">
                        <div class="template-icon" :class="'icon-' + template.type">
                            <svg x-show="template.type === 'productivity'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <svg x-show="template.type === 'timesheet'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <svg x-show="template.type === 'performance'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <svg x-show="template.type === 'status'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <svg x-show="template.type === 'workload'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <svg x-show="template.type === 'budget'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                            <svg x-show="template.type === 'quality'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            <svg x-show="template.type === 'forecast'" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                        </div>
                        
                        <div class="template-content">
                            <h3 class="template-title" x-text="template.name"></h3>
                            <p class="template-description" x-text="template.description"></p>
                            
                            <div class="template-metrics">
                                <div class="metric-item">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span x-text="template.estimatedTime"></span>
                                </div>
                                <div class="metric-item">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span x-text="template.dataPoints + ' pontos de dados'"></span>
                                </div>
                            </div>
                            
                            <div class="template-tags">
                                <template x-for="tag in template.tags" :key="tag">
                                    <span class="template-tag" x-text="tag"></span>
                                </template>
                            </div>
                        </div>
                        
                        <div class="template-actions">
                            <button type="button" @click.stop="previewReport(template)" class="template-preview">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Visualizar
                            </button>
                            <button type="button" @click.stop="generateReport(template)" class="template-generate">
                                Gerar Relatório
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Generated Reports -->
    <div class="generated-reports-section" x-show="generatedReports.length > 0">
        <div class="generated-content">
            <div class="section-header">
                <h2 class="section-title">Relatórios Gerados</h2>
                <p class="section-subtitle">Histórico de relatórios criados recentemente</p>
            </div>
            
            <div class="reports-list">
                <template x-for="report in generatedReports" :key="report.id">
                    <div class="report-item" :class="{ 'processing': report.status === 'processing' }">
                        <div class="report-icon">
                            <svg x-show="report.status === 'completed'" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <svg x-show="report.status === 'processing'" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="animate-spin">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <svg x-show="report.status === 'error'" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        
                        <div class="report-content">
                            <div class="report-header">
                                <h4 class="report-title" x-text="report.name"></h4>
                                <div class="report-meta">
                                    <span class="report-type" x-text="report.type"></span>
                                    <span class="report-date" x-text="formatDate(report.createdAt)"></span>
                                </div>
                            </div>
                            
                            <div class="report-details">
                                <div class="detail-item">
                                    <span class="detail-label">Período:</span>
                                    <span class="detail-value" x-text="report.period"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Dados:</span>
                                    <span class="detail-value" x-text="report.recordCount + ' registros'"></span>
                                </div>
                                <div class="detail-item" x-show="report.status === 'completed'">
                                    <span class="detail-label">Tamanho:</span>
                                    <span class="detail-value" x-text="formatFileSize(report.fileSize)"></span>
                                </div>
                            </div>
                            
                            <div x-show="report.status === 'processing'" class="progress-bar">
                                <div class="progress-fill" :style="{ width: report.progress + '%' }"></div>
                                <span class="progress-text" x-text="report.progress + '% processado'"></span>
                            </div>
                        </div>
                        
                        <div class="report-actions">
                            <button 
                                x-show="report.status === 'completed'" 
                                @click="viewReport(report)" 
                                class="action-btn view-btn"
                                title="Visualizar Relatório"
                            >
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                            
                            <div x-show="report.status === 'completed'" class="export-dropdown" x-data="{ open: false }">
                                <button @click="open = !open" class="action-btn export-btn" title="Exportar">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </button>
                                
                                <div x-show="open" @click.away="open = false" x-cloak class="export-menu">
                                    <button @click="exportReport(report, 'pdf'); open = false" class="export-option">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/>
                                        </svg>
                                        PDF
                                    </button>
                                    <button @click="exportReport(report, 'excel'); open = false" class="export-option">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/>
                                        </svg>
                                        Excel
                                    </button>
                                    <button @click="exportReport(report, 'csv'); open = false" class="export-option">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/>
                                        </svg>
                                        CSV
                                    </button>
                                    <button @click="exportReport(report, 'json'); open = false" class="export-option">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3"/>
                                        </svg>
                                        JSON
                                    </button>
                                </div>
                            </div>
                            
                            <button @click="shareReport(report)" class="action-btn share-btn" title="Compartilhar">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
                                </svg>
                            </button>
                            
                            <button @click="deleteReport(report)" class="action-btn delete-btn" title="Excluir">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Report Preview Modal -->
    <div x-show="showPreviewModal" x-cloak class="modal-overlay" @click="closePreview()">
        <div class="modal-content report-preview" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Visualização do Relatório</h3>
                <button @click="closePreview()" class="modal-close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div x-show="previewLoading" class="preview-loading">
                    <div class="loading-spinner"></div>
                    <p>Gerando visualização...</p>
                </div>
                
                <div x-show="!previewLoading && previewData" class="preview-content">
                    <div class="preview-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total de Registros:</span>
                            <span class="stat-value" x-text="previewData.totalRecords"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Período:</span>
                            <span class="stat-value" x-text="previewData.period"></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Última Atualização:</span>
                            <span class="stat-value" x-text="previewData.lastUpdate"></span>
                        </div>
                    </div>
                    
                    <div class="preview-chart">
                        <canvas id="previewChart" class="preview-canvas"></canvas>
                    </div>
                    
                    <div class="preview-table">
                        <div class="table-header">
                            <template x-for="column in previewData.columns" :key="column">
                                <div class="table-header-cell" x-text="column"></div>
                            </template>
                        </div>
                        <div class="table-body">
                            <template x-for="row in previewData.sampleRows" :key="row.id">
                                <div class="table-row">
                                    <template x-for="(value, index) in row.values" :key="index">
                                        <div class="table-cell" x-text="value"></div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button @click="closePreview()" class="btn-secondary">Cancelar</button>
                <button @click="generateFromPreview()" class="btn-primary">Gerar Relatório Completo</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Report Builder Modal -->
    <div x-show="showCustomReportModal" x-cloak class="modal-overlay" @click="closeCustomReport()">
        <div class="modal-content custom-report-builder" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Criar Relatório Personalizado</h3>
                <button @click="closeCustomReport()" class="modal-close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="builder-steps">
                    <div class="step-indicator">
                        <div class="step" :class="{ 'active': customReportStep === 1, 'completed': customReportStep > 1 }">
                            <span class="step-number">1</span>
                            <span class="step-label">Configuração</span>
                        </div>
                        <div class="step" :class="{ 'active': customReportStep === 2, 'completed': customReportStep > 2 }">
                            <span class="step-number">2</span>
                            <span class="step-label">Campos</span>
                        </div>
                        <div class="step" :class="{ 'active': customReportStep === 3, 'completed': customReportStep > 3 }">
                            <span class="step-number">3</span>
                            <span class="step-label">Visualização</span>
                        </div>
                        <div class="step" :class="{ 'active': customReportStep === 4 }">
                            <span class="step-number">4</span>
                            <span class="step-label">Finalizar</span>
                        </div>
                    </div>
                    
                    <!-- Step 1: Configuration -->
                    <div x-show="customReportStep === 1" class="step-content">
                        <h4>Configuração Básica</h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nome do Relatório</label>
                                <input type="text" x-model="customReport.name" class="form-input" placeholder="Ex: Relatório de Produtividade Semanal">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Descrição</label>
                                <textarea x-model="customReport.description" class="form-input" rows="3" placeholder="Descreva o objetivo deste relatório"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Relatório</label>
                                <select x-model="customReport.type" class="form-input">
                                    <option value="summary">Resumo</option>
                                    <option value="detailed">Detalhado</option>
                                    <option value="comparison">Comparativo</option>
                                    <option value="trend">Tendência</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Formato de Saída</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" x-model="customReport.formats" value="pdf">
                                        <span class="checkbox-label">PDF</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" x-model="customReport.formats" value="excel">
                                        <span class="checkbox-label">Excel</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" x-model="customReport.formats" value="csv">
                                        <span class="checkbox-label">CSV</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Fields -->
                    <div x-show="customReportStep === 2" class="step-content">
                        <h4>Seleção de Campos</h4>
                        
                        <div class="fields-selection">
                            <div class="available-fields">
                                <h5>Campos Disponíveis</h5>
                                <div class="fields-list">
                                    <template x-for="field in availableFields" :key="field.id">
                                        <div class="field-item" :class="{ 'selected': isFieldSelected(field) }" @click="toggleField(field)">
                                            <div class="field-icon" :class="'field-type-' + field.type">
                                                <svg x-show="field.type === 'text'" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                                </svg>
                                                <svg x-show="field.type === 'number'" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                                </svg>
                                                <svg x-show="field.type === 'date'" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4h6M5 21h14a2 2 0 002-2V10a2 2 0 00-2-2H5a2 2 0 00-2 2v9a2 2 0 002 2z"/>
                                                </svg>
                                            </div>
                                            <div class="field-info">
                                                <span class="field-name" x-text="field.name"></span>
                                                <span class="field-description" x-text="field.description"></span>
                                            </div>
                                            <div class="field-toggle">
                                                <svg x-show="isFieldSelected(field)" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <div class="selected-fields">
                                <h5>Campos Selecionados</h5>
                                <div class="selected-list" x-show="customReport.selectedFields.length > 0">
                                    <template x-for="(field, index) in customReport.selectedFields" :key="field.id">
                                        <div class="selected-field-item" draggable="true">
                                            <div class="drag-handle">
                                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                                </svg>
                                            </div>
                                            <span class="field-name" x-text="field.name"></span>
                                            <button @click="removeField(field)" class="remove-field">
                                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="customReport.selectedFields.length === 0" class="empty-selection">
                                    <p>Nenhum campo selecionado</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Visualization -->
                    <div x-show="customReportStep === 3" class="step-content">
                        <h4>Configuração de Visualização</h4>
                        
                        <div class="visualization-options">
                            <div class="form-group">
                                <label class="form-label">Agrupamento</label>
                                <select x-model="customReport.groupBy" class="form-input">
                                    <option value="">Sem agrupamento</option>
                                    <option value="date">Por Data</option>
                                    <option value="user">Por Usuário</option>
                                    <option value="board">Por Quadro</option>
                                    <option value="priority">Por Prioridade</option>
                                    <option value="status">Por Status</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ordenação</label>
                                <select x-model="customReport.orderBy" class="form-input">
                                    <option value="created_at">Data de Criação</option>
                                    <option value="updated_at">Última Atualização</option>
                                    <option value="priority">Prioridade</option>
                                    <option value="title">Título</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Direção</label>
                                <select x-model="customReport.orderDirection" class="form-input">
                                    <option value="asc">Crescente</option>
                                    <option value="desc">Decrescente</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" x-model="customReport.includeCharts">
                                    <span class="checkbox-label">Incluir Gráficos</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" x-model="customReport.includeSummary">
                                    <span class="checkbox-label">Incluir Resumo Executivo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Finalize -->
                    <div x-show="customReportStep === 4" class="step-content">
                        <h4>Finalizar Relatório</h4>
                        
                        <div class="report-summary">
                            <div class="summary-item">
                                <strong>Nome:</strong>
                                <span x-text="customReport.name"></span>
                            </div>
                            <div class="summary-item">
                                <strong>Tipo:</strong>
                                <span x-text="customReport.type"></span>
                            </div>
                            <div class="summary-item">
                                <strong>Campos:</strong>
                                <span x-text="customReport.selectedFields.length + ' campos selecionados'"></span>
                            </div>
                            <div class="summary-item">
                                <strong>Formatos:</strong>
                                <span x-text="customReport.formats.join(', ')"></span>
                            </div>
                        </div>
                        
                        <div class="schedule-options">
                            <label class="checkbox-item">
                                <input type="checkbox" x-model="customReport.schedule">
                                <span class="checkbox-label">Agendar execução automática</span>
                            </label>
                            
                            <div x-show="customReport.schedule" class="schedule-config">
                                <div class="form-group">
                                    <label class="form-label">Frequência</label>
                                    <select x-model="customReport.frequency" class="form-input">
                                        <option value="daily">Diariamente</option>
                                        <option value="weekly">Semanalmente</option>
                                        <option value="monthly">Mensalmente</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Enviar por email para</label>
                                    <input type="email" x-model="customReport.emailRecipients" class="form-input" placeholder="email@exemplo.com">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button x-show="customReportStep > 1" @click="customReportStep--" class="btn-secondary">Anterior</button>
                <button @click="closeCustomReport()" class="btn-secondary">Cancelar</button>
                <button x-show="customReportStep < 4" @click="customReportStep++" class="btn-primary" :disabled="!canProceedStep()">Próximo</button>
                <button x-show="customReportStep === 4" @click="createCustomReport()" class="btn-primary">Criar Relatório</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function taskReports() {
    return {
        // Filters
        filters: {
            period: '30d',
            startDate: '',
            endDate: '',
            board: '',
            assignee: '',
            priority: ''
        },
        
        // Data
        boards: [
            { id: 1, name: 'Desenvolvimento' },
            { id: 2, name: 'Design' },
            { id: 3, name: 'Marketing' }
        ],
        
        users: [
            { id: 1, name: 'João Silva' },
            { id: 2, name: 'Maria Santos' },
            { id: 3, name: 'Pedro Costa' }
        ],
        
        reportTemplates: [
            {
                id: 1,
                name: 'Relatório de Produtividade',
                description: 'Análise detalhada da produtividade individual e da equipe',
                type: 'productivity',
                estimatedTime: '2-3 min',
                dataPoints: 150,
                tags: ['Produtividade', 'KPIs', 'Equipe']
            },
            {
                id: 2,
                name: 'Timesheet Detalhado',
                description: 'Controle de horas trabalhadas por usuário e projeto',
                type: 'timesheet',
                estimatedTime: '1-2 min',
                dataPoints: 89,
                tags: ['Tempo', 'Horas', 'Usuários']
            },
            {
                id: 3,
                name: 'Análise de Performance',
                description: 'Métricas de performance por quadro e tipo de tarefa',
                type: 'performance',
                estimatedTime: '3-4 min',
                dataPoints: 234,
                tags: ['Performance', 'Métricas', 'Quadros']
            },
            {
                id: 4,
                name: 'Status das Tarefas',
                description: 'Distribuição e evolução dos status das tarefas',
                type: 'status',
                estimatedTime: '1-2 min',
                dataPoints: 76,
                tags: ['Status', 'Distribuição', 'Evolução']
            },
            {
                id: 5,
                name: 'Carga de Trabalho',
                description: 'Análise da distribuição de tarefas por membro da equipe',
                type: 'workload',
                estimatedTime: '2-3 min',
                dataPoints: 112,
                tags: ['Carga', 'Distribuição', 'Equipe']
            },
            {
                id: 6,
                name: 'Controle Orçamentário',
                description: 'Relatório de custos e orçamento por projeto',
                type: 'budget',
                estimatedTime: '4-5 min',
                dataPoints: 198,
                tags: ['Orçamento', 'Custos', 'Projetos']
            },
            {
                id: 7,
                name: 'Qualidade e Revisões',
                description: 'Métricas de qualidade e processos de revisão',
                type: 'quality',
                estimatedTime: '3-4 min',
                dataPoints: 167,
                tags: ['Qualidade', 'Revisões', 'Processos']
            },
            {
                id: 8,
                name: 'Previsões e Tendências',
                description: 'Projeções baseadas em dados históricos',
                type: 'forecast',
                estimatedTime: '5-6 min',
                dataPoints: 289,
                tags: ['Previsões', 'Tendências', 'Histórico']
            }
        ],
        
        generatedReports: [
            {
                id: 1,
                name: 'Relatório de Produtividade - Janeiro',
                type: 'Produtividade',
                status: 'completed',
                createdAt: new Date('2025-01-20'),
                period: '01-31 Jan 2025',
                recordCount: 234,
                fileSize: 2456789,
                progress: 100
            },
            {
                id: 2,
                name: 'Timesheet Semanal',
                type: 'Timesheet',
                status: 'processing',
                createdAt: new Date('2025-01-24'),
                period: '17-24 Jan 2025',
                recordCount: 89,
                fileSize: null,
                progress: 67
            },
            {
                id: 3,
                name: 'Performance Q4 2024',
                type: 'Performance',
                status: 'completed',
                createdAt: new Date('2025-01-15'),
                period: 'Q4 2024',
                recordCount: 456,
                fileSize: 5432167,
                progress: 100
            }
        ],
        
        // Modal states
        showPreviewModal: false,
        showCustomReportModal: false,
        previewLoading: false,
        previewData: null,
        
        // Custom report builder
        customReportStep: 1,
        customReport: {
            name: '',
            description: '',
            type: 'summary',
            formats: ['pdf'],
            selectedFields: [],
            groupBy: '',
            orderBy: 'created_at',
            orderDirection: 'desc',
            includeCharts: true,
            includeSummary: true,
            schedule: false,
            frequency: 'weekly',
            emailRecipients: ''
        },
        
        availableFields: [
            {
                id: 1,
                name: 'Título da Tarefa',
                description: 'Nome/título da tarefa',
                type: 'text',
                key: 'title'
            },
            {
                id: 2,
                name: 'Responsável',
                description: 'Usuário responsável pela tarefa',
                type: 'text',
                key: 'assignee'
            },
            {
                id: 3,
                name: 'Status',
                description: 'Status atual da tarefa',
                type: 'text',
                key: 'status'
            },
            {
                id: 4,
                name: 'Prioridade',
                description: 'Nível de prioridade',
                type: 'text',
                key: 'priority'
            },
            {
                id: 5,
                name: 'Data de Criação',
                description: 'Quando a tarefa foi criada',
                type: 'date',
                key: 'created_at'
            },
            {
                id: 6,
                name: 'Data de Conclusão',
                description: 'Quando a tarefa foi concluída',
                type: 'date',
                key: 'completed_at'
            },
            {
                id: 7,
                name: 'Tempo Gasto',
                description: 'Tempo total gasto na tarefa',
                type: 'number',
                key: 'time_spent'
            },
            {
                id: 8,
                name: 'Quadro',
                description: 'Quadro onde a tarefa está localizada',
                type: 'text',
                key: 'board'
            }
        ],
        
        init() {
            this.loadInitialData();
        },
        
        // Filters
        applyFilters() {
            console.log('Applying filters:', this.filters);
            // Simulate filter application
        },
        
        resetFilters() {
            this.filters = {
                period: '30d',
                startDate: '',
                endDate: '',
                board: '',
                assignee: '',
                priority: ''
            };
            this.applyFilters();
        },
        
        // Report generation
        generateReport(template) {
            const newReport = {
                id: Date.now(),
                name: template.name + ' - ' + this.formatDate(new Date()),
                type: template.name,
                status: 'processing',
                createdAt: new Date(),
                period: this.getPeriodLabel(),
                recordCount: template.dataPoints,
                fileSize: null,
                progress: 0
            };
            
            this.generatedReports.unshift(newReport);
            this.simulateReportGeneration(newReport);
        },
        
        simulateReportGeneration(report) {
            const interval = setInterval(() => {
                report.progress += Math.random() * 20;
                
                if (report.progress >= 100) {
                    report.progress = 100;
                    report.status = 'completed';
                    report.fileSize = Math.floor(Math.random() * 5000000) + 1000000;
                    clearInterval(interval);
                }
            }, 500);
        },
        
        // Preview
        previewReport(template) {
            this.showPreviewModal = true;
            this.previewLoading = true;
            this.previewData = null;
            
            setTimeout(() => {
                this.previewData = {
                    totalRecords: template.dataPoints,
                    period: this.getPeriodLabel(),
                    lastUpdate: this.formatDate(new Date()),
                    columns: ['Tarefa', 'Responsável', 'Status', 'Prioridade', 'Data'],
                    sampleRows: [
                        {
                            id: 1,
                            values: ['Implementar login', 'João Silva', 'Concluído', 'Alta', '2025-01-20']
                        },
                        {
                            id: 2,
                            values: ['Design da tela inicial', 'Maria Santos', 'Em Progresso', 'Média', '2025-01-22']
                        },
                        {
                            id: 3,
                            values: ['Testes de integração', 'Pedro Costa', 'Pendente', 'Alta', '2025-01-23']
                        }
                    ]
                };
                
                this.previewLoading = false;
                this.$nextTick(() => {
                    this.initPreviewChart();
                });
            }, 2000);
        },
        
        initPreviewChart() {
            const ctx = document.getElementById('previewChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Pendente', 'Em Progresso', 'Revisão', 'Concluído'],
                        datasets: [{
                            label: 'Número de Tarefas',
                            data: [12, 19, 8, 25],
                            backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        },
        
        closePreview() {
            this.showPreviewModal = false;
            this.previewData = null;
        },
        
        generateFromPreview() {
            this.closePreview();
            // Generate report based on preview
        },
        
        // Custom report builder
        createCustomReport() {
            this.showCustomReportModal = true;
            this.customReportStep = 1;
        },
        
        closeCustomReport() {
            this.showCustomReportModal = false;
            this.resetCustomReport();
        },
        
        resetCustomReport() {
            this.customReport = {
                name: '',
                description: '',
                type: 'summary',
                formats: ['pdf'],
                selectedFields: [],
                groupBy: '',
                orderBy: 'created_at',
                orderDirection: 'desc',
                includeCharts: true,
                includeSummary: true,
                schedule: false,
                frequency: 'weekly',
                emailRecipients: ''
            };
            this.customReportStep = 1;
        },
        
        canProceedStep() {
            switch (this.customReportStep) {
                case 1:
                    return this.customReport.name.trim() !== '';
                case 2:
                    return this.customReport.selectedFields.length > 0;
                case 3:
                    return true;
                default:
                    return true;
            }
        },
        
        isFieldSelected(field) {
            return this.customReport.selectedFields.some(f => f.id === field.id);
        },
        
        toggleField(field) {
            const index = this.customReport.selectedFields.findIndex(f => f.id === field.id);
            if (index >= 0) {
                this.customReport.selectedFields.splice(index, 1);
            } else {
                this.customReport.selectedFields.push(field);
            }
        },
        
        removeField(field) {
            const index = this.customReport.selectedFields.findIndex(f => f.id === field.id);
            if (index >= 0) {
                this.customReport.selectedFields.splice(index, 1);
            }
        },
        
        // Report actions
        viewReport(report) {
            console.log('Viewing report:', report.id);
            // Open report viewer
        },
        
        exportReport(report, format) {
            console.log('Exporting report:', report.id, 'as', format);
            // Download report in specified format
        },
        
        shareReport(report) {
            console.log('Sharing report:', report.id);
            // Open share modal
        },
        
        deleteReport(report) {
            if (confirm('Tem certeza que deseja excluir este relatório?')) {
                const index = this.generatedReports.findIndex(r => r.id === report.id);
                if (index >= 0) {
                    this.generatedReports.splice(index, 1);
                }
            }
        },
        
        // Actions
        exportAllReports() {
            console.log('Exporting all reports');
            // Export all completed reports
        },
        
        showScheduledReports() {
            console.log('Showing scheduled reports');
            // Show scheduled reports modal
        },
        
        loadInitialData() {
            // Load boards, users, etc.
            console.log('Loading initial data');
        },
        
        // Utilities
        formatDate(date) {
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).format(date);
        },
        
        formatFileSize(bytes) {
            if (!bytes) return '';
            
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return size.toFixed(1) + ' ' + units[unitIndex];
        },
        
        getPeriodLabel() {
            switch (this.filters.period) {
                case '7d': return 'Últimos 7 dias';
                case '30d': return 'Últimos 30 dias';
                case '90d': return 'Últimos 90 dias';
                case '1y': return 'Último ano';
                case 'custom': return 'Período personalizado';
                default: return 'Últimos 30 dias';
            }
        }
    }
}
</script>
{% endblock %}
