{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Relatórios de Beneficiárias{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8 flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-900">Relatórios de Beneficiárias</h1>
    </div>
    <form method="get" class="bg-white shadow rounded-lg p-6 mb-8 grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select name="status" class="form-select w-full">
                <option value="">Todos</option>
                {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
            <input type="text" name="neighbourhood" value="{{ request.GET.neighbourhood }}" class="form-input w-full" placeholder="Bairro">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Idade Mínima</label>
            <input type="number" name="min_age" value="{{ request.GET.min_age }}" class="form-input w-full" min="0">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Idade Máxima</label>
            <input type="number" name="max_age" value="{{ request.GET.max_age }}" class="form-input w-full" min="0">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Vulnerabilidade</label>
            <select name="vulnerability" class="form-select w-full">
                <option value="">Todas</option>
                <option value="sim" {% if request.GET.vulnerability == 'sim' %}selected{% endif %}>Sim</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nº de Filhos</label>
            <input type="number" name="num_children" value="{{ request.GET.num_children }}" class="form-input w-full" min="0">
        </div>
        <div class="md:col-span-5 flex items-end">
            <button type="submit" class="inline-flex items-center px-4 py-2 bg-purple-600 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-purple-700">Filtrar</button>
        </div>
    </form>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2">Total de Beneficiárias</h3>
            <p class="text-3xl font-bold">{{ total }}</p>
            <p class="text-sm text-gray-500">Ativas: {{ total_active }} | Inativas: {{ total_inactive }}</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2">Idade Média</h3>
            <p class="text-3xl font-bold">{{ avg_age }}</p>
            <p class="text-sm text-gray-500">Mín: {{ min_age|default:'-' }} | Máx: {{ max_age|default:'-' }}</p>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2">Distribuição por Bairro</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                {% for n in neighbourhoods %}
                    <li>{{ n.neighbourhood|default:'-' }}: {{ n.count }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2">Distribuição por Nº de Filhos</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                {% for c in children_dist %}
                    <li>{{ c.number_of_children|default:'-' }} filho(s): {{ c.count }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2">Status</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                <li>Ativas: {{ total_active }}</li>
                <li>Inativas: {{ total_inactive }}</li>
            </ul>
        </div>
    </div>
    <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Lista de Beneficiárias ({{ total }})</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idade</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bairro</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº Filhos</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relatório</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for b in beneficiaries %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">{{ b.full_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ b.age|default:'-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ b.neighbourhood|default:'-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ b.number_of_children|default:'-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ b.get_status_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="{% url 'members:beneficiary-report' b.pk %}" class="text-purple-600 hover:text-purple-900 font-medium">Ver Relatório</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">Nenhuma beneficiária encontrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Gráficos (exemplo com Chart.js) -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Gráficos</h3>
        <canvas id="chart-age" height="80"></canvas>
        <canvas id="chart-children" height="80" class="mt-8"></canvas>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Exemplo de gráfico de idades
const ctxAge = document.getElementById('chart-age').getContext('2d');
const ageData = {
    labels: [{% for b in beneficiaries %}'{{ b.full_name }}',{% endfor %}],
    datasets: [{
        label: 'Idade',
        data: [{% for b in beneficiaries %}{{ b.age|default:0 }},{% endfor %}],
        backgroundColor: 'rgba(139, 92, 246, 0.5)',
        borderColor: 'rgba(139, 92, 246, 1)',
        borderWidth: 1
    }]
};
new Chart(ctxAge, {
    type: 'bar',
    data: ageData,
    options: {responsive: true, plugins: {legend: {display: false}}}
});
// Exemplo de gráfico de filhos
const ctxChildren = document.getElementById('chart-children').getContext('2d');
const childrenData = {
    labels: [{% for c in children_dist %}'{{ c.number_of_children|default:"-" }}',{% endfor %}],
    datasets: [{
        label: 'Nº de Filhos',
        data: [{% for c in children_dist %}{{ c.count }},{% endfor %}],
        backgroundColor: 'rgba(16, 185, 129, 0.5)',
        borderColor: 'rgba(16, 185, 129, 1)',
        borderWidth: 1
    }]
};
new Chart(ctxChildren, {
    type: 'bar',
    data: childrenData,
    options: {responsive: true, plugins: {legend: {display: false}}}
});
</script>
{% endblock %}
