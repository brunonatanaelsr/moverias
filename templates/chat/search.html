{% extends 'base_optimized.html' %}
{% load static %}

{% block title %}Buscar no Chat - MoveMarias{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard specific animations */
    .dashboard-fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    
    .dashboard-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(15px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Hover effects */
    .dashboard-card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<!-- Add breadcrumb items here if needed -->
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
<div class="grid-optimized grid-optimized-2">
        <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
            <div class="flex justify-between items-center mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'chat:home' %}">Chat</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Buscar</li>
                    </ol>
                </nav>
                <a href="{% url 'chat:home' %}" class="mm-btn mm-btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <div class="grid-optimized grid-optimized-2">
                <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                    <div class="card-optimized card-padding-md section-spacing-md" dashboard-card-hover dashboard-slide-up>
                        <div class="card-padding-md border-b">
                            <h1 class="h4 mb-0">
                                <i class="fas fa-search text-purple-move"></i>
                                Buscar no Chat
                            </h1>
                        </div>
                        <div class="card-padding-md">
                            <form method="get" class="row g-3">
                                <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                                    <label for="q" class="form-label-optimized">Buscar por</label>
                                    <input type="text" class="input-field" id="q" name="q" 
                                           value="{{ query }}" placeholder="Digite sua busca...">
                                </div>
                                <div class="col-md-3">
                                    <label for="type" class="form-label-optimized">Tipo de busca</label>
                                    <select class="form-select" id="type" name="type">
                                        <option value="all" {% if search_type == 'all' %}selected{% endif %}>Tudo</option>
                                        <option value="rooms" {% if search_type == 'rooms' %}selected{% endif %}>Salas</option>
                                        <option value="messages" {% if search_type == 'messages' %}selected{% endif %}>Mensagens</option>
                                        <option value="users" {% if search_type == 'users' %}selected{% endif %}>Usuários</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label>&nbsp;</label>
                                    <div class="flex gap-2">
                                        <button type="submit" class="btn-primary">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <a href="{% url 'chat:search' %}" class="mm-btn mm-btn-outline-secondary">
                                            <i class="fas fa-times"></i> Limpar
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            {% if query %}
            <div class="grid-optimized grid-optimized-2">
                <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                    <!-- Search Results -->
                    <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                        <div class="mm-mm-card-header flex justify-between items-center">
                            <h5 class="mb-0">Resultados da busca</h5>
                            <span class="text-gray-600">
                                {{ total_results }} resultado{{ total_results|pluralize }} para "{{ query }}"
                            </span>
                        </div>
                        <div class="mm-mm-card-body p-0">
                            {% if total_results > 0 %}
                            <!-- Rooms Results -->
                            {% if rooms %}
                            <div class="search-section">
                                <h6 class="section-header px-3 py-2 mb-0 bg-light">
                                    <i class="fas fa-comments text-purple-move"></i>
                                    Salas ({{ rooms|length }})
                                </h6>
                                <div class="list-group list-group-flush">
                                    {% for room in rooms %}
                                    <a href="{% url 'chat:room_detail' room.id %}" 
                                       class="list-group-item list-group-item-action">
                                        <div class="flex w-100 justify-between items-start">
                                            <div>
                                                <h6 class="mb-1">{{ room.name }}</h6>
                                                {% if room.description %}
                                                <p class="mb-1 text-gray-600">{{ room.description|truncatewords:15 }}</p>
                                                {% endif %}
                                                <text-sm class="text-gray-600">
                                                    <i class="fas fa-users"></i> {{ room.members_count }} membros
                                                    | Criada por {{ room.created_by.get_full_name|default:room.created_by.username }}
                                                </text-sm>
                                            </div>
                                            <span class="mm-badge mm-badge-{% if room.room_type == 'public' %}success{% elif room.room_type == 'private' %}warning{% else %}info{% endif %}">
                                                {% if room.room_type == 'public' %}Pública
                                                {% elif room.room_type == 'private' %}Privada
                                                {% else %}Grupo{% endif %}
                                            </span>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Messages Results -->
                            {% if messages %}
                            <div class="search-section">
                                <h6 class="section-header px-3 py-2 mb-0 bg-light">
                                    <i class="fas fa-comment text-blue-600"></i>
                                    Mensagens ({{ messages|length }})
                                </h6>
                                <div class="list-group list-group-flush">
                                    {% for message in messages %}
                                    <a href="{% url 'chat:room_detail' message.room.id %}?highlight={{ message.id }}" 
                                       class="list-group-item list-group-item-action">
                                        <div class="flex items-start">
                                            <div class="mr-3">
                                                {% if message.user.profile.avatar %}
                                                <img src="{{ message.user.profile.avatar.url }}" alt="{{ message.user.get_full_name }}" 
                                                     class="rounded-full" width="32" height="32">
                                                {% else %}
                                                <div class="bg-gray-600 rounded-full flex items-center justify-center" 
                                                     style="width: 32px; height: 32px; color: white; font-size: 0.8rem;">
                                                    {{ message.user.first_name|first|default:message.user.username|first }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow">
                                                <div class="flex justify-between items-start mb-1">
                                                    <h6 class="mb-0">{{ message.user.get_full_name|default:message.user.username }}</h6>
                                                    <text-sm class="text-gray-600">{{ message.created_at|date:"d/m/Y H:i" }}</text-sm>
                                                </div>
                                                <p class="mb-1">{{ message.content|truncatewords:20 }}</p>
                                                <text-sm class="text-gray-600">
                                                    <i class="fas fa-comments"></i> 
                                                    Em {{ message.room.name }}
                                                </text-sm>
                                            </div>
                                        </div>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Users Results -->
                            {% if users %}
                            <div class="search-section">
                                <h6 class="section-header px-3 py-2 mb-0 bg-light">
                                    <i class="fas fa-users text-green-600"></i>
                                    Usuários ({{ users|length }})
                                </h6>
                                <div class="list-group list-group-flush">
                                    {% for user in users %}
                                    <div class="list-group-item">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                {% if user.profile.avatar %}
                                                <img src="{{ user.profile.avatar.url }}" alt="{{ user.get_full_name }}" 
                                                     class="rounded-full mr-3" width="40" height="40">
                                                {% else %}
                                                <div class="bg-gray-600 rounded-full flex items-center justify-center mr-3" 
                                                     style="width: 40px; height: 40px; color: white; font-size: 1rem;">
                                                    {{ user.first_name|first|default:user.username|first }}
                                                </div>
                                                {% endif %}
                                                <div>
                                                    <h6 class="mb-1">{{ user.get_full_name|default:user.username }}</h6>
                                                    <text-sm class="text-gray-600">{{ user.email }}</text-sm>
                                                </div>
                                            </div>
                                            <button type="button" class="btn mm-mm-btn-sm btn-outline-primary" 
                                                    onclick="startDirectMessage('{{ user.id }}')">
                                                <i class="fas fa-comment"></i> Conversar
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-search text-gray-600" style="font-size: 4rem;"></i>
                                <h3 class="mt-3">Nenhum resultado encontrado</h3>
                                <p class="text-gray-600">Tente usar termos diferentes ou mais específicos.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Search Tips -->
                    <div class="card mb-3">
                        <div class="card-padding-md border-b">
                            <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Dicas de Busca</h6>
                        </div>
                        <div class="card-padding-md">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check text-green-600"></i>
                                    Use palavras-chave específicas
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-green-600"></i>
                                    Busque por nomes de salas ou usuários
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-green-600"></i>
                                    Use aspas para busca exata
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-green-600"></i>
                                    Filtre por tipo de conteúdo
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Recent Searches -->
                    {% if recent_searches %}
                    <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                        <div class="card-padding-md border-b">
                            <h6 class="mb-0"><i class="fas fa-history"></i> Buscas Recentes</h6>
                        </div>
                        <div class="card-padding-md">
                            {% for search in recent_searches %}
                            <a href="?q={{ search.query|urlencode }}&type={{ search.type }}" 
                               class="block text-decoration-none mb-2">
                                <text-sm class="text-gray-600">
                                    <i class="fas fa-search"></i> {{ search.query }}
                                </text-sm>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Initial Search State -->
            <div class="grid-optimized grid-optimized-2">
                <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                    <div class="text-center py-5">
                        <i class="fas fa-search text-gray-600" style="font-size: 4rem;"></i>
                        <h3 class="mt-3">Buscar no Chat</h3>
                        <p class="text-gray-600">Digite um termo acima para buscar por salas, mensagens ou usuários.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.search-section:not(:last-child) {
    border-bottom: 1px solid #dee2e6;
}

.section-header {
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
}

.list-group-item-action:hover {
    background-color: #f8f9fa;
}

.breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: #495057;
    text-decoration: underline;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.mm-mm-card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>

<script>
function startDirectMessage(userId) {
    // AJAX call to start direct message with user
    fetch(`{% url 'chat:start_direct_message' %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            user_id: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.room_url;
        } else {
            alert('Erro ao iniciar conversa');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao iniciar conversa');
    });
}

// Focus on search input
document.getElementById('q').focus();
</script>
</div>
{% endblock %}
