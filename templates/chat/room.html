{% extends 'base_optimized.html' %}
{% load static %}

{% block title %}Chat - {{ room.name }} - MoveMarias{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 160px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: #007bff;
        color: white;
        padding: 15px 20px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
    }
    
    .chat-info {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    
    .message.own {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .message-content {
        flex: 1;
        max-width: 70%;
    }
    
    .message.own .message-content {
        text-align: right;
    }
    
    .message-bubble {
        background: white;
        border-radius: 18px;
        padding: 12px 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: inline-block;
        max-width: 100%;
        word-wrap: break-word;
    }
    
    .message.own .message-bubble {
        background: #007bff;
        color: white;
    }
    
    .message-meta {
        font-size: 0.8rem;
        color: #666;
        margin-top: 5px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .message.own .message-meta {
        justify-content: flex-end;
        color: #ccc;
    }
    
    .message-time {
        font-size: 0.75rem;
    }
    
    .message-sender {
        font-weight: 600;
    }
    
    .message-reply {
        background: #f0f0f0;
        border-left: 3px solid #007bff;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .message-reply-sender {
        font-weight: 600;
        color: #007bff;
        font-size: 0.8rem;
    }
    
    .message-attachment {
        margin-top: 8px;
    }
    
    .message-attachment img {
        max-width: 300px;
        max-height: 200px;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .message-attachment-file {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        text-decoration: none;
        color: #333;
    }
    
    .message-attachment-file:hover {
        background: #e9ecef;
        color: #007bff;
        text-decoration: none;
    }
    
    .message-reactions {
        display: flex;
        gap: 5px;
        margin-top: 8px;
    }
    
    .message-reaction {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 2px 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .message-reaction:hover {
        background: #e9ecef;
    }
    
    .message-reaction.reacted {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .chat-input {
        background: white;
        padding: 20px;
        border-radius: 0 0 10px 10px;
        border: 1px solid #dee2e6;
        border-top: none;
    }
    
    .chat-input-form {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chat-input-field {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 10px 15px;
        font-size: 0.9rem;
        resize: none;
        height: 40px;
        max-height: 120px;
    }
    
    .chat-input-field:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .chat-send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .chat-send-btn:hover {
        background: #0056b3;
    }
    
    .chat-send-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .chat-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .chat-action-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .chat-action-btn:hover {
        background: #e9ecef;
    }
    
    .typing-indicator {
        padding: 10px 20px;
        font-style: italic;
        color: #666;
        font-size: 0.9rem;
    }
    
    .chat-sidebar {
        width: 300px;
        background: white;
        border-left: 1px solid #dee2e6;
        padding: 20px;
        overflow-y: auto;
    }
    
    .chat-members {
        margin-bottom: 30px;
    }
    
    .chat-member {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .chat-member:last-child {
        border-bottom: none;
    }
    
    .member-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .member-online {
        position: relative;
    }
    
    .member-online::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background: #28a745;
        border-radius: 50%;
        border: 2px solid white;
    }
    
    .member-name {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .member-role {
        font-size: 0.8rem;
        color: #666;
    }
    
    .system-message {
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<!-- Add breadcrumb items here if needed -->
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
<div class="grid-optimized grid-optimized-2">
        <div class="col-md-9">
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <h3 class="chat-title">{{ room.name }}</h3>
                        <div class="chat-info">
                            {{ room.get_members_count }} membros • {{ room.get_room_type_display }}
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="Configurações">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="chat-action-btn" title="Buscar">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="chat-action-btn" title="Mais opções">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                        <div class="message {% if message.sender == user %}own{% endif %}" data-message-id="{{ message.id }}">
                            <div class="message-avatar">
                                {{ message.sender.get_full_name.0|default:message.sender.username.0 }}
                            </div>
                            <div class="message-content">
                                {% if message.reply_to %}
                                    <div class="message-reply">
                                        <div class="message-reply-sender">{{ message.reply_to.sender.get_full_name }}</div>
                                        <div>{{ message.reply_to.content|truncatewords:10 }}</div>
                                    </div>
                                {% endif %}
                                
                                <div class="message-bubble">
                                    {{ message.content|linebreaks }}
                                    
                                    {% if message.attachment %}
                                        <div class="message-attachment">
                                            {% if message.is_image %}
                                                <img src="{{ message.attachment.url }}" alt="Imagem" onclick="openImageModal(this)">
                                            {% else %}
                                                <a href="{{ message.attachment.url }}" class="message-attachment-file" download>
                                                    <i class="fas fa-paperclip"></i>
                                                    <span>{{ message.get_attachment_name }}</span>
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="message-meta">
                                    <span class="message-sender">{{ message.sender.get_full_name }}</span>
                                    <span class="message-time">{{ message.created_at|date:"H:i" }}</span>
                                    {% if message.is_edited %}
                                        <span class="message-edited">(editado)</span>
                                    {% endif %}
                                </div>
                                
                                {% if message.reactions.exists %}
                                    <div class="message-reactions">
                                        {% for reaction in message.reactions.all %}
                                            <span class="message-reaction {% if reaction.user == user %}reacted{% endif %}" 
                                                  data-reaction="{{ reaction.reaction }}"
                                                  onclick="toggleReaction('{{ message.id }}', '{{ reaction.reaction }}')">
                                                {{ reaction.reaction }} {{ reaction.count }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="system-message">
                            Nenhuma mensagem ainda. Seja o primeiro a enviar uma mensagem!
                        </div>
                    {% endfor %}
                </div>
                
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <span id="typingUsers"></span> está digitando...
                </div>
                
                <div class="chat-input">
                    <form class="chat-input-form" id="messageForm">
                        <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.txt">
                        <button type="button" class="chat-action-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="chat-action-btn" onclick="toggleEmojiPicker()">
                            <i class="fas fa-smile"></i>
                        </button>
                        <textarea class="chat-input-field" 
                                  id="messageInput" 
                                  placeholder="Digite sua mensagem..." 
                                  rows="1"
                                  onkeydown="handleKeyDown(event)"
                                  oninput="handleInput(event)"></textarea>
                        <button type="submit" class="chat-send-btn" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="chat-sidebar">
                <div class="chat-members">
                    <h5>Membros ({{ room.get_members_count }})</h5>
                    {% for membership in room.chatroomembership_set.all %}
                        <div class="chat-member">
                            <div class="member-avatar member-online">
                                {{ membership.user.get_full_name.0|default:membership.user.username.0 }}
                            </div>
                            <div>
                                <div class="member-name">{{ membership.user.get_full_name }}</div>
                                <div class="member-role">{{ membership.get_role_display }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="chat-info-section">
                    <h5>Informações</h5>
                    <p><strong>Tipo:</strong> {{ room.get_room_type_display }}</p>
                    <p><strong>Criado:</strong> {{ room.created_at|date:"d/m/Y" }}</p>
                    <p><strong>Criado por:</strong> {{ room.created_by.get_full_name }}</p>
                    {% if room.description %}
                        <p><strong>Descrição:</strong> {{ room.description }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar imagens -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Imagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" style="max-width: 100%; max-height: 70vh;">
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let typingTimeout;
let isTyping = false;

function handleKeyDown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    } else {
        handleTyping();
    }
}

function handleInput(event) {
    // Auto-resize textarea
    const textarea = event.target;
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

function handleTyping() {
    if (!isTyping) {
        isTyping = true;
        // Enviar indicador de digitação via WebSocket
        // socket.send(JSON.stringify({
        //     type: 'typing',
        //     room: '{{ room.id }}',
        //     user: '{{ user.id }}'
        // }));
    }
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        isTyping = false;
        // Parar indicador de digitação
        // socket.send(JSON.stringify({
        //     type: 'stop_typing',
        //     room: '{{ room.id }}',
        //     user: '{{ user.id }}'
        // }));
    }, 3000);
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message) {
        // Enviar mensagem via AJAX
        fetch('{% url "chat:send_message" room.id %}', {
            method: 'POST',
            body: JSON.stringify({
                content: message,
                room: '{{ room.id }}'
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                input.style.height = 'auto';
                // Recarregar mensagens ou adicionar via WebSocket
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}

function toggleReaction(messageId, reaction) {
    fetch(`{% url "chat:toggle_reaction" %}`, {
        method: 'POST',
        body: JSON.stringify({
            message_id: messageId,
            reaction: reaction
        }),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar reações na interface
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function openImageModal(img) {
    document.getElementById('modalImage').src = img.src;
    const modal = document.getElementById('imageModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function toggleEmojiPicker() {
    // Implementar picker de emojis
    alert('Emoji picker em desenvolvimento');
}

// Scroll automático para a última mensagem
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Submeter formulário
    document.getElementById('messageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Upload de arquivo
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('room', '{{ room.id }}');
            
            fetch('{% url "chat:upload_file" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erro ao enviar arquivo: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });
});

// WebSocket para tempo real (implementação futura)
// const socket = new WebSocket('ws://localhost:8000/ws/chat/{{ room.id }}/');
// socket.onmessage = function(event) {
//     const data = JSON.parse(event.data);
//     // Processar mensagens em tempo real
// };
</script>
{% endblock %}
