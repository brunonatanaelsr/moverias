<!-- Enhanced Dynamic Search Component -->
<div class="search-container bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6" role="search">
    <div class="flex flex-col sm:flex-row gap-4">
        <!-- Main Search Input -->
        <div class="relative flex-1">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400" aria-hidden="true"></i>
            </div>
            <input type="text" 
                   name="search" 
                   id="search-input"
                   class="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors"
                   placeholder="{{ placeholder|default:'Buscar...' }}"
                   value="{{ search_query|default:'' }}"
                   hx-get="{{ search_url }}"
                   hx-trigger="keyup changed delay:300ms, search"
                   hx-target="#search-results"
                   hx-indicator="#search-loading"
                   hx-include="[name='status'], [name='type'], [name='category'], [name='date_from'], [name='date_to']"
                   autocomplete="off"
                   aria-label="Campo de busca">
            
            <!-- Clear button -->
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <button type="button" 
                        id="clear-search"
                        class="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors {% if not search_query %}hidden{% endif %}"
                        onclick="clearSearch()"
                        aria-label="Limpar busca">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        
        <!-- Filter Toggle Button -->
        <button type="button"
                id="toggle-filters"
                class="inline-flex items-center px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors"
                onclick="toggleFilters()"
                aria-expanded="false"
                aria-controls="advanced-filters">
            <i class="fas fa-filter mr-2" aria-hidden="true"></i>
            Filtros
            <i class="fas fa-chevron-down ml-2 transition-transform" id="filter-chevron" aria-hidden="true"></i>
        </button>
    </div>
    
    <!-- Advanced Filters (Hidden by default) -->
    <div id="advanced-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Status Filter -->
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select name="status" 
                        id="status-filter"
                        class="block w-full border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm"
                        hx-get="{{ search_url }}"
                        hx-trigger="change"
                        hx-target="#search-results"
                        hx-indicator="#search-loading"
                        hx-include="[name='search'], [name='type'], [name='category'], [name='date_from'], [name='date_to']">
                    <option value="">Todos os status</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Ativo</option>
                    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inativo</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendente</option>
                </select>
            </div>
            
            <!-- Type Filter -->
            <div>
                <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                <select name="type" 
                        id="type-filter"
                        class="block w-full border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm"
                        hx-get="{{ search_url }}"
                        hx-trigger="change"
                        hx-target="#search-results"
                        hx-indicator="#search-loading"
                        hx-include="[name='search'], [name='status'], [name='category'], [name='date_from'], [name='date_to']">
                    <option value="">Todos os tipos</option>
                    <!-- Dynamic options can be added here -->
                </select>
            </div>
            
            <!-- Date Range Filters -->
            <div>
                <label for="date-from" class="block text-sm font-medium text-gray-700 mb-1">Data início</label>
                <input type="date" 
                       name="date_from" 
                       id="date-from"
                       class="block w-full border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm"
                       value="{{ request.GET.date_from }}"
                       hx-get="{{ search_url }}"
                       hx-trigger="change"
                       hx-target="#search-results"
                       hx-indicator="#search-loading"
                       hx-include="[name='search'], [name='status'], [name='type'], [name='category'], [name='date_to']">
            </div>
            
            <div>
                <label for="date-to" class="block text-sm font-medium text-gray-700 mb-1">Data fim</label>
                <input type="date" 
                       name="date_to" 
                       id="date-to"
                       class="block w-full border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 text-sm"
                       value="{{ request.GET.date_to }}"
                       hx-get="{{ search_url }}"
                       hx-trigger="change"
                       hx-target="#search-results"
                       hx-indicator="#search-loading"
                       hx-include="[name='search'], [name='status'], [name='type'], [name='category'], [name='date_from']">
            </div>
        </div>
        
        <!-- Filter Actions -->
        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
            <button type="button"
                    onclick="clearAllFilters()"
                    class="text-sm text-gray-500 hover:text-gray-700 focus:outline-none focus:text-gray-700 transition-colors">
                <i class="fas fa-eraser mr-1" aria-hidden="true"></i>
                Limpar filtros
            </button>
            
            <div class="text-sm text-gray-500">
                <span id="results-count">{{ total_results|default:0 }}</span> resultado(s) encontrado(s)
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="search-loading" class="htmx-indicator mt-3">
        <div class="flex-center">
            <div class="animate-spin rounded-full h-5 w-5 border-2 border-purple-200 border-t-purple-600"></div>
            <span class="ml-2 text-sm text-gray-600">Buscando...</span>
        </div>
    </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="search-loading" class="htmx-indicator absolute top-2 right-8">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
    </div>
</div>

<!-- Advanced filters (collapsible) -->
<div class="section-spacing-sm">
    <button type="button" 
            class="flex items-center text-sm text-gray-600 hover:text-gray-800"
            onclick="toggleFilters()"
            id="filter-toggle">
        <svg class="h-4 w-4 mr-1 transform transition-transform" id="filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        Filtros avançados
    </button>
    
    <div id="advanced-filters" class="hidden mt-3 p-4 bg-gray-50 rounded-lg space-y-3">
        {% block advanced_filters %}
        <!-- Custom filters will be inserted here by extending templates -->
        {% endblock %}
    </div>
</div>

<script>
function clearSearch() {
    const searchInput = document.getElementById('search-input');
    const clearButton = document.getElementById('clear-search');
    
    searchInput.value = '';
    clearButton.classList.add('hidden');
    
    // Trigger search to show all results
    htmx.trigger(searchInput, 'search');
}

function toggleFilters() {
    const filters = document.getElementById('advanced-filters');
    const arrow = document.getElementById('filter-arrow');
    
    filters.classList.toggle('hidden');
    arrow.classList.toggle('rotate-90');
}

// Show/hide clear button based on input
document.getElementById('search-input').addEventListener('input', function() {
    const clearButton = document.getElementById('clear-search');
    
    if (this.value.length > 0) {
        clearButton.classList.remove('hidden');
    } else {
        clearButton.classList.add('hidden');
    }
});
</script>

<style>
.htmx-indicator {
    opacity: 0;
    transition: opacity 200ms ease-in;
}

.htmx-request .htmx-indicator {
    opacity: 1;
}

.htmx-request.htmx-indicator {
    opacity: 1;
}
</style>
