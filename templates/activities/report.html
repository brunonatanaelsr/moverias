{% extends "base.html" %}
{% load static %}

{% block title %}Relatório da Atividade - Move Marias{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print { display: none !important; }
        .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        .container-fluid { padding: 0 !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header com Ações de Impressão -->
    <div class="row mb-4 no-print">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'activities:detail' activity.id %}" class="btn btn-sm btn-outline-primary me-3">
                                <i class="fas fa-arrow-left me-2"></i>Voltar
                            </a>
                            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                                <i class="fas fa-chart-bar text-success text-sm opacity-10"></i>
                            </div>
                            <h6 class="mb-0">Relatório da Atividade</h6>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-file-excel me-2"></i>Excel
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>PDF
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cabeçalho do Relatório -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-2">{{ activity.title }}</h3>
                    <p class="text-muted mb-3">Relatório Detalhado de Atividade</p>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="border-end pe-3">
                                <h6 class="text-muted mb-1">Beneficiária</h6>
                                <strong>{{ activity.beneficiary.get_full_name }}</strong>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end pe-3">
                                <h6 class="text-muted mb-1">Tipo</h6>
                                <strong>{{ activity.get_activity_type_display }}</strong>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end pe-3">
                                <h6 class="text-muted mb-1">Status</h6>
                                <strong class="text-success">{{ activity.get_status_display }}</strong>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted mb-1">Período</h6>
                            <strong>{{ activity.start_date|date:"d/m/Y" }} - {{ activity.end_date|date:"d/m/Y"|default:"Em andamento" }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Principais -->
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-xl-0">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Progresso</p>
                                <h5 class="font-weight-bolder mb-0">
                                    {{ activity.completion_percentage }}%
                                </h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="ni ni-chart-bar-32 text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-gradient-primary" 
                             role="progressbar" 
                             style="width: {{ activity.completion_percentage }}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Impacto Social</p>
                                <h5 class="font-weight-bolder mb-0">
                                    {{ activity.impact_score }}/100
                                </h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md">
                                <i class="fas fa-heart text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-gradient-success" 
                             role="progressbar" 
                             style="width: {{ activity.impact_score }}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Sessões</p>
                                <h5 class="font-weight-bolder mb-0">
                                    {{ sessions_count }}
                                </h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                                <i class="fas fa-calendar text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Presença</p>
                                <h5 class="font-weight-bolder mb-0">
                                    {{ attendance_rate }}%
                                </h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md">
                                <i class="fas fa-check text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-gradient-warning" 
                             role="progressbar" 
                             style="width: {{ attendance_rate }}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Informações da Atividade -->
        <div class="col-lg-8">
            <!-- Descrição e Objetivos -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Descrição e Objetivos</h6>
                </div>
                <div class="card-body">
                    {% if activity.description %}
                        <div class="mb-4">
                            <h6 class="text-sm">Descrição:</h6>
                            <p class="text-sm">{{ activity.description }}</p>
                        </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <h6 class="text-sm">Objetivos:</h6>
                        <p class="text-sm">{{ activity.objectives }}</p>
                    </div>
                    
                    {% if activity.expected_outcomes %}
                        <div class="mb-0">
                            <h6 class="text-sm">Resultados Esperados:</h6>
                            <p class="text-sm">{{ activity.expected_outcomes }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Gráficos de Progresso -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Evolução do Progresso</h6>
                </div>
                <div class="card-body">
                    <canvas id="progressChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Sessões Realizadas -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>Sessões Realizadas</h6>
                        <span class="badge bg-info">{{ sessions.count }} sessões</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if sessions %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Duração</th>
                                        <th>Presença</th>
                                        <th>Observações</th>
                                        <th>Avaliação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in sessions %}
                                        <tr>
                                            <td>{{ session.date|date:"d/m/Y" }}</td>
                                            <td>{{ session.duration }}min</td>
                                            <td>
                                                {% if session.attended %}
                                                    <span class="badge bg-success">Presente</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Ausente</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-xs">{{ session.notes|truncatechars:50 }}</td>
                                            <td>
                                                {% if session.rating %}
                                                    <div class="stars text-warning">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= session.rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">Nenhuma sessão registrada ainda</p>
                    {% endif %}
                </div>
            </div>

            <!-- Feedback e Avaliações -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Feedback e Avaliações</h6>
                </div>
                <div class="card-body">
                    {% if feedback_list %}
                        {% for feedback in feedback_list %}
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong class="text-sm">{{ feedback.author.get_full_name }}</strong>
                                        <span class="text-muted text-xs">- {{ feedback.created_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% if feedback.rating %}
                                        <div class="stars text-warning">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= feedback.rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <p class="text-sm mb-0">{{ feedback.comment }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">Nenhum feedback registrado ainda</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar com Informações Adicionais -->
        <div class="col-lg-4">
            <!-- Informações Técnicas -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Informações Técnicas</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">Facilitador/Responsável</small>
                            <div class="font-weight-bold">{{ activity.facilitator }}</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">Local</small>
                            <div>{{ activity.location }}</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">Frequência</small>
                            <div>{{ activity.get_frequency_display }}</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">Prioridade</small>
                            <div>
                                {% if activity.priority == 'HIGH' %}
                                    <span class="badge bg-danger">{{ activity.get_priority_display }}</span>
                                {% elif activity.priority == 'MEDIUM' %}
                                    <span class="badge bg-warning">{{ activity.get_priority_display }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ activity.get_priority_display }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if activity.materials_needed %}
                        <div class="row mb-3">
                            <div class="col-12">
                                <small class="text-muted">Materiais Necessários</small>
                                <div class="text-sm">{{ activity.materials_needed }}</div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <small class="text-muted">Criada em</small>
                            <div>{{ activity.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                    
                    <div class="row mb-0">
                        <div class="col-12">
                            <small class="text-muted">Criada por</small>
                            <div>{{ activity.created_by.get_full_name }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas de Presença -->
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h6>Estatísticas de Presença</h6>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" width="300" height="300"></canvas>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-sm">Sessões com presença</span>
                            <strong>{{ attended_sessions }}</strong>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-sm">Sessões com ausência</span>
                            <strong>{{ missed_sessions }}</strong>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-sm">Taxa de presença</span>
                            <strong class="text-success">{{ attendance_rate }}%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integração Social -->
            {% if activity.social_anamnesis %}
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>Integração Social</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Anamnese Social Relacionada</small>
                            <div class="text-sm">
                                <a href="#" class="text-decoration-none">
                                    {{ activity.social_anamnesis.title }}
                                </a>
                            </div>
                        </div>
                        <div class="mb-0">
                            <small class="text-muted">Status da Integração</small>
                            <div>
                                <span class="badge bg-info">Vinculada</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Ações Rápidas -->
            <div class="card no-print">
                <div class="card-header pb-0">
                    <h6>Ações</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'activities:edit' activity.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-edit me-2"></i>Editar Atividade
                        </a>
                        <a href="{% url 'activities:sessions' activity.id %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-calendar me-2"></i>Gerenciar Sessões
                        </a>
                        <button class="btn btn-outline-success btn-sm" onclick="shareReport()">
                            <i class="fas fa-share me-2"></i>Compartilhar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados para os gráficos
const progressData = {{ progress_history|safe }};
const attendanceData = {
    attended: {{ attended_sessions }},
    missed: {{ missed_sessions }}
};

// Gráfico de Evolução do Progresso
const progressCtx = document.getElementById('progressChart').getContext('2d');
const progressChart = new Chart(progressCtx, {
    type: 'line',
    data: {
        labels: progressData.map(item => item.date),
        datasets: [{
            label: 'Progresso (%)',
            data: progressData.map(item => item.progress),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Impacto Social',
            data: progressData.map(item => item.impact),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Evolução do Progresso e Impacto Social'
            }
        }
    }
});

// Gráfico de Presença
const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
const attendanceChart = new Chart(attendanceCtx, {
    type: 'doughnut',
    data: {
        labels: ['Presente', 'Ausente'],
        datasets: [{
            data: [attendanceData.attended, attendanceData.missed],
            backgroundColor: [
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 99, 132, 0.8)'
            ],
            borderColor: [
                'rgba(75, 192, 192, 1)',
                'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Funções de exportação
function exportToExcel() {
    const url = `{% url 'activities:export_excel' activity.id %}`;
    window.open(url, '_blank');
}

function exportToPDF() {
    const url = `{% url 'activities:export_pdf' activity.id %}`;
    window.open(url, '_blank');
}

function shareReport() {
    if (navigator.share) {
        navigator.share({
            title: 'Relatório de Atividade - {{ activity.title }}',
            text: 'Confira o relatório detalhado desta atividade do Move Marias',
            url: window.location.href
        });
    } else {
        // Fallback para copiar link
        navigator.clipboard.writeText(window.location.href).then(function() {
            alert('Link copiado para a área de transferência!');
        });
    }
}

// Ajustar gráficos para impressão
window.addEventListener('beforeprint', function() {
    progressChart.resize();
    attendanceChart.resize();
});
</script>
{% endblock %}
