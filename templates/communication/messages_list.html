{% extends 'base.html' %}
{% load static %}

{% block title %}Mensagens - MoveMarias{% endblock %}

{% block extra_css %}
<link href="{% static 'css/logo.css' %}" rel="stylesheet">
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
    :root {
        --move-purple: #6c3eb6;
        --move-pink: #e83e8c;
        --move-orange: #ff9800;
        --move-green: #22c55e;
        --move-blue: #2563eb;
    }
    .dashboard-fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    .dashboard-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .dashboard-card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .loading-spinner {
        border: 2px solid #fff;
        border-top: 2px solid var(--move-purple);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        vertical-align: middle;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .tooltip-box {
        position: absolute;
        background: #333;
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="messagesList()">
    <!-- Header + Breadcrumbs -->
    <header class="bg-white shadow-sm border-b border-gray-200" aria-label="Cabeçalho e navegação">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex items-center text-sm text-gray-500 py-2" aria-label="Breadcrumb">
                <ol class="flex space-x-2" itemscope itemtype="https://schema.org/BreadcrumbList">
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="/" class="hover:text-blue-700" itemprop="item"><span itemprop="name">Início</span></a>
                        <meta itemprop="position" content="1" />
                    </li>
                    <li class="mx-2">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <a href="{% url 'communication:dashboard' %}" class="hover:text-blue-700" itemprop="item"><span itemprop="name">Comunicação</span></a>
                        <meta itemprop="position" content="2" />
                    </li>
                    <li class="mx-2">/</li>
                    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                        <span class="text-gray-700 font-semibold" itemprop="name">Mensagens</span>
                        <meta itemprop="position" content="3" />
                    </li>
                </ol>
            </nav>
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="{% url 'communication:dashboard' %}" class="flex items-center text-gray-500 hover:text-gray-700" aria-label="Voltar para o dashboard de comunicação">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Dashboard
                    </a>
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Todas as Mensagens</h1>
                        <p class="text-sm text-gray-500 mt-1">Visualize, filtre e gerencie todas as mensagens do sistema.</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{% url 'communication:create_message' %}"
                       class="inline-flex items-center px-4 py-2 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                       style="background:var(--move-blue);color:#fff;"
                       aria-label="Criar nova mensagem">
                        <i class="fas fa-plus mr-2" style="color:#fff" aria-hidden="true"></i>
                        Nova Mensagem
                        <div class="loading-spinner hidden ml-2" id="spinner-message" aria-label="Carregando"></div>
                    </a>
                    {% include 'components/logo.html' %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Feedback Visual: Alertas -->
        <div id="alert-container" class="mb-4" aria-live="polite"></div>
        <!-- Filters -->
        <section class="bg-white shadow rounded-lg mb-6" aria-label="Filtros de mensagens">
            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <!-- Search -->
                    <div class="md:col-span-2">
                        <label for="search" class="block text-base font-semibold text-gray-700">Buscar</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" 
                                   id="search" 
                                   x-model="searchQuery" 
                                   @input="filterMessages"
                                   class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 sm:text-base border-gray-300 rounded-md"
                                   placeholder="Buscar mensagens..."
                                   aria-label="Buscar mensagens">
                        </div>
                    </div>

                    <!-- Type Filter -->
                    <div>
                        <label for="type-filter" class="block text-base font-semibold text-gray-700">Tipo</label>
                        <select id="type-filter" 
                                x-model="selectedType" 
                                @change="filterMessages"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-base rounded-md"
                                aria-label="Filtrar por tipo de mensagem">
                            <option value="">Todos</option>
                            <option value="announcement">Comunicados</option>
                            <option value="memo">Memorandos</option>
                            <option value="newsletter">Newsletters</option>
                            <option value="notification">Notificações</option>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div>
                        <label for="priority-filter" class="block text-base font-semibold text-gray-700">Prioridade</label>
                        <select id="priority-filter" 
                                x-model="selectedPriority" 
                                @change="filterMessages"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-base rounded-md"
                                aria-label="Filtrar por prioridade">
                            <option value="">Todas</option>
                            <option value="urgent">Urgente</option>
                            <option value="high">Alta</option>
                            <option value="medium">Média</option>
                            <option value="low">Baixa</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label for="status-filter" class="block text-base font-semibold text-gray-700">Status</label>
                        <select id="status-filter" 
                                x-model="selectedStatus" 
                                @change="filterMessages"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-base rounded-md"
                                aria-label="Filtrar por status">
                            <option value="">Todos</option>
                            <option value="published">Publicadas</option>
                            <option value="draft">Rascunhos</option>
                            <option value="scheduled">Agendadas</option>
                            <option value="archived">Arquivadas</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Messages List -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900">
                        <span x-text="filteredMessages.length"></span> mensagens
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button @click="toggleView" 
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg x-show="viewMode === 'list'" class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                            <svg x-show="viewMode === 'grid'" class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H5m14 14H5"></path>
                            </svg>
                        </button>
                        <select x-model="sortBy" 
                                @change="sortMessages"
                                class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="created_at">Data de Criação</option>
                            <option value="title">Título</option>
                            <option value="priority">Prioridade</option>
                            <option value="type">Tipo</option>
                        </select>
                    </div>
                </div>

                <!-- List View -->
                <div x-show="viewMode === 'list'" class="space-y-4">
                    <template x-for="message in filteredMessages" :key="message.id">
                        <div class="border-l-4 bg-white p-4 rounded-r-md shadow-sm hover:shadow-md transition-shadow duration-200"
                             :class="{
                                'border-red-500': message.priority === 'urgent',
                                'border-yellow-500': message.priority === 'high',
                                'border-blue-500': message.status === 'published',
                                'border-gray-300': message.status === 'draft'
                             }">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="flex-shrink-0">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="{
                                                'bg-blue-100 text-blue-800': message.message_type === 'announcement',
                                                'bg-green-100 text-green-800': message.message_type === 'memo',
                                                'bg-purple-100 text-purple-800': message.message_type === 'newsletter',
                                                'bg-gray-100 text-gray-800': message.message_type === 'notification'
                                              }"
                                              x-text="getTypeLabel(message.message_type)">
                                        </span>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-medium text-gray-900" x-text="message.title"></p>
                                        <p class="text-sm text-gray-500" x-text="truncate(message.content, 100)"></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                          :class="{
                                            'bg-red-100 text-red-800': message.priority === 'urgent',
                                            'bg-yellow-100 text-yellow-800': message.priority === 'high',
                                            'bg-blue-100 text-blue-800': message.priority === 'medium',
                                            'bg-gray-100 text-gray-800': message.priority === 'low'
                                          }"
                                          x-show="message.priority !== 'medium'"
                                          x-text="getPriorityLabel(message.priority)">
                                    </span>
                                    <span class="text-sm text-gray-500" x-text="formatDate(message.created_at)"></span>
                                    <div class="flex items-center space-x-1">
                                        <button @click="viewMessage(message.id)" 
                                                class="text-blue-600 hover:text-blue-800 transition-colors duration-200">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button @click="editMessage(message.id)" 
                                                class="text-green-600 hover:text-green-800 transition-colors duration-200">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button @click="deleteMessage(message.id)" 
                                                class="text-red-600 hover:text-red-800 transition-colors duration-200">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div x-show="message.tags" class="mt-2 flex flex-wrap gap-1">
                                <template x-for="tag in message.tags.split(',')" :key="tag">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800"
                                          x-text="tag.trim()">
                                    </span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Grid View -->
                <div x-show="viewMode === 'grid'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="message in filteredMessages" :key="message.id">
                        <div class="border-l-4 bg-white p-4 rounded-r-md shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer"
                             :class="{
                                'border-red-500': message.priority === 'urgent',
                                'border-yellow-500': message.priority === 'high',
                                'border-blue-500': message.status === 'published',
                                'border-gray-300': message.status === 'draft'
                             }"
                             @click="viewMessage(message.id)">
                            <div class="flex items-center justify-between mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="{
                                        'bg-blue-100 text-blue-800': message.message_type === 'announcement',
                                        'bg-green-100 text-green-800': message.message_type === 'memo',
                                        'bg-purple-100 text-purple-800': message.message_type === 'newsletter',
                                        'bg-gray-100 text-gray-800': message.message_type === 'notification'
                                      }"
                                      x-text="getTypeLabel(message.message_type)">
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                      :class="{
                                        'bg-red-100 text-red-800': message.priority === 'urgent',
                                        'bg-yellow-100 text-yellow-800': message.priority === 'high',
                                        'bg-blue-100 text-blue-800': message.priority === 'medium',
                                        'bg-gray-100 text-gray-800': message.priority === 'low'
                                      }"
                                      x-show="message.priority !== 'medium'"
                                      x-text="getPriorityLabel(message.priority)">
                                </span>
                            </div>
                            <h3 class="text-sm font-medium text-gray-900 mb-1" x-text="message.title"></h3>
                            <p class="text-sm text-gray-500 mb-2" x-text="truncate(message.content, 100)"></p>
                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <span x-text="formatDate(message.created_at)"></span>
                                <span x-text="message.author"></span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="filteredMessages.length === 0" class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhuma mensagem encontrada</h3>
                    <p class="mt-1 text-sm text-gray-500">Tente ajustar os filtros ou criar uma nova mensagem.</p>
                    <div class="mt-6">
                        <a href="{% url 'communication:create_message' %}"
                           class="inline-flex items-center px-4 py-2 rounded-md transition-colors"
                           style="background:var(--move-blue);color:#fff;">
                            <i class="fas fa-plus mr-2" style="color:#fff"></i> Nova Mensagem
                            <div class="loading-spinner hidden ml-2" id="spinner-message"></div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function messagesList() {
    return {
        viewMode: 'list',
        searchQuery: '',
        selectedType: '',
        selectedPriority: '',
        selectedStatus: '',
        sortBy: 'created_at',
        messages: {{ messages_json|safe }},
        filteredMessages: [],
        
        init() {
            this.filteredMessages = this.messages;
            this.sortMessages();
        },
        
        filterMessages() {
            let filtered = this.messages;
            
            // Search filter
            if (this.searchQuery) {
                filtered = filtered.filter(message => 
                    message.title.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    message.content.toLowerCase().includes(this.searchQuery.toLowerCase())
                );
            }
            
            // Type filter
            if (this.selectedType) {
                filtered = filtered.filter(message => message.message_type === this.selectedType);
            }
            
            // Priority filter
            if (this.selectedPriority) {
                filtered = filtered.filter(message => message.priority === this.selectedPriority);
            }
            
            // Status filter
            if (this.selectedStatus) {
                filtered = filtered.filter(message => message.status === this.selectedStatus);
            }
            
            this.filteredMessages = filtered;
            this.sortMessages();
        },
        
        sortMessages() {
            this.filteredMessages.sort((a, b) => {
                switch(this.sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'priority':
                        const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    case 'type':
                        return a.message_type.localeCompare(b.message_type);
                    case 'created_at':
                    default:
                        return new Date(b.created_at) - new Date(a.created_at);
                }
            });
        },
        
        toggleView() {
            this.viewMode = this.viewMode === 'list' ? 'grid' : 'list';
        },
        
        viewMessage(messageId) {
            window.location.href = `/communication/messages/${messageId}/`;
        },
        
        editMessage(messageId) {
            window.location.href = `/communication/messages/${messageId}/edit/`;
        },
        
        deleteMessage(messageId) {
            if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
                fetch(`/communication/messages/${messageId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        this.messages = this.messages.filter(m => m.id !== messageId);
                        this.filterMessages();
                        showAlert('Mensagem excluída com sucesso!', 'success');
                    } else {
                        showAlert('Erro ao excluir mensagem. Tente novamente.', 'error');
                    }
                }).catch(() => {
                    showAlert('Erro de conexão ao excluir mensagem.', 'error');
                });
            }
        },
        
        getTypeLabel(type) {
            const labels = {
                'announcement': 'Comunicado',
                'memo': 'Memorando',
                'newsletter': 'Newsletter',
                'notification': 'Notificação'
            };
            return labels[type] || type;
        },
        
        getPriorityLabel(priority) {
            const labels = {
                'urgent': 'Urgente',
                'high': 'Alta',
                'medium': 'Média',
                'low': 'Baixa'
            };
            return labels[priority] || priority;
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        },
        
        truncate(text, length) {
            if (text.length <= length) return text;
            return text.substring(0, length) + '...';
        }
    }
}
</script>
// Spinner feedback nos botões de ação
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('a[href*="create_message"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            var spinner = btn.querySelector('.loading-spinner');
            if (spinner) spinner.classList.remove('hidden');
        });
    });
    // Tooltips explicativos
    document.querySelectorAll('[data-tooltip]').forEach(function(el) {
        el.addEventListener('mouseenter', function() {
            let tip = document.createElement('div');
            tip.className = 'tooltip-box';
            tip.textContent = el.getAttribute('data-tooltip');
            document.body.appendChild(tip);
            const rect = el.getBoundingClientRect();
            tip.style.top = (rect.bottom + window.scrollY + 4) + 'px';
            tip.style.left = (rect.left + window.scrollX) + 'px';
            el._tooltip = tip;
        });
        el.addEventListener('mouseleave', function() {
            if (el._tooltip) {
                document.body.removeChild(el._tooltip);
                el._tooltip = null;
            }
        });
    });
});

// Função de alerta visual acessível
function showAlert(message, type) {
    var container = document.getElementById('alert-container');
    if (!container) return;
    var color = type === 'success' ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300';
    container.innerHTML = `<div class="border ${color} px-4 py-3 rounded relative flex items-center justify-between" role="alert">
        <span class="block font-semibold">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 text-lg font-bold text-gray-500 hover:text-gray-700" aria-label="Fechar alerta">&times;</button>
    </div>`;
    setTimeout(function() { container.innerHTML = ''; }, 5000);
}
{% endblock %}
