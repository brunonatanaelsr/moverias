{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Upload de Arquivos - Move Marias{% endblock %}

{% block breadcrumb_items %}
<!-- Add breadcrumb items here if needed -->
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
<div class="section-spacing-lg">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Upload de Arquivos</h1>
            <p class="mt-2 text-sm text-gray-600">
                Envie seus documentos de forma segura
            </p>
        </div>
        <a href="{% url 'core:upload-list' %}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-list mr-2"></i>
            Ver Arquivos
        </a>
    </div>
</div>

<!-- Área de Upload -->
<div class="bg-white rounded-lg shadow-sm border upload-form-container">
    <div class="p-6">
        <form id="upload-form" method="post" enctype="multipart/form-data" class="space-y-6" 
              data-loading-form="true" data-validation-form="true">
            {% csrf_token %}
            
            <!-- Drag & Drop Area -->
            <div id="drop-zone" class="relative border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-gray-400 transition-colors">
                <div id="drop-zone-content">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-lg font-medium text-gray-900 mb-2">
                        Arraste arquivos aqui ou clique para selecionar
                    </p>
                    <p class="text-sm text-gray-500 mb-4">
                        Tipos permitidos: PDF, DOC, DOCX, JPG, PNG, TXT, CSV
                    </p>
                    <p class="text-xs text-gray-400">
                        Tamanho máximo: 50MB
                    </p>
                </div>
                
                <!-- Hidden file input -->
                <input type="file" id="file-input" name="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple>
                
                <!-- Loading overlay -->
                <div id="upload-loading" class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center hidden">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mb-4"></div>
                        <p class="text-sm font-medium text-gray-700">Validando arquivo...</p>
                    </div>
                </div>
            </div>
            
            <!-- File Info -->
            <div id="file-info" class="hidden">
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <i id="file-icon" class="fas fa-file text-2xl text-gray-400"></i>
                        <div class="flex-1">
                            <p id="file-name" class="font-medium text-gray-900"></p>
                            <p id="file-size" class="text-sm text-gray-500"></p>
                        </div>
                        <div id="file-status" class="flex-shrink-0">
                            <span id="status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Validando...
                            </span>
                        </div>
                    </div>
                    
                    <!-- Progress bar -->
                    <div id="progress-container" class="mt-4 hidden">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progresso</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Fields -->
            <div class="grid-optimized grid-optimized-2">
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descrição
                    </label>
                    <textarea id="description" name="description" rows="3" 
                              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                              placeholder="Descreva o conteúdo do arquivo..."></textarea>
                </div>
                
                <div>
                    <label for="tags" class="block text-sm font-medium text-gray-700 mb-2">
                        Tags
                    </label>
                    <input type="text" id="tags" name="tags" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="documento, importante, reunião">
                    <p class="mt-1 text-xs text-gray-500">Separe as tags com vírgulas</p>
                </div>
            </div>
            
            <!-- Upload Button -->
            <div class="flex justify-end">
                <button type="submit" id="upload-btn" 
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed"
                        data-loading="true" 
                        data-loading-text="Enviando..."
                        data-loading-icon="fa-spinner fa-spin"
                        aria-describedby="upload-help"
                        disabled>
                    <i class="fas fa-upload mr-2"></i>
                    Enviar Arquivo
                </button>
            </div>
            
            <!-- Upload Help Text -->
            <div id="upload-help" class="text-sm text-gray-600 mt-2">
                Selecione um arquivo para habilitar o envio
            </div>
        </form>
    </div>
</div>

<!-- Upload History (últimos 5) -->
<div class="mt-8 bg-white rounded-lg shadow-sm border">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Uploads Recentes</h3>
    </div>
    <div id="recent-uploads" class="divide-y divide-gray-200">
        <!-- Will be populated by JavaScript -->
        <div class="p-6 text-center text-gray-500">
            <i class="fas fa-history text-2xl mb-2"></i>
            <p>Nenhum upload recente</p>
        </div>
    </div>
</div>

<!-- Validation Errors Modal -->
<div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                <h3 class="text-lg font-medium text-gray-900">Erro de Validação</h3>
            </div>
            <div id="error-content" class="text-sm text-gray-600 mb-6">
                <!-- Error messages will be inserted here -->
            </div>
            <div class="flex justify-end">
                <button id="error-close" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadForm = document.getElementById('upload-form');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInfo = document.getElementById('file-info');
    const uploadLoading = document.getElementById('upload-loading');
    const errorModal = document.getElementById('error-modal');
    let selectedFile = null;
    
    // Drag & Drop events
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-purple-500', 'bg-purple-50');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-purple-500', 'bg-purple-50');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-purple-500', 'bg-purple-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
    
    // Form submit
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (selectedFile) {
            uploadFile();
        }
    });
    
    function handleFileSelection(file) {
        selectedFile = file;
        showFileInfo(file);
        validateFile(file);
    }
    
    function showFileInfo(file) {
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const fileIcon = document.getElementById('file-icon');
        
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        
        // Update icon based on file type
        const extension = file.name.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'fas fa-file-pdf text-red-500',
            'doc': 'fas fa-file-word text-blue-500',
            'docx': 'fas fa-file-word text-blue-500',
            'jpg': 'fas fa-file-image text-green-500',
            'jpeg': 'fas fa-file-image text-green-500',
            'png': 'fas fa-file-image text-green-500',
            'txt': 'fas fa-file-alt text-gray-500',
            'csv': 'fas fa-file-csv text-orange-500'
        };
        
        fileIcon.className = iconMap[extension] || 'fas fa-file text-gray-400';
        fileInfo.classList.remove('hidden');
        uploadBtn.disabled = false;
    }
    
    function validateFile(file) {
        uploadLoading.classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('{% url "core:file-validate-api" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            uploadLoading.classList.add('hidden');
            
            const statusBadge = document.getElementById('status-badge');
            
            if (data.valid) {
                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                statusBadge.textContent = 'Válido';
                uploadBtn.disabled = false;
            } else {
                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                statusBadge.textContent = 'Inválido';
                uploadBtn.disabled = true;
                showErrors(data.errors);
            }
        })
        .catch(error => {
            uploadLoading.classList.add('hidden');
            console.error('Erro na validação:', error);
            showToast('Erro ao validar arquivo', 'error');
        });
    }
    
    function uploadFile() {
        const formData = new FormData(uploadForm);
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        progressContainer.classList.remove('hidden');
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
        
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total) * 100;
                progressBar.style.width = percent + '%';
                progressText.textContent = Math.round(percent) + '%';
            }
        });
        
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                
                if (response.success) {
                    showToast('Arquivo enviado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "core:upload-list" %}';
                    }, 1500);
                } else {
                    showToast(response.message || 'Erro ao enviar arquivo', 'error');
                    resetForm();
                }
            } else {
                showToast('Erro no servidor', 'error');
                resetForm();
            }
        });
        
        xhr.addEventListener('error', function() {
            showToast('Erro de conexão', 'error');
            resetForm();
        });
        
        xhr.open('POST', '{% url "core:file-upload-api" %}');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
    }
    
    function resetForm() {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Enviar Arquivo';
        document.getElementById('progress-container').classList.add('hidden');
    }
    
    function showErrors(errors) {
        const errorContent = document.getElementById('error-content');
        errorContent.innerHTML = '';
        
        errors.forEach(error => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-2 p-2 bg-red-50 border border-red-200 rounded text-red-700';
            errorDiv.textContent = error;
            errorContent.appendChild(errorDiv);
        });
        
        errorModal.classList.remove('hidden');
    }
    
    document.getElementById('error-close').addEventListener('click', function() {
        errorModal.classList.add('hidden');
    });
    
    function formatFileSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB'];
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Load recent uploads
    loadRecentUploads();
    
    function loadRecentUploads() {
        fetch('{% url "core:upload-list" %}?limit=5')
            .then(response => response.text())
            .then(html => {
                // Parse and extract recent uploads
                // This would need proper API endpoint
            })
            .catch(error => {
                console.error('Erro ao carregar uploads recentes:', error);
            });
    }
});
</script>
</div>
{% endblock %}

{% block extra_css %}
<style>
#drop-zone.dragover {
    border-color: #8B5CF6;
    background-color: #F3F4F6;
}

.file-type-icon {
    width: 24px;
    height: 24px;
}

@keyframes pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.uploading {
    animation: pulse-subtle 2s infinite;
}
</style>
{% endblock %}
