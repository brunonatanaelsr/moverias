{% extends 'base_optimized.html' %}

{% block title %}Log de Atividades - Move Marias{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard specific animations */
    .dashboard-fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    
    .dashboard-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(15px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Hover effects */
    .dashboard-card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<!-- Add breadcrumb items here if needed -->
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
    <!-- Welcome Header -->
    <div class="dashboard-header-optimized dashboard-fade-in">
        <div class="dashboard-header-content-optimized">
            <div class="dashboard-header-icon">üë§</div>
            <div class="dashboard-header-text">
                <h1>Usu√°rios</h1>
                <p>Gerencie usu√°rios e permiss√µes</p>
            </div>
        </div>
        <div class="hidden lg:block text-right">
            <div class="text-sm opacity-90">{{ "now"|date:"l, j \d\e F \d\e Y" }}</div>
            <div class="text-xl font-bold">{{ "now"|date:"H:i" }}</div>
        </div>
    </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
            <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter mr-2"></i>
                        Filtros
                    </h6>
                </div>
                <div class="card-padding-md">
                    <form method="get" class="row g-3">
                        <div class="col-md-4">
                            <label for="user" class="form-label-optimized">Usu√°rio</label>
                            <select name="user" id="user" class="form-select">
                                <option value="">Todos os usu√°rios</option>
                                {% for user in users %}
                                <option value="{{ user.pk }}" {% if request.GET.user == user.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ user.full_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="action" class="form-label-optimized">A√ß√£o</label>
                            <select name="action" id="action" class="form-select">
                                <option value="">Todas as a√ß√µes</option>
                                <option value="create" {% if request.GET.action == "create" %}selected{% endif %}>Criar</option>
                                <option value="update" {% if request.GET.action == "update" %}selected{% endif %}>Atualizar</option>
                                <option value="delete" {% if request.GET.action == "delete" %}selected{% endif %}>Excluir</option>
                                <option value="view" {% if request.GET.action == "view" %}selected{% endif %}>Visualizar</option>
                            </select>
                        </div>
                        <div class="col-md-4 flex items-end">
                            <button type="submit" class="mm-btn mm-btn-primary mr-2">
                                <i class="fas fa-search mr-1"></i>
                                Filtrar
                            </button>
                            <a href="{% url 'users:activity_list' %}" class="mm-btn mm-btn-outline-secondary">
                                <i class="fas fa-times mr-1"></i>
                                Limpar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities -->
    <div class="grid-optimized grid-optimized-2">
        <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list mr-2"></i>
                        Atividades Registradas
                    </h5>
                </div>
                <div class="card-padding-md">
                    {% if activities %}
                        <div class="table-container-optimized">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="180">Data/Hora</th>
                                        <th width="200">Usu√°rio</th>
                                        <th width="100">A√ß√£o</th>
                                        <th>Descri√ß√£o</th>
                                        <th width="120">IP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in activities %}
                                    <tr>
                                        <td class="text-nowrap">
                                            <i class="fas fa-clock text-gray-600 mr-1"></i>
                                            {{ activity.timestamp|date:"d/m/Y H:i:s" }}
                                        </td>
                                        <td>
                                            <div class="flex items-center">
                                                <div class="bg-primary rounded-full flex items-center justify-center mr-2"
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user fa-sm text-white"></i>
                                                </div>
                                                <div>
                                                    <div class="font-bold">{{ activity.user.full_name }}</div>
                                                    <text-sm class="text-gray-600">{{ activity.user.get_role_display }}</text-sm>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="mm-badge mm-badge-{% if activity.action == 'create' %}success{% elif activity.action == 'update' %}warning{% elif activity.action == 'delete' %}danger{% else %}info{% endif %}">
                                                <i class="fas fa-{% if activity.action == 'create' %}plus{% elif activity.action == 'update' %}edit{% elif activity.action == 'delete' %}trash{% else %}eye{% endif %} mr-1"></i>
                                                {{ activity.get_action_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 400px;" title="{{ activity.description }}">
                                                {{ activity.description }}
                                            </div>
                                        </td>
                                        <td class="text-gray-600">
                                            <i class="fas fa-globe mr-1"></i>
                                            {{ activity.ip_address|default:"-" }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if is_paginated %}
                        <nav aria-label="Navega√ß√£o das atividades">
                            <ul class="pagination justify-center mt-4">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}

                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-history fa-3x text-gray-600 mb-3"></i>
                            <h5 class="text-gray-600">Nenhuma atividade encontrada</h5>
                            <p class="text-gray-600">
                                {% if request.GET.user or request.GET.action %}
                                    Nenhuma atividade corresponde aos filtros selecionados.
                                {% else %}
                                    As atividades dos usu√°rios aparecer√£o aqui conforme o sistema for utilizado.
                                {% endif %}
                            </p>
                            {% if request.GET.user or request.GET.action %}
                            <a href="{% url 'users:activity_list' %}" class="mm-btn mm-btn-outline-primary">
                                <i class="fas fa-eye mr-1"></i>
                                Ver Todas as Atividades
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    {% if activities %}
    <div class="row mt-4">
        <div class="card-optimized card-padding-md" dashboard-card-hover dashboard-slide-up>
            <div class="card bg-light">
                <div class="card-padding-md border-b">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Estat√≠sticas R√°pidas
                    </h6>
                </div>
                <div class="card-padding-md">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="bg-success text-white rounded p-3">
                                <i class="fas fa-plus fa-2x mb-2"></i>
                                <div class="h4 mb-0">{{ activities|length }}</div>
                                <text-sm>Total de Atividades</text-sm>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-info text-white rounded p-3">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <div class="h4 mb-0">{{ unique_users_count }}</div>
                                <text-sm>Usu√°rios Ativos</text-sm>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-warning text-white rounded p-3">
                                <i class="fas fa-calendar fa-2x mb-2"></i>
                                <div class="h4 mb-0">Hoje</div>
                                <text-sm>Per√≠odo Atual</text-sm>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-primary text-white rounded p-3">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <div class="h4 mb-0">{{ activities.0.timestamp|date:"H:i" }}</div>
                                <text-sm>√öltima Atividade</text-sm>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
</div>
{% endblock %}
