{% extends 'dashboard_base.html' %}
{% load crispy_forms_tags %}

{% block title %}Permissões do Usuário {{ user_obj.full_name }} - Move Marias{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{% url 'users:user_detail' user_obj.pk %}" class="text-purple-600 hover:text-purple-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Permissões do Usuário</h1>
                    <p class="mt-1 text-sm text-gray-600">{{ user_obj.full_name }} ({{ user_obj.email }})</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button type="button" onclick="savePermissions()" 
                        class="inline-flex items-center px-4 py-2 bg-purple-600 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-purple-700">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 12.75l6 6 9-13.5"></path>
                    </svg>
                    Salvar Alterações
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Informações do Usuário -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Informações</h3>
                </div>
                <div class="border-t border-gray-200">
                    <dl>
                        <div class="bg-gray-50 px-4 py-5">
                            <dt class="text-sm font-medium text-gray-500">Função</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if user_obj.role == 'admin' %}bg-red-100 text-red-800
                                {% elif user_obj.role == 'coordenador' %}bg-purple-100 text-purple-800
                                {% elif user_obj.role == 'tecnico' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ user_obj.get_role_display }}
                                </span>
                            </dd>
                        </div>
                        <div class="bg-white px-4 py-5">
                            <dt class="text-sm font-medium text-gray-500">Status</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if user_obj.is_active %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    Ativo
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    Inativo
                                </span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="bg-gray-50 px-4 py-5">
                            <dt class="text-sm font-medium text-gray-500">Grupos</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% for group in user_obj.groups.all %}
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-1 mb-1">
                                        {{ group.name }}
                                    </span>
                                {% empty %}
                                    <span class="text-gray-400">Nenhum grupo</span>
                                {% endfor %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- Resumo de Permissões -->
            <div class="mt-6 bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Resumo</h3>
                </div>
                <div class="border-t border-gray-200 px-4 py-5">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Permissões Diretas</span>
                            <span id="direct-permissions-count" class="text-sm font-medium text-gray-900">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Permissões por Grupos</span>
                            <span id="group-permissions-count" class="text-sm font-medium text-gray-900">{{ group_permissions_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-500">Total de Permissões</span>
                            <span id="total-permissions-count" class="text-sm font-medium text-purple-600">{{ total_permissions }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Permissões -->
        <div class="lg:col-span-3">
            <form id="permissions-form" method="post">
                {% csrf_token %}
                
                <!-- Tabs -->
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                            <button type="button" onclick="showTab('direct')" 
                                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm active">
                                Permissões Diretas
                            </button>
                            <button type="button" onclick="showTab('groups')" 
                                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Gerenciar Grupos
                            </button>
                        </nav>
                    </div>

                    <!-- Permissões Diretas -->
                    <div id="direct-tab" class="tab-content p-6">
                        <div class="mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Permissões Diretas do Usuário</h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Selecione permissões específicas para este usuário. Estas permissões são aplicadas diretamente, independente dos grupos.
                            </p>
                        </div>

                        <!-- Filtro de Permissões -->
                        <div class="mb-6">
                            <div class="flex space-x-4">
                                <div class="flex-1">
                                    <input type="text" id="permission-search" placeholder="Buscar permissões..." 
                                           class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                           onkeyup="filterPermissions()">
                                </div>
                                <div>
                                    <select id="app-filter" onchange="filterPermissions()" 
                                            class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                        <option value="">Todos os Apps</option>
                                        {% for app in available_apps %}
                                        <option value="{{ app }}">{{ app|capfirst }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Permissões por App -->
                        {% for app, permissions in permissions_by_app.items %}
                        <div class="permission-app mb-6" data-app="{{ app }}">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-md font-medium text-gray-900">{{ app|capfirst }}</h4>
                                    <div class="flex space-x-2">
                                        <button type="button" onclick="selectAllInApp('{{ app }}')" 
                                                class="text-xs text-purple-600 hover:text-purple-800">Selecionar Todos</button>
                                        <button type="button" onclick="deselectAllInApp('{{ app }}')" 
                                                class="text-xs text-gray-600 hover:text-gray-800">Desmarcar Todos</button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {% for permission in permissions %}
                                <div class="permission-item flex items-center">
                                    <input type="checkbox" id="perm_{{ permission.id }}" name="user_permissions" value="{{ permission.id }}"
                                           {% if permission.id in user_permissions_ids %}checked{% endif %}
                                           class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300 rounded"
                                           onchange="updatePermissionCount()">
                                    <label for="perm_{{ permission.id }}" class="ml-2 block text-sm text-gray-900">
                                        <span class="font-medium">{{ permission.name }}</span>
                                        <span class="text-gray-500 block text-xs">{{ permission.codename }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Gerenciar Grupos -->
                    <div id="groups-tab" class="tab-content p-6 hidden">
                        <div class="mb-6">
                            <h3 class="text-lg font-medium text-gray-900">Grupos do Usuário</h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Adicione ou remova o usuário de grupos. Os grupos fornecem conjuntos de permissões pré-definidas.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for group in all_groups %}
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" id="group_{{ group.id }}" name="groups" value="{{ group.id }}"
                                               {% if group in user_obj.groups.all %}checked{% endif %}
                                               class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300 rounded">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="group_{{ group.id }}" class="font-medium text-gray-900">{{ group.name }}</label>
                                        <p class="text-gray-500">{{ group.permissions.count }} permissões</p>
                                        <div class="mt-2">
                                            <button type="button" onclick="toggleGroupPermissions({{ group.id }})" 
                                                    class="text-xs text-purple-600 hover:text-purple-800">
                                                Ver permissões
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Permissões do Grupo (inicialmente ocultas) -->
                                <div id="group-permissions-{{ group.id }}" class="mt-3 hidden">
                                    <div class="text-xs text-gray-600 space-y-1">
                                        {% for perm in group.permissions.all|slice:":5" %}
                                        <div>• {{ perm.name }}</div>
                                        {% endfor %}
                                        {% if group.permissions.count > 5 %}
                                        <div class="text-gray-400">E mais {{ group.permissions.count|add:"-5" }} permissões...</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                        <div class="flex justify-end space-x-3">
                            <a href="{% url 'users:user_detail' user_obj.pk %}" 
                               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Cancelar
                            </a>
                            <button type="submit" 
                                    class="inline-flex items-center px-4 py-2 bg-purple-600 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-purple-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 12.75l6 6 9-13.5"></path>
                                </svg>
                                Salvar Permissões
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Controle de Tabs
function showTab(tabName) {
    // Esconder todas as tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-purple-500', 'text-purple-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Mostrar tab selecionada
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    
    // Ativar botão da tab
    event.currentTarget.classList.remove('border-transparent', 'text-gray-500');
    event.currentTarget.classList.add('border-purple-500', 'text-purple-600');
}

// Filtrar permissões
function filterPermissions() {
    const searchTerm = document.getElementById('permission-search').value.toLowerCase();
    const appFilter = document.getElementById('app-filter').value;
    
    document.querySelectorAll('.permission-app').forEach(appDiv => {
        const appName = appDiv.dataset.app;
        let appVisible = false;
        
        if (appFilter && appName !== appFilter) {
            appDiv.style.display = 'none';
            return;
        }
        
        appDiv.querySelectorAll('.permission-item').forEach(item => {
            const label = item.querySelector('label').textContent.toLowerCase();
            const visible = !searchTerm || label.includes(searchTerm);
            
            item.style.display = visible ? 'flex' : 'none';
            if (visible) appVisible = true;
        });
        
        appDiv.style.display = appVisible ? 'block' : 'none';
    });
}

// Selecionar todas as permissões de um app
function selectAllInApp(appName) {
    document.querySelectorAll(`[data-app="${appName}"] input[type="checkbox"]`).forEach(checkbox => {
        checkbox.checked = true;
    });
    updatePermissionCount();
}

// Desmarcar todas as permissões de um app
function deselectAllInApp(appName) {
    document.querySelectorAll(`[data-app="${appName}"] input[type="checkbox"]`).forEach(checkbox => {
        checkbox.checked = false;
    });
    updatePermissionCount();
}

// Atualizar contador de permissões
function updatePermissionCount() {
    const directPermissions = document.querySelectorAll('input[name="user_permissions"]:checked').length;
    document.getElementById('direct-permissions-count').textContent = directPermissions;
    
    const groupPermissions = {{ group_permissions_count }};
    const total = directPermissions + groupPermissions;
    document.getElementById('total-permissions-count').textContent = total;
}

// Toggle permissões do grupo
function toggleGroupPermissions(groupId) {
    const element = document.getElementById(`group-permissions-${groupId}`);
    element.classList.toggle('hidden');
}

// Salvar permissões via AJAX
function savePermissions() {
    const form = document.getElementById('permissions-form');
    const formData = new FormData(form);
    
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensagem de sucesso
            showNotification('Permissões atualizadas com sucesso!', 'success');
        } else {
            showNotification('Erro ao atualizar permissões.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Erro ao atualizar permissões.', 'error');
    });
}

// Mostrar notificação
function showNotification(message, type) {
    // Criar elemento de notificação
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="${type === 'success' ? 
                        'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' : 
                        'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z'
                    }" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium">${message}</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remover após 3 segundos
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Inicializar contador
document.addEventListener('DOMContentLoaded', function() {
    updatePermissionCount();
});
</script>
{% endblock %}
