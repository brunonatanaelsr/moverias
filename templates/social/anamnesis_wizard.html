{% extends 'dashboard_base.html' %}
{% load crispy_forms_tags %}

{% block title %}Nova Anamnese Social - Move Marias{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
        padding-bottom: 2rem;
    }
    .step {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 1rem;
        font-size: 18px;
        position: relative;
    }
    .step.active {
        background-color: #8B5CF6;
        color: white;
    }
    .step.completed {
        background-color: #10B981;
        color: white;
    }
    .step.inactive {
        background-color: #E5E7EB;
        color: #6B7280;
    }
    .step-connector {
        width: 60px;
        height: 2px;
        background-color: #E5E7EB;
        margin-top: 24px;
    }
    .step-connector.completed {
        background-color: #10B981;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Nova Anamnese Social</h1>
                <p class="mt-2 text-sm text-gray-600">
                    Preencha as informa√ß√µes sociais da benefici√°ria em 3 etapas
                </p>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium text-gray-500 mb-1">Progresso</div>
                <div class="flex items-center space-x-2">
                    <div class="bg-gray-200 rounded-full h-2 w-24">
                        <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" 
                             style="width: {% if wizard.steps.current == 'step1' %}33%{% elif wizard.steps.current == 'step2' %}67%{% else %}100%{% endif %}"></div>
                    </div>
                    <span class="text-sm font-semibold text-gray-700">
                        {% if wizard.steps.current == 'step1' %}1{% elif wizard.steps.current == 'step2' %}2{% else %}3{% endif %}/3
                    </span>
                </div>
            </div>
            <a href="{% url 'dashboard:beneficiaries_list' %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                ‚Üê Voltar
            </a>
        </div>
    </div>

    <!-- Step Indicator with Enhanced Tooltips -->
    <div class="step-indicator mb-8">
        <div class="step {% if wizard.steps.current == 'step1' %}active{% elif wizard.steps.step1 in wizard.steps.prev %}completed{% else %}inactive{% endif %}" 
             title="Etapa 1: Dados Familiares - Composi√ß√£o familiar e renda">
            üë®‚Äçüë©‚Äçüëß‚Äçüë¶
            <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-medium text-gray-600">
                Fam√≠lia
            </div>
        </div>
        <div class="step-connector {% if wizard.steps.step1 in wizard.steps.prev %}completed{% endif %}"></div>
        <div class="step {% if wizard.steps.current == 'step2' %}active{% elif wizard.steps.step2 in wizard.steps.prev %}completed{% else %}inactive{% endif %}"
             title="Etapa 2: Vulnerabilidades - Riscos e situa√ß√µes de vulnerabilidade">
            ‚ö†Ô∏è
            <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-medium text-gray-600">
                Riscos
            </div>
        </div>
        <div class="step-connector {% if wizard.steps.step2 in wizard.steps.prev %}completed{% endif %}"></div>
        <div class="step {% if wizard.steps.current == 'step3' %}active{% elif wizard.steps.step3 in wizard.steps.prev %}completed{% else %}inactive{% endif %}"
             title="Etapa 3: Finaliza√ß√£o - Observa√ß√µes gerais e assinatura">
            üìù
            <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 text-xs font-medium text-gray-600">
                Finalizar
            </div>
        </div>
    </div>

    <!-- Step Titles with Visual Cards -->
    <div class="mb-8">
        {% if wizard.steps.current == 'step1' %}
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 text-center">
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-blue-100 rounded-full p-3">
                        <span class="text-2xl">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-blue-900 mb-2">Dados Familiares</h2>
                <p class="text-blue-700 mb-3">Primeira etapa da anamnese social</p>
                <div class="bg-white bg-opacity-70 rounded-md p-3">
                    <p class="text-sm text-blue-800">
                        üìã <strong>Colete informa√ß√µes sobre:</strong><br>
                        ‚Ä¢ Composi√ß√£o da fam√≠lia e parentesco<br>
                        ‚Ä¢ Idades e ocupa√ß√µes dos membros<br>
                        ‚Ä¢ Renda familiar total<br>
                        ‚Ä¢ Situa√ß√£o habitacional
                    </p>
                </div>
            </div>
        {% elif wizard.steps.current == 'step2' %}
            <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-6 text-center">
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-orange-100 rounded-full p-3">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-orange-900 mb-2">Vulnerabilidades e Riscos</h2>
                <p class="text-orange-700 mb-3">Segunda etapa da anamnese social</p>
                <div class="bg-white bg-opacity-70 rounded-md p-3">
                    <p class="text-sm text-orange-800">
                        üîç <strong>Identifique e documente:</strong><br>
                        ‚Ä¢ Situa√ß√µes de viol√™ncia ou abuso<br>
                        ‚Ä¢ Problemas de sa√∫de f√≠sica ou mental<br>
                        ‚Ä¢ Uso de subst√¢ncias (√°lcool/drogas)<br>
                        ‚Ä¢ Desemprego ou instabilidade financeira
                    </p>
                </div>
            </div>
        {% elif wizard.steps.current == 'step3' %}
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6 text-center">
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-green-100 rounded-full p-3">
                        <span class="text-2xl">üìù</span>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-green-900 mb-2">Observa√ß√µes e Finaliza√ß√£o</h2>
                <p class="text-green-700 mb-3">Terceira e √∫ltima etapa da anamnese</p>
                <div class="bg-white bg-opacity-70 rounded-md p-3">
                    <p class="text-sm text-green-800">
                        ‚úÖ <strong>Complete a anamnese com:</strong><br>
                        ‚Ä¢ Observa√ß√µes gerais importantes<br>
                        ‚Ä¢ Informa√ß√µes complementares<br>
                        ‚Ä¢ Confirma√ß√£o da benefici√°ria<br>
                        ‚Ä¢ Assinatura digital do documento
                    </p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ wizard.management_form }}
            
            {% if wizard.form.forms %}
                {{ wizard.form|crispy }}
            {% else %}
                {% if wizard.steps.current == 'step1' %}
                    <div class="space-y-6">
                        <div>
                            <label for="id_step1-beneficiary" class="block text-sm font-medium text-gray-700 mb-2">
                                Benefici√°ria *
                            </label>
                            {{ form.beneficiary }}
                            {% if form.beneficiary.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.beneficiary.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="id_step1-family_composition" class="block text-sm font-medium text-gray-700 mb-2">
                                Composi√ß√£o Familiar *
                            </label>
                            <textarea name="step1-family_composition" 
                                      id="id_step1-family_composition"
                                      rows="4" 
                                      required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-move focus:border-purple-move"
                                      placeholder="Descreva a composi√ß√£o familiar (membros da fam√≠lia, idades, ocupa√ß√µes, etc.)">{{ form.family_composition.value|default:'' }}</textarea>
                            {% if form.family_composition.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.family_composition.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="id_step1-income" class="block text-sm font-medium text-gray-700 mb-2">
                                Renda Familiar (R$)
                            </label>
                            <input type="number" 
                                   name="step1-income" 
                                   id="id_step1-income"
                                   step="0.01" 
                                   min="0"
                                   value="{{ form.income.value|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-move focus:border-purple-move"
                                   placeholder="0.00">
                            {% if form.income.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.income.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% elif wizard.steps.current == 'step2' %}
                    <div class="space-y-6">
                        <div>
                            <label for="id_step2-vulnerabilities" class="block text-sm font-medium text-gray-700 mb-2">
                                Vulnerabilidades Identificadas *
                            </label>
                            <textarea name="step2-vulnerabilities" 
                                      id="id_step2-vulnerabilities"
                                      rows="6" 
                                      required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-move focus:border-purple-move"
                                      placeholder="Descreva as vulnerabilidades sociais identificadas (viol√™ncia dom√©stica, desemprego, problemas de sa√∫de, etc.)">{{ form.vulnerabilities.value|default:'' }}</textarea>
                            {% if form.vulnerabilities.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.vulnerabilities.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="id_step2-substance_use" class="block text-sm font-medium text-gray-700 mb-2">
                                Uso de Subst√¢ncias
                            </label>
                            <textarea name="step2-substance_use" 
                                      id="id_step2-substance_use"
                                      rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-move focus:border-purple-move"
                                      placeholder="Informa√ß√µes sobre uso de √°lcool, drogas ou outras subst√¢ncias (opcional)">{{ form.substance_use.value|default:'' }}</textarea>
                            {% if form.substance_use.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.substance_use.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% elif wizard.steps.current == 'step3' %}
                    <div class="space-y-6">
                        <div>
                            <label for="id_step3-observations" class="block text-sm font-medium text-gray-700 mb-2">
                                Observa√ß√µes Gerais
                            </label>
                            <textarea name="step3-observations" 
                                      id="id_step3-observations"
                                      rows="6"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-move focus:border-purple-move"
                                      placeholder="Outras observa√ß√µes importantes sobre a situa√ß√£o social da benefici√°ria">{{ form.observations.value|default:'' }}</textarea>
                            {% if form.observations.errors %}
                                <div class="mt-1 text-sm text-red-600">
                                    {{ form.observations.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   name="step3-signed_by_beneficiary" 
                                   id="id_step3-signed_by_beneficiary"
                                   {% if form.signed_by_beneficiary.value %}checked{% endif %}
                                   class="h-4 w-4 text-purple-move focus:ring-purple-move border-gray-300 rounded">
                            <label for="id_step3-signed_by_beneficiary" class="ml-2 block text-sm text-gray-900">
                                Benefici√°ria assinou e concordou com as informa√ß√µes
                            </label>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            
            <!-- Enhanced Navigation Buttons -->
            <div class="mt-8 flex justify-between items-center">
                {% if wizard.steps.prev %}
                    <button name="wizard_goto_step" 
                            value="{{ wizard.steps.prev }}" 
                            type="submit"
                            class="inline-flex items-center px-6 py-3 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 shadow-sm transition-all duration-200">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Etapa Anterior
                    </button>
                {% else %}
                    <div class="text-sm text-gray-500 italic">Primeira etapa</div>
                {% endif %}
                
                <div class="flex items-center space-x-4">
                    <!-- Progress Summary -->
                    <div class="text-center px-4">
                        <div class="text-xs text-gray-500 mb-1">Progresso</div>
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 rounded-full {% if wizard.steps.current == 'step1' or wizard.steps.step1 in wizard.steps.prev %}bg-green-500{% else %}bg-gray-300{% endif %}"></div>
                            <div class="w-2 h-2 rounded-full {% if wizard.steps.current == 'step2' or wizard.steps.step2 in wizard.steps.prev %}bg-green-500{% else %}bg-gray-300{% endif %}"></div>
                            <div class="w-2 h-2 rounded-full {% if wizard.steps.current == 'step3' or wizard.steps.step3 in wizard.steps.prev %}bg-green-500{% else %}bg-gray-300{% endif %}"></div>
                        </div>
                    </div>
                    
                    {% if wizard.steps.next %}
                        <button type="submit" 
                                class="inline-flex items-center px-8 py-3 border border-transparent text-sm font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 shadow-lg transition-all duration-200 transform hover:scale-105">
                            Pr√≥xima Etapa
                            <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    {% else %}
                        <button type="submit" 
                                class="inline-flex items-center px-8 py-3 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 shadow-lg transition-all duration-200 transform hover:scale-105">
                            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Finalizar Anamnese
                        </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
