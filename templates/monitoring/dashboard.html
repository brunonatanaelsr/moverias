{% extends 'base_modern.html' %}
{% load static %}
{% load assets %}

{% block title %}System Monitoring - Move Marias{% endblock %}

{% block extra_css %}
<!-- Chart.js para grÃ¡ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block breadcrumb_items %}
<!-- Add breadcrumb items here if needed -->
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
<div class="monitoring-dashboard">
    <!-- Header -->
    <div class="header-section">
        <h1 class="page-title">System Monitoring</h1>
        <div class="header-actions">
            <button id="refreshBtn" class="btn-primary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <a href="{% url 'monitoring_config' %}" class="btn-secondary">
                <i class="fas fa-cog"></i> Configuration
            </a>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="status-cards">
        <div class="status-card" id="systemCard">
            <div class="card-padding-md border-b">
                <h3>System Health</h3>
                <div class="status-indicator" id="systemStatus"></div>
            </div>
            <div class="card-content">
                <div class="metric">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value" id="cpuValue">{{ system_health.data.cpu_percent|default:0 }}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value" id="memoryValue">{{ system_health.data.memory_percent|default:0 }}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Disk Usage</span>
                    <span class="metric-value" id="diskValue">{{ system_health.data.disk_percent|default:0 }}%</span>
                </div>
            </div>
        </div>

        <div class="status-card" id="databaseCard">
            <div class="card-padding-md border-b">
                <h3>Database Health</h3>
                <div class="status-indicator" id="databaseStatus"></div>
            </div>
            <div class="card-content">
                <div class="metric">
                    <span class="metric-label">Connection</span>
                    <span class="metric-value" id="dbConnection">
                        {% if database_health.healthy %}Healthy{% else %}Unhealthy{% endif %}
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Query Time</span>
                    <span class="metric-value" id="dbQueryTime">
                        {{ database_health.query_time|default:0|floatformat:3 }}s
                    </span>
                </div>
            </div>
        </div>

        {% if background_jobs_available %}
        <div class="status-card" id="jobsCard">
            <div class="card-padding-md border-b">
                <h3>Background Jobs</h3>
                <div class="status-indicator" id="jobsStatus"></div>
            </div>
            <div class="card-content">
                <div class="metric">
                    <span class="metric-label">Total Jobs</span>
                    <span class="metric-value" id="totalJobs">{{ job_stats.total_jobs|default:0 }}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Running</span>
                    <span class="metric-value" id="runningJobs">{{ job_stats.running_jobs|default:0 }}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Queue Size</span>
                    <span class="metric-value" id="queueSize">{{ job_stats.queue_size|default:0 }}</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Alerts Section -->
    <div class="alerts-section" id="alertsSection">
        <h2>Active Alerts</h2>
        <div id="alertsContainer">
            <!-- Alerts will be populated by JavaScript -->
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>System Resource Usage</h3>
            <canvas id="resourceChart"></canvas>
        </div>
        
        {% if background_jobs_available %}
        <div class="chart-container">
            <h3>Background Jobs Status</h3>
            <canvas id="jobsChart"></canvas>
        </div>
        {% endif %}
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
        <h2>Recent Activity</h2>
        <div id="activityContainer">
            <!-- Activity will be populated by JavaScript -->
        </div>
    </div>
</div>

<style>
.monitoring-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.status-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.status-card {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.card-header h3 {
    margin: 0;
    color: var(--text-purple-move);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--success-color);
}

.status-indicator.warning {
    background: var(--warning-color);
}

.status-indicator.error {
    background: var(--error-color);
}

.metric {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.metric-label {
    color: var(--text-gray-600);
}

.metric-value {
    font-weight: 600;
    color: var(--text-purple-move);
}

.alerts-section {
    margin-bottom: 30px;
}

.alert-item {
    background: var(--warning-bg);
    border: 1px solid var(--warning-border);
    border-radius: var(--border-radius);
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.alert-item.critical {
    background: var(--error-bg);
    border-color: var(--error-border);
}

.alert-message {
    color: var(--text-purple-move);
}

.alert-time {
    color: var(--text-gray-600);
    font-size: 0.9em;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.chart-container h3 {
    margin-bottom: 15px;
    color: var(--text-purple-move);
}

.activity-section {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.activity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-description {
    color: var(--text-purple-move);
}

.activity-time {
    color: var(--text-gray-600);
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .header-section {
        flex-direction: column;
        gap: 15px;
    }
    
    .status-cards {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Monitoring dashboard JavaScript
class MonitoringDashboard {
    constructor() {
        this.refreshInterval = 30000; // 30 seconds
        this.resourceChart = null;
        this.jobsChart = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.initCharts();
        this.loadInitialData();
        this.startAutoRefresh();
    }

    setupEventListeners() {
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.refreshData();
        });
    }

    initCharts() {
        // Resource usage chart
        const resourceCtx = document.getElementById('resourceChart').getContext('2d');
        this.resourceChart = new Chart(resourceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'CPU %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'Memory %',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'Disk %',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.1)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // Jobs chart (if available)
        {% if background_jobs_available %}
        const jobsCtx = document.getElementById('jobsChart').getContext('2d');
        this.jobsChart = new Chart(jobsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Running', 'Failed', 'Pending'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 205, 86, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true
            }
        });
        {% endif %}
    }

    loadInitialData() {
        this.refreshData();
    }

    async refreshData() {
        try {
            const response = await fetch('/api/monitoring/health/');
            const data = await response.json();
            
            this.updateSystemStatus(data.system);
            this.updateDatabaseStatus(data.database);
            this.updateCharts(data);
            
            {% if background_jobs_available %}
            // Update jobs if available
            const jobsResponse = await fetch('/api/monitoring/jobs/');
            const jobsData = await jobsResponse.json();
            this.updateJobsStatus(jobsData);
            {% endif %}
            
        } catch (error) {
            console.error('Error refreshing monitoring data:', error);
        }
    }

    updateSystemStatus(systemData) {
        const statusEl = document.getElementById('systemStatus');
        const cpuEl = document.getElementById('cpuValue');
        const memoryEl = document.getElementById('memoryValue');
        const diskEl = document.getElementById('diskValue');
        
        if (systemData.status === 'healthy') {
            statusEl.className = 'status-indicator';
        } else if (systemData.status === 'warning') {
            statusEl.className = 'status-indicator warning';
        } else {
            statusEl.className = 'status-indicator error';
        }
        
        if (systemData.data) {
            cpuEl.textContent = `${systemData.data.cpu_percent || 0}%`;
            memoryEl.textContent = `${systemData.data.memory_percent || 0}%`;
            diskEl.textContent = `${systemData.data.disk_percent || 0}%`;
        }
        
        // Update alerts
        this.updateAlerts(systemData.alerts || []);
    }

    updateDatabaseStatus(databaseData) {
        const statusEl = document.getElementById('databaseStatus');
        const connectionEl = document.getElementById('dbConnection');
        const queryTimeEl = document.getElementById('dbQueryTime');
        
        if (databaseData.healthy) {
            statusEl.className = 'status-indicator';
            connectionEl.textContent = 'Healthy';
        } else {
            statusEl.className = 'status-indicator error';
            connectionEl.textContent = 'Unhealthy';
        }
        
        if (databaseData.query_time !== undefined) {
            queryTimeEl.textContent = `${databaseData.query_time.toFixed(3)}s`;
        }
    }

    updateJobsStatus(jobsData) {
        const statusEl = document.getElementById('jobsStatus');
        const totalEl = document.getElementById('totalJobs');
        const runningEl = document.getElementById('runningJobs');
        const queueEl = document.getElementById('queueSize');
        
        if (jobsData.stats) {
            totalEl.textContent = jobsData.stats.total_jobs || 0;
            runningEl.textContent = jobsData.stats.running_jobs || 0;
            queueEl.textContent = jobsData.stats.queue_size || 0;
            
            // Update jobs chart
            if (this.jobsChart && jobsData.stats.status_counts) {
                const counts = jobsData.stats.status_counts;
                this.jobsChart.data.datasets[0].data = [
                    counts.completed || 0,
                    counts.running || 0,
                    counts.failed || 0,
                    counts.pending || 0
                ];
                this.jobsChart.update();
            }
        }
    }

    updateAlerts(alerts) {
        const alertsContainer = document.getElementById('alertsContainer');
        
        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<p class="text-gray-600">No active alerts</p>';
            return;
        }
        
        alertsContainer.innerHTML = alerts.map(alert => `
            <div class="alert-item ${alert.severity}">
                <span class="alert-message">${alert.message}</span>
                <span class="alert-time">${alert.type}</span>
            </div>
        `).join('');
    }

    updateCharts(data) {
        // Update resource chart with latest data
        if (this.resourceChart && data.system.data) {
            const now = new Date().toLocaleTimeString();
            const systemData = data.system.data;
            
            // Add new data point
            this.resourceChart.data.labels.push(now);
            this.resourceChart.data.datasets[0].data.push(systemData.cpu_percent || 0);
            this.resourceChart.data.datasets[1].data.push(systemData.memory_percent || 0);
            this.resourceChart.data.datasets[2].data.push(systemData.disk_percent || 0);
            
            // Keep only last 20 data points
            if (this.resourceChart.data.labels.length > 20) {
                this.resourceChart.data.labels.shift();
                this.resourceChart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            this.resourceChart.update();
        }
    }

    startAutoRefresh() {
        setInterval(() => {
            this.refreshData();
        }, this.refreshInterval);
    }
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new MonitoringDashboard();
});
</script>
</div>
{% endblock %}
