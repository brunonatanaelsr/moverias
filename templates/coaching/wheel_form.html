{% extends "layouts/base.html" %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}Editar Roda da Vida{% else %}Nova Roda da Vida{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
<style>
    /* Dashboard specific animations */
    .dashboard-fade-in {
        animation: fadeIn 0.4s ease-out;
    }
    
    .dashboard-slide-up {
        animation: slideUp 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(15px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Hover effects */
    .dashboard-card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Slider customization */
    .noUi-connect {
        background: #E91E63;
    }
    .noUi-handle {
        background: #E91E63;
        border-radius: 50%;
        box-shadow: none;
        border: 2px solid #fff;
    }
    .noUi-handle:before,
    .noUi-handle:after {
        display: none;
    }
    .wheel-area {
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container-optimized">
    <div class="bg-white shadow-sm rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        {% if object %}
                            Editar Roda da Vida
                        {% else %}
                            Nova Roda da Vida
                        {% endif %}
                    </h1>
                    {% if object %}
                        <p class="mt-1 text-sm text-gray-500">
                            Beneficiária: {{ object.beneficiary.full_name }}
                        </p>
                    {% endif %}
                </div>
                <a href="{% url 'coaching:wheel-list' %}" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Voltar
                </a>
            </div>
        </div>

        <div class="px-6 py-6">
            <form method="post" class="space-y-8">
                {% csrf_token %}
                
                <!-- Dados Básicos -->
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <div>
                        {{ form.beneficiary|as_crispy_field }}
                    </div>
                    <div>
                        {{ form.date|as_crispy_field }}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Áreas da Roda da Vida (Coluna 1) -->
                    <div class="space-y-6">
                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Família</label>
                            <div id="slider-family" class="mb-1"></div>
                            {{ form.family }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Finanças</label>
                            <div id="slider-finance" class="mb-1"></div>
                            {{ form.finance }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Saúde</label>
                            <div id="slider-health" class="mb-1"></div>
                            {{ form.health }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carreira</label>
                            <div id="slider-career" class="mb-1"></div>
                            {{ form.career }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Relacionamentos</label>
                            <div id="slider-relationships" class="mb-1"></div>
                            {{ form.relationships }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Crescimento Pessoal</label>
                            <div id="slider-personal_growth" class="mb-1"></div>
                            {{ form.personal_growth }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>
                    </div>

                    <!-- Áreas da Roda da Vida (Coluna 2) -->
                    <div class="space-y-6">
                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lazer</label>
                            <div id="slider-leisure" class="mb-1"></div>
                            {{ form.leisure }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Espiritualidade</label>
                            <div id="slider-spirituality" class="mb-1"></div>
                            {{ form.spirituality }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Educação</label>
                            <div id="slider-education" class="mb-1"></div>
                            {{ form.education }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ambiente</label>
                            <div id="slider-environment" class="mb-1"></div>
                            {{ form.environment }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contribuição</label>
                            <div id="slider-contribution" class="mb-1"></div>
                            {{ form.contribution }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>

                        <div class="wheel-area">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Emoções</label>
                            <div id="slider-emotions" class="mb-1"></div>
                            {{ form.emotions }}
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>10</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualização da Roda -->
                <div class="mt-8 pt-8 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Visualização da Roda da Vida</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <canvas id="wheelChart" width="400" height="400"></canvas>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="mt-8 pt-8 border-t border-gray-200 flex justify-end space-x-3">
                    <a href="{% url 'coaching:wheel-list' %}" 
                       class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        {% if object %}
                            Atualizar Roda
                        {% else %}
                            Criar Roda
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuração dos sliders
    const areas = [
        'family', 'finance', 'health', 'career', 'relationships', 'personal_growth',
        'leisure', 'spirituality', 'education', 'environment', 'contribution', 'emotions'
    ];

    const sliderConfig = {
        start: [5],
        connect: [true, false],
        step: 0.5,
        range: {
            'min': 0,
            'max': 10
        }
    };

    // Inicializar sliders
    areas.forEach(area => {
        const slider = document.getElementById(`slider-${area}`);
        const input = document.getElementById(`id_${area}`);
        
        if (slider && input) {
            noUiSlider.create(slider, {
                ...sliderConfig,
                start: [input.value || 5]
            });

            // Atualizar input quando o slider muda
            slider.noUiSlider.on('update', function(values, handle) {
                input.value = values[handle];
                updateChart();
            });

            // Atualizar slider quando o input muda
            input.addEventListener('change', function() {
                slider.noUiSlider.set(this.value);
            });
        }
    });

    // Configuração e atualização do gráfico
    const ctx = document.getElementById('wheelChart').getContext('2d');
    let wheelChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: [
                'Família', 'Finanças', 'Saúde', 'Carreira', 'Relacionamentos',
                'Crescimento Pessoal', 'Lazer', 'Espiritualidade', 'Educação',
                'Ambiente', 'Contribuição', 'Emoções'
            ],
            datasets: [{
                label: 'Roda da Vida',
                data: areas.map(area => document.getElementById(`id_${area}`).value),
                backgroundColor: 'rgba(233, 30, 99, 0.2)',
                borderColor: 'rgba(233, 30, 99, 1)',
                pointBackgroundColor: 'rgba(233, 30, 99, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(233, 30, 99, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            elements: {
                line: {
                    borderWidth: 3
                }
            },
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    suggestedMin: 0,
                    suggestedMax: 10
                }
            }
        }
    });

    function updateChart() {
        wheelChart.data.datasets[0].data = areas.map(area => 
            document.getElementById(`id_${area}`).value
        );
        wheelChart.update();
    }
});
</script>
{% endblock %}
