{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Cargos - HR{% endblock %}

{% block extra_css %}
<link href="{% static 'css/hr-module.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="hr-container">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-briefcase text-blue-600 mr-3"></i>
                    Gestão de Cargos
                </h1>
                <p class="text-gray-600">Gerencie os cargos e posições da organização</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportPositions()" class="action-button secondary">
                    <i class="fas fa-download mr-2"></i>
                    Exportar
                </button>
                <a href="{% url 'hr:position_create' %}" class="action-button primary">
                    <i class="fas fa-plus mr-2"></i>
                    Novo Cargo
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stats-card bg-gradient-to-r from-blue-500 to-blue-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ total_positions|default:0 }}</div>
                    <div class="stats-card-label">Total de Cargos</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-green-400"></i>
                <span class="text-green-400">+12% este mês</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-green-500 to-green-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ occupied_positions|default:0 }}</div>
                    <div class="stats-card-label">Posições Ocupadas</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-green-400"></i>
                <span class="text-green-400">+5% este mês</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-yellow-500 to-yellow-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ vacant_positions|default:0 }}</div>
                    <div class="stats-card-label">Vagas Abertas</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-down text-red-400"></i>
                <span class="text-red-400">-3% este mês</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-purple-500 to-purple-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ avg_salary|floatformat:0|default:0 }}</div>
                    <div class="stats-card-label">Salário Médio</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-green-400"></i>
                <span class="text-green-400">+8% este ano</span>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Search -->
                <div class="relative">
                    <input type="text" 
                           id="search-input" 
                           placeholder="Buscar cargos..." 
                           class="form-input pl-10 w-80"
                           hx-get="{% url 'hr:position_list' %}"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#positions-list"
                           hx-include="[name='department'], [name='level'], [name='status']">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Department Filter -->
                <select name="department" 
                        class="form-input w-48"
                        hx-get="{% url 'hr:position_list' %}"
                        hx-trigger="change"
                        hx-target="#positions-list"
                        hx-include="[name='search'], [name='level'], [name='status']">
                    <option value="">Todos os Departamentos</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- Level Filter -->
                <select name="level" 
                        class="form-input w-40"
                        hx-get="{% url 'hr:position_list' %}"
                        hx-trigger="change"
                        hx-target="#positions-list"
                        hx-include="[name='search'], [name='department'], [name='status']">
                    <option value="">Todos os Níveis</option>
                    <option value="junior" {% if request.GET.level == 'junior' %}selected{% endif %}>Júnior</option>
                    <option value="pleno" {% if request.GET.level == 'pleno' %}selected{% endif %}>Pleno</option>
                    <option value="senior" {% if request.GET.level == 'senior' %}selected{% endif %}>Sênior</option>
                    <option value="coordenador" {% if request.GET.level == 'coordenador' %}selected{% endif %}>Coordenador</option>
                    <option value="gerente" {% if request.GET.level == 'gerente' %}selected{% endif %}>Gerente</option>
                    <option value="diretor" {% if request.GET.level == 'diretor' %}selected{% endif %}>Diretor</option>
                </select>

                <!-- Status Filter -->
                <select name="status" 
                        class="form-input w-36"
                        hx-get="{% url 'hr:position_list' %}"
                        hx-trigger="change"
                        hx-target="#positions-list"
                        hx-include="[name='search'], [name='department'], [name='level']">
                    <option value="">Todos os Status</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Ativo</option>
                    <option value="vacant" {% if request.GET.status == 'vacant' %}selected{% endif %}>Vago</option>
                    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inativo</option>
                </select>
            </div>

            <!-- View Toggle -->
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">Visualização:</span>
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button onclick="toggleView('grid')" 
                            class="view-toggle-btn active" 
                            id="grid-view-btn">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button onclick="toggleView('table')" 
                            class="view-toggle-btn" 
                            id="table-view-btn">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Positions List -->
    <div id="positions-list">
        <!-- Grid View (Default) -->
        <div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for position in positions %}
                <div class="position-card" data-position-id="{{ position.id }}">
                    <div class="position-card-header">
                        <div class="flex justify-between items-start mb-3">
                            <div class="position-level-badge level-{{ position.level|lower }}">
                                {{ position.get_level_display|default:position.level }}
                            </div>
                            <div class="dropdown-menu">
                                <button class="dropdown-trigger">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-content">
                                    <a href="{% url 'hr:position_detail' position.id %}" class="dropdown-item">
                                        <i class="fas fa-eye mr-2"></i>Ver Detalhes
                                    </a>
                                    <a href="{% url 'hr:position_edit' position.id %}" class="dropdown-item">
                                        <i class="fas fa-edit mr-2"></i>Editar
                                    </a>
                                    <a href="{% url 'hr:position_duplicate' position.id %}" class="dropdown-item">
                                        <i class="fas fa-copy mr-2"></i>Duplicar
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <button onclick="deletePosition({{ position.id }})" class="dropdown-item text-red-600">
                                        <i class="fas fa-trash mr-2"></i>Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="position-title">
                            <a href="{% url 'hr:position_detail' position.id %}">
                                {{ position.title }}
                            </a>
                        </h3>
                        
                        <div class="position-department">
                            <i class="fas fa-building text-gray-400 mr-1"></i>
                            {{ position.department.name }}
                        </div>
                    </div>
                    
                    <div class="position-card-body">
                        <div class="position-stats">
                            <div class="stat-item">
                                <span class="stat-label">Funcionários</span>
                                <span class="stat-value">{{ position.employee_count|default:0 }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Vagas</span>
                                <span class="stat-value">{{ position.open_positions|default:0 }}</span>
                            </div>
                        </div>
                        
                        {% if position.salary_range_min and position.salary_range_max %}
                            <div class="salary-range">
                                <i class="fas fa-dollar-sign text-green-500 mr-1"></i>
                                <span class="text-sm font-medium">
                                    R$ {{ position.salary_range_min|floatformat:0 }} - R$ {{ position.salary_range_max|floatformat:0 }}
                                </span>
                            </div>
                        {% endif %}
                        
                        {% if position.description %}
                            <p class="position-description">
                                {{ position.description|truncatewords:15 }}
                            </p>
                        {% endif %}
                    </div>
                    
                    <div class="position-card-footer">
                        <div class="flex justify-between items-center">
                            <div class="status-badge status-{{ position.status|lower }}">
                                <i class="fas fa-circle mr-1"></i>
                                {{ position.get_status_display|default:position.status }}
                            </div>
                            
                            <div class="text-xs text-gray-500">
                                Atualizado em {{ position.updated_at|date:"d/m/Y" }}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <h3 class="empty-state-title">Nenhum cargo encontrado</h3>
                        <p class="empty-state-description">
                            Não há cargos cadastrados com os filtros selecionados.
                        </p>
                        <div class="empty-state-actions">
                            <a href="{% url 'hr:position_create' %}" class="action-button primary">
                                <i class="fas fa-plus mr-2"></i>
                                Cadastrar Primeiro Cargo
                            </a>
                            <button onclick="clearFilters()" class="action-button outline">
                                <i class="fas fa-times mr-2"></i>
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Table View (Hidden by default) -->
        <div id="table-view" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" class="form-checkbox" id="select-all">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Cargo
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Departamento
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nível
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Funcionários
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Salário
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for position in positions %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" class="form-checkbox" value="{{ position.id }}">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                                                    <i class="fas fa-briefcase text-gray-500"></i>
                                                </div>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">
                                                    <a href="{% url 'hr:position_detail' position.id %}" class="hover:text-blue-600">
                                                        {{ position.title }}
                                                    </a>
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    {{ position.code|default:"-" }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">{{ position.department.name }}</div>
                                        <div class="text-sm text-gray-500">{{ position.department.code|default:"-" }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="position-level-badge level-{{ position.level|lower }}">
                                            {{ position.get_level_display|default:position.level }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ position.employee_count|default:0 }}
                                        {% if position.open_positions %}
                                            <span class="text-yellow-600">(+{{ position.open_positions }} vagas)</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {% if position.salary_range_min and position.salary_range_max %}
                                            R$ {{ position.salary_range_min|floatformat:0 }} - {{ position.salary_range_max|floatformat:0 }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-{{ position.status|lower }}">
                                            {{ position.get_status_display|default:position.status }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <a href="{% url 'hr:position_detail' position.id %}" 
                                               class="action-button-sm primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'hr:position_edit' position.id %}" 
                                               class="action-button-sm secondary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button onclick="deletePosition({{ position.id }})" 
                                                    class="action-button-sm danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="8" class="px-6 py-12 text-center">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">
                                                <i class="fas fa-briefcase"></i>
                                            </div>
                                            <h3 class="empty-state-title">Nenhum cargo encontrado</h3>
                                            <p class="empty-state-description">
                                                Não há cargos cadastrados com os filtros selecionados.
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="flex justify-between items-center mt-8">
            <div class="text-sm text-gray-600">
                Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} cargos
            </div>
            
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="pagination-btn active">{{ num }}</span>
                    {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                        <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                           class="pagination-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}{% if request.GET.level %}&level={{ request.GET.level }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Bulk Actions Modal -->
<div id="bulk-actions-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ações em Lote</h3>
            <button onclick="closeBulkModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Selecione uma ação para aplicar aos cargos selecionados:</p>
            <div class="space-y-3 mt-4">
                <button onclick="bulkAction('activate')" class="w-full action-button success">
                    <i class="fas fa-check-circle mr-2"></i>
                    Ativar Selecionados
                </button>
                <button onclick="bulkAction('deactivate')" class="w-full action-button warning">
                    <i class="fas fa-pause-circle mr-2"></i>
                    Desativar Selecionados
                </button>
                <button onclick="bulkAction('export')" class="w-full action-button secondary">
                    <i class="fas fa-download mr-2"></i>
                    Exportar Selecionados
                </button>
                <button onclick="bulkAction('delete')" class="w-full action-button danger">
                    <i class="fas fa-trash mr-2"></i>
                    Excluir Selecionados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.8.4"></script>
<script>
    // View toggle functionality
    function toggleView(viewType) {
        const gridView = document.getElementById('grid-view');
        const tableView = document.getElementById('table-view');
        const gridBtn = document.getElementById('grid-view-btn');
        const tableBtn = document.getElementById('table-view-btn');
        
        if (viewType === 'grid') {
            gridView.classList.remove('hidden');
            tableView.classList.add('hidden');
            gridBtn.classList.add('active');
            tableBtn.classList.remove('active');
        } else {
            gridView.classList.add('hidden');
            tableView.classList.remove('hidden');
            tableBtn.classList.add('active');
            gridBtn.classList.remove('active');
        }
        
        // Save preference
        localStorage.setItem('hr_positions_view', viewType);
    }
    
    // Load saved view preference
    document.addEventListener('DOMContentLoaded', function() {
        const savedView = localStorage.getItem('hr_positions_view') || 'grid';
        toggleView(savedView);
    });
    
    // Clear filters
    function clearFilters() {
        document.getElementById('search-input').value = '';
        document.querySelector('[name="department"]').value = '';
        document.querySelector('[name="level"]').value = '';
        document.querySelector('[name="status"]').value = '';
        
        // Trigger HTMX reload
        htmx.trigger('#search-input', 'keyup');
    }
    
    // Delete position
    function deletePosition(positionId) {
        if (confirm('Tem certeza que deseja excluir este cargo? Esta ação não pode ser desfeita.')) {
            // HTMX delete request or form submission
            fetch(`/hr/positions/${positionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    // Remove card from view
                    const card = document.querySelector(`[data-position-id="${positionId}"]`);
                    if (card) {
                        card.remove();
                    }
                    alert('Cargo excluído com sucesso!');
                } else {
                    alert('Erro ao excluir cargo. Tente novamente.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao excluir cargo.');
            });
        }
    }
    
    // Export positions
    function exportPositions() {
        const selectedFilters = new URLSearchParams();
        
        // Get current filters
        const search = document.getElementById('search-input').value;
        const department = document.querySelector('[name="department"]').value;
        const level = document.querySelector('[name="level"]').value;
        const status = document.querySelector('[name="status"]').value;
        
        if (search) selectedFilters.append('search', search);
        if (department) selectedFilters.append('department', department);
        if (level) selectedFilters.append('level', level);
        if (status) selectedFilters.append('status', status);
        
        // Download export
        window.location.href = `/hr/positions/export/?${selectedFilters.toString()}`;
    }
    
    // Bulk actions
    let selectedPositions = [];
    
    // Handle individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.value) {
            if (e.target.checked) {
                selectedPositions.push(e.target.value);
            } else {
                selectedPositions = selectedPositions.filter(id => id !== e.target.value);
            }
            updateBulkActions();
        }
    });
    
    // Handle select all checkbox
    document.getElementById('select-all')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        if (this.checked) {
            selectedPositions = Array.from(checkboxes).map(cb => cb.value);
        } else {
            selectedPositions = [];
        }
        updateBulkActions();
    });
    
    function updateBulkActions() {
        const bulkButton = document.getElementById('bulk-actions-btn');
        if (selectedPositions.length > 0) {
            if (!bulkButton) {
                // Create bulk actions button
                const button = document.createElement('button');
                button.id = 'bulk-actions-btn';
                button.className = 'action-button secondary';
                button.innerHTML = `<i class="fas fa-tasks mr-2"></i>Ações (${selectedPositions.length})`;
                button.onclick = () => document.getElementById('bulk-actions-modal').style.display = 'flex';
                
                const actionsContainer = document.querySelector('.flex.space-x-3');
                actionsContainer.insertBefore(button, actionsContainer.firstChild);
            } else {
                bulkButton.innerHTML = `<i class="fas fa-tasks mr-2"></i>Ações (${selectedPositions.length})`;
            }
        } else if (bulkButton) {
            bulkButton.remove();
        }
    }
    
    function closeBulkModal() {
        document.getElementById('bulk-actions-modal').style.display = 'none';
    }
    
    function bulkAction(action) {
        if (selectedPositions.length === 0) {
            alert('Selecione pelo menos um cargo.');
            return;
        }
        
        let confirmMessage = '';
        switch (action) {
            case 'activate':
                confirmMessage = `Ativar ${selectedPositions.length} cargo(s) selecionado(s)?`;
                break;
            case 'deactivate':
                confirmMessage = `Desativar ${selectedPositions.length} cargo(s) selecionado(s)?`;
                break;
            case 'delete':
                confirmMessage = `Excluir ${selectedPositions.length} cargo(s) selecionado(s)? Esta ação não pode ser desfeita.`;
                break;
            case 'export':
                // Direct export without confirmation
                exportSelectedPositions();
                return;
        }
        
        if (confirm(confirmMessage)) {
            fetch(`/hr/positions/bulk-action/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    position_ids: selectedPositions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload(); // Reload to show changes
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao executar ação.');
            });
        }
        
        closeBulkModal();
    }
    
    function exportSelectedPositions() {
        const params = new URLSearchParams();
        selectedPositions.forEach(id => params.append('ids', id));
        window.location.href = `/hr/positions/export/?${params.toString()}`;
        closeBulkModal();
    }
    
    // Dropdown menus
    document.addEventListener('click', function(e) {
        // Close all dropdown menus
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
        
        // Open clicked dropdown
        if (e.target.closest('.dropdown-trigger')) {
            e.preventDefault();
            const dropdown = e.target.closest('.dropdown-menu').querySelector('.dropdown-content');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-menu')) {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
</script>
{% endblock %}
