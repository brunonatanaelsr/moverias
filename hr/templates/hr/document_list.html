{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Documentos - HR{% endblock %}

{% block extra_css %}
<link href="{% static 'css/hr-module.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="hr-container">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-file-alt text-blue-600 mr-3"></i>
                    Gestão de Documentos
                </h1>
                <p class="text-gray-600">Gerencie documentos de funcionários e departamentos</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="bulkDownload()" class="action-button secondary">
                    <i class="fas fa-download mr-2"></i>
                    Download em Lote
                </button>
                <a href="{% url 'hr:document_upload' %}" class="action-button primary">
                    <i class="fas fa-plus mr-2"></i>
                    Novo Documento
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stats-card bg-gradient-to-r from-blue-500 to-blue-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ total_documents|default:0 }}</div>
                    <div class="stats-card-label">Total Documentos</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-green-400"></i>
                <span class="text-green-400">+24 este mês</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-green-500 to-green-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ approved_documents|default:0 }}</div>
                    <div class="stats-card-label">Aprovados</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-green-400"></i>
                <span class="text-green-400">+18 este mês</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-yellow-500 to-yellow-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ pending_documents|default:0 }}</div>
                    <div class="stats-card-label">Pendentes</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-down text-red-400"></i>
                <span class="text-red-400">-5 esta semana</span>
            </div>
        </div>

        <div class="stats-card bg-gradient-to-r from-red-500 to-red-600">
            <div class="stats-card-content">
                <div class="stats-card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stats-card-info">
                    <div class="stats-card-value">{{ expiring_documents|default:0 }}</div>
                    <div class="stats-card-label">Vencendo</div>
                </div>
            </div>
            <div class="stats-card-trend">
                <i class="fas fa-arrow-up text-orange-400"></i>
                <span class="text-orange-400">+3 próximos 30 dias</span>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Search -->
                <div class="relative">
                    <input type="text" 
                           id="search-input" 
                           placeholder="Buscar documentos..." 
                           class="form-input pl-10 w-80"
                           hx-get="{% url 'hr:document_list' %}"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#documents-list"
                           hx-include="[name='type'], [name='status'], [name='employee'], [name='department']">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Document Type Filter -->
                <select name="type" 
                        class="form-input w-48"
                        hx-get="{% url 'hr:document_list' %}"
                        hx-trigger="change"
                        hx-target="#documents-list"
                        hx-include="[name='search'], [name='status'], [name='employee'], [name='department']">
                    <option value="">Todos os Tipos</option>
                    <option value="identification" {% if request.GET.type == 'identification' %}selected{% endif %}>Identificação</option>
                    <option value="contract" {% if request.GET.type == 'contract' %}selected{% endif %}>Contrato</option>
                    <option value="certificate" {% if request.GET.type == 'certificate' %}selected{% endif %}>Certificado</option>
                    <option value="training" {% if request.GET.type == 'training' %}selected{% endif %}>Treinamento</option>
                    <option value="performance" {% if request.GET.type == 'performance' %}selected{% endif %}>Performance</option>
                    <option value="other" {% if request.GET.type == 'other' %}selected{% endif %}>Outros</option>
                </select>

                <!-- Status Filter -->
                <select name="status" 
                        class="form-input w-40"
                        hx-get="{% url 'hr:document_list' %}"
                        hx-trigger="change"
                        hx-target="#documents-list"
                        hx-include="[name='search'], [name='type'], [name='employee'], [name='department']">
                    <option value="">Todos os Status</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendente</option>
                    <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Aprovado</option>
                    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejeitado</option>
                    <option value="expired" {% if request.GET.status == 'expired' %}selected{% endif %}>Expirado</option>
                </select>

                <!-- Employee Filter -->
                <select name="employee" 
                        class="form-input w-48"
                        hx-get="{% url 'hr:document_list' %}"
                        hx-trigger="change"
                        hx-target="#documents-list"
                        hx-include="[name='search'], [name='type'], [name='status'], [name='department']">
                    <option value="">Todos os Funcionários</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}" {% if request.GET.employee == employee.id|stringformat:"s" %}selected{% endif %}>
                            {{ employee.get_full_name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- Department Filter -->
                <select name="department" 
                        class="form-input w-48"
                        hx-get="{% url 'hr:document_list' %}"
                        hx-trigger="change"
                        hx-target="#documents-list"
                        hx-include="[name='search'], [name='type'], [name='status'], [name='employee']">
                    <option value="">Todos os Departamentos</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- View Toggle and Sort -->
            <div class="flex items-center space-x-4">
                <!-- Sort Options -->
                <select name="sort" 
                        class="form-input w-44"
                        onchange="sortDocuments(this.value)">
                    <option value="-created_at">Mais Recentes</option>
                    <option value="created_at">Mais Antigos</option>
                    <option value="title">Nome A-Z</option>
                    <option value="-title">Nome Z-A</option>
                    <option value="expiry_date">Vencimento</option>
                    <option value="-file_size">Tamanho</option>
                </select>

                <!-- View Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">Visualização:</span>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="toggleView('grid')" 
                                class="view-toggle-btn active" 
                                id="grid-view-btn">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleView('list')" 
                                class="view-toggle-btn" 
                                id="list-view-btn">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
        <div class="flex justify-between items-center">
            <div class="flex space-x-3">
                <button onclick="showBulkActions()" 
                        class="action-button outline"
                        id="bulk-actions-btn" 
                        style="display: none;">
                    <i class="fas fa-tasks mr-2"></i>
                    Ações em Lote (<span id="selected-count">0</span>)
                </button>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="clearFilters()" class="action-button outline">
                    <i class="fas fa-filter mr-2"></i>
                    Limpar Filtros
                </button>
                <button onclick="exportDocuments()" class="action-button secondary">
                    <i class="fas fa-file-export mr-2"></i>
                    Exportar Lista
                </button>
            </div>
        </div>
    </div>

    <!-- Documents List -->
    <div id="documents-list">
        <!-- Grid View (Default) -->
        <div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for document in documents %}
                <div class="document-card" data-document-id="{{ document.id }}">
                    <div class="document-card-header">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" 
                                       class="form-checkbox document-checkbox" 
                                       value="{{ document.id }}"
                                       onchange="updateBulkActions()">
                                <div class="document-type-icon type-{{ document.type|lower }}">
                                    <i class="fas fa-{{ document.get_type_icon }}"></i>
                                </div>
                            </div>
                            <div class="dropdown-menu">
                                <button class="dropdown-trigger">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-content">
                                    <a href="{% url 'hr:document_detail' document.id %}" class="dropdown-item">
                                        <i class="fas fa-eye mr-2"></i>Ver Documento
                                    </a>
                                    <a href="{{ document.file.url }}" target="_blank" class="dropdown-item">
                                        <i class="fas fa-download mr-2"></i>Download
                                    </a>
                                    {% if document.can_edit %}
                                        <a href="{% url 'hr:document_edit' document.id %}" class="dropdown-item">
                                            <i class="fas fa-edit mr-2"></i>Editar
                                        </a>
                                    {% endif %}
                                    {% if document.status == 'pending' %}
                                        <a href="{% url 'hr:document_approve' document.id %}" class="dropdown-item">
                                            <i class="fas fa-check mr-2"></i>Aprovar
                                        </a>
                                    {% endif %}
                                    <div class="dropdown-divider"></div>
                                    <button onclick="shareDocument({{ document.id }})" class="dropdown-item">
                                        <i class="fas fa-share mr-2"></i>Compartilhar
                                    </button>
                                    {% if document.can_delete %}
                                        <button onclick="deleteDocument({{ document.id }})" class="dropdown-item text-red-600">
                                            <i class="fas fa-trash mr-2"></i>Excluir
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="document-title">
                            <a href="{% url 'hr:document_detail' document.id %}">
                                {{ document.title|truncatechars:35 }}
                            </a>
                        </h3>
                        
                        <div class="document-meta">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-user text-gray-400 mr-1"></i>
                                {{ document.employee.get_full_name|truncatechars:20 }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="document-card-body">
                        <div class="document-preview">
                            {% if document.file_type == 'image' %}
                                <img src="{{ document.file.url }}" 
                                     alt="{{ document.title }}" 
                                     class="w-full h-32 object-cover rounded-lg">
                            {% elif document.file_type == 'pdf' %}
                                <div class="pdf-preview">
                                    <i class="fas fa-file-pdf text-red-500 text-4xl"></i>
                                    <span class="text-sm text-gray-600">PDF</span>
                                </div>
                            {% else %}
                                <div class="file-preview">
                                    <i class="fas fa-file text-gray-400 text-4xl"></i>
                                    <span class="text-sm text-gray-600">{{ document.file_extension|upper }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="document-info mt-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">
                                    <i class="fas fa-hdd mr-1"></i>
                                    {{ document.file_size|filesizeformat }}
                                </span>
                                <span class="text-gray-600">
                                    {{ document.created_at|date:"d/m/Y" }}
                                </span>
                            </div>
                            
                            {% if document.expiry_date %}
                                <div class="expiry-info mt-2">
                                    <div class="text-sm {% if document.is_expiring %}text-red-600{% elif document.is_expired %}text-red-800{% else %}text-gray-600{% endif %}">
                                        <i class="fas fa-calendar-alt mr-1"></i>
                                        Vence em {{ document.expiry_date|date:"d/m/Y" }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="document-card-footer">
                        <div class="flex justify-between items-center">
                            <span class="status-badge status-{{ document.status|lower }}">
                                <i class="fas fa-circle mr-1"></i>
                                {{ document.get_status_display|default:document.status }}
                            </span>
                            
                            <div class="flex space-x-1">
                                <a href="{% url 'hr:document_detail' document.id %}" 
                                   class="action-button-sm primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ document.file.url }}" 
                                   target="_blank" 
                                   class="action-button-sm secondary">
                                    <i class="fas fa-download"></i>
                                </a>
                                {% if document.status == 'pending' %}
                                    <a href="{% url 'hr:document_approve' document.id %}" 
                                       class="action-button-sm success">
                                        <i class="fas fa-check"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-span-full">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3 class="empty-state-title">Nenhum documento encontrado</h3>
                        <p class="empty-state-description">
                            Não há documentos cadastrados com os filtros selecionados.
                        </p>
                        <div class="empty-state-actions">
                            <a href="{% url 'hr:document_upload' %}" class="action-button primary">
                                <i class="fas fa-plus mr-2"></i>
                                Carregar Primeiro Documento
                            </a>
                            <button onclick="clearFilters()" class="action-button outline">
                                <i class="fas fa-times mr-2"></i>
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- List View (Hidden by default) -->
        <div id="list-view" class="hidden">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" class="form-checkbox" id="select-all-list">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Documento
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Funcionário
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Vencimento
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tamanho
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for document in documents %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input type="checkbox" 
                                               class="form-checkbox document-checkbox" 
                                               value="{{ document.id }}"
                                               onchange="updateBulkActions()">
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <div class="document-type-icon type-{{ document.type|lower }}">
                                                    <i class="fas fa-{{ document.get_type_icon }}"></i>
                                                </div>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">
                                                    <a href="{% url 'hr:document_detail' document.id %}" 
                                                       class="hover:text-blue-600">
                                                        {{ document.title }}
                                                    </a>
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    {{ document.created_at|date:"d/m/Y H:i" }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">{{ document.employee.get_full_name }}</div>
                                        <div class="text-sm text-gray-500">{{ document.employee.department.name|default:"-" }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="document-type-badge type-{{ document.type|lower }}">
                                            {{ document.get_type_display|default:document.type }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-{{ document.status|lower }}">
                                            {{ document.get_status_display|default:document.status }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {% if document.expiry_date %}
                                            <span class="{% if document.is_expiring %}text-red-600{% elif document.is_expired %}text-red-800{% endif %}">
                                                {{ document.expiry_date|date:"d/m/Y" }}
                                            </span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ document.file_size|filesizeformat }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <a href="{% url 'hr:document_detail' document.id %}" 
                                               class="action-button-sm primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ document.file.url }}" 
                                               target="_blank" 
                                               class="action-button-sm secondary">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            {% if document.status == 'pending' %}
                                                <a href="{% url 'hr:document_approve' document.id %}" 
                                                   class="action-button-sm success">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            {% endif %}
                                            {% if document.can_delete %}
                                                <button onclick="deleteDocument({{ document.id }})" 
                                                        class="action-button-sm danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="8" class="px-6 py-12 text-center">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">
                                                <i class="fas fa-file-alt"></i>
                                            </div>
                                            <h3 class="empty-state-title">Nenhum documento encontrado</h3>
                                            <p class="empty-state-description">
                                                Não há documentos cadastrados com os filtros selecionados.
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="flex justify-between items-center mt-8">
            <div class="text-sm text-gray-600">
                Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }} documentos
            </div>
            
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.employee %}&employee={{ request.GET.employee }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.employee %}&employee={{ request.GET.employee }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="pagination-btn active">{{ num }}</span>
                    {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                        <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.employee %}&employee={{ request.GET.employee }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" 
                           class="pagination-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.employee %}&employee={{ request.GET.employee }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.employee %}&employee={{ request.GET.employee }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" 
                       class="pagination-btn">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<!-- Bulk Actions Modal -->
<div id="bulk-actions-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ações em Lote</h3>
            <button onclick="closeBulkModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Selecione uma ação para aplicar aos documentos selecionados:</p>
            <div class="space-y-3 mt-4">
                <button onclick="bulkAction('approve')" class="w-full action-button success">
                    <i class="fas fa-check-circle mr-2"></i>
                    Aprovar Selecionados
                </button>
                <button onclick="bulkAction('download')" class="w-full action-button secondary">
                    <i class="fas fa-download mr-2"></i>
                    Download em Lote
                </button>
                <button onclick="bulkAction('archive')" class="w-full action-button warning">
                    <i class="fas fa-archive mr-2"></i>
                    Arquivar Selecionados
                </button>
                <button onclick="bulkAction('delete')" class="w-full action-button danger">
                    <i class="fas fa-trash mr-2"></i>
                    Excluir Selecionados
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Document Modal -->
<div id="share-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Compartilhar Documento</h3>
            <button onclick="closeShareModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="space-y-4">
                <div>
                    <label class="form-label">E-mail do destinatário</label>
                    <input type="email" id="share-email" class="form-input" placeholder="email@exemplo.com">
                </div>
                <div>
                    <label class="form-label">Mensagem (opcional)</label>
                    <textarea id="share-message" class="form-input" rows="3" placeholder="Adicione uma mensagem..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeShareModal()" class="action-button outline">Cancelar</button>
                    <button onclick="sendShare()" class="action-button primary">
                        <i class="fas fa-share mr-2"></i>
                        Compartilhar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/htmx.org@1.8.4"></script>
<script>
    let selectedDocuments = [];
    let currentShareDocumentId = null;
    
    // View toggle functionality
    function toggleView(viewType) {
        const gridView = document.getElementById('grid-view');
        const listView = document.getElementById('list-view');
        const gridBtn = document.getElementById('grid-view-btn');
        const listBtn = document.getElementById('list-view-btn');
        
        if (viewType === 'grid') {
            gridView.classList.remove('hidden');
            listView.classList.add('hidden');
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        } else {
            gridView.classList.add('hidden');
            listView.classList.remove('hidden');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        }
        
        localStorage.setItem('hr_documents_view', viewType);
    }
    
    // Load saved view preference
    document.addEventListener('DOMContentLoaded', function() {
        const savedView = localStorage.getItem('hr_documents_view') || 'grid';
        toggleView(savedView);
    });
    
    // Clear filters
    function clearFilters() {
        document.getElementById('search-input').value = '';
        document.querySelector('[name="type"]').value = '';
        document.querySelector('[name="status"]').value = '';
        document.querySelector('[name="employee"]').value = '';
        document.querySelector('[name="department"]').value = '';
        
        htmx.trigger('#search-input', 'keyup');
    }
    
    // Sort documents
    function sortDocuments(sortValue) {
        const url = new URL(window.location);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
    }
    
    // Bulk actions functionality
    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.document-checkbox:checked');
        selectedDocuments = Array.from(checkboxes).map(cb => cb.value);
        
        const bulkBtn = document.getElementById('bulk-actions-btn');
        const countSpan = document.getElementById('selected-count');
        
        if (selectedDocuments.length > 0) {
            bulkBtn.style.display = 'inline-flex';
            countSpan.textContent = selectedDocuments.length;
        } else {
            bulkBtn.style.display = 'none';
        }
    }
    
    function showBulkActions() {
        if (selectedDocuments.length === 0) {
            alert('Selecione pelo menos um documento.');
            return;
        }
        document.getElementById('bulk-actions-modal').style.display = 'flex';
    }
    
    function closeBulkModal() {
        document.getElementById('bulk-actions-modal').style.display = 'none';
    }
    
    function bulkAction(action) {
        if (selectedDocuments.length === 0) {
            alert('Selecione pelo menos um documento.');
            return;
        }
        
        let confirmMessage = '';
        switch (action) {
            case 'approve':
                confirmMessage = `Aprovar ${selectedDocuments.length} documento(s) selecionado(s)?`;
                break;
            case 'archive':
                confirmMessage = `Arquivar ${selectedDocuments.length} documento(s) selecionado(s)?`;
                break;
            case 'delete':
                confirmMessage = `Excluir ${selectedDocuments.length} documento(s) selecionado(s)? Esta ação não pode ser desfeita.`;
                break;
            case 'download':
                bulkDownloadDocuments();
                return;
        }
        
        if (confirm(confirmMessage)) {
            fetch('/hr/documents/bulk-action/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: action,
                    document_ids: selectedDocuments
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao executar ação.');
            });
        }
        
        closeBulkModal();
    }
    
    function bulkDownloadDocuments() {
        const params = new URLSearchParams();
        selectedDocuments.forEach(id => params.append('ids', id));
        window.location.href = `/hr/documents/bulk-download/?${params.toString()}`;
        closeBulkModal();
    }
    
    // Individual document actions
    function deleteDocument(documentId) {
        if (confirm('Tem certeza que deseja excluir este documento? Esta ação não pode ser desfeita.')) {
            fetch(`/hr/documents/${documentId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => {
                if (response.ok) {
                    const card = document.querySelector(`[data-document-id="${documentId}"]`);
                    if (card) {
                        card.remove();
                    }
                    alert('Documento excluído com sucesso!');
                } else {
                    alert('Erro ao excluir documento.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao excluir documento.');
            });
        }
    }
    
    function shareDocument(documentId) {
        currentShareDocumentId = documentId;
        document.getElementById('share-modal').style.display = 'flex';
    }
    
    function closeShareModal() {
        document.getElementById('share-modal').style.display = 'none';
        document.getElementById('share-email').value = '';
        document.getElementById('share-message').value = '';
        currentShareDocumentId = null;
    }
    
    function sendShare() {
        const email = document.getElementById('share-email').value;
        const message = document.getElementById('share-message').value;
        
        if (!email) {
            alert('Por favor, insira um e-mail válido.');
            return;
        }
        
        fetch(`/hr/documents/${currentShareDocumentId}/share/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Documento compartilhado com sucesso!');
                closeShareModal();
            } else {
                alert('Erro ao compartilhar documento: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao compartilhar documento.');
        });
    }
    
    // Export documents list
    function exportDocuments() {
        const params = new URLSearchParams(window.location.search);
        window.location.href = `/hr/documents/export/?${params.toString()}`;
    }
    
    // Select all functionality
    document.getElementById('select-all-list')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.document-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkActions();
    });
    
    // Dropdown functionality
    document.addEventListener('click', function(e) {
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
        
        if (e.target.closest('.dropdown-trigger')) {
            e.preventDefault();
            const dropdown = e.target.closest('.dropdown-menu').querySelector('.dropdown-content');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown-menu')) {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
    
    // Auto-refresh for pending documents
    setInterval(function() {
        const pendingElements = document.querySelectorAll('.status-pending');
        if (pendingElements.length > 0) {
            // Refresh pending documents status
            htmx.trigger('#search-input', 'keyup');
        }
    }, 30000); // Refresh every 30 seconds
</script>
{% endblock %}
