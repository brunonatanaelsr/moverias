{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Departamentos - HR{% endblock %}

{% block extra_css %}
<link href="{% static 'css/hr-module.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="hr-container">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Departamentos</h1>
                <p class="text-gray-600">Gerencie os departamentos da organização</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'hr:department_form' %}" class="action-button primary">
                    <i class="fas fa-plus mr-2"></i>
                    Novo Departamento
                </a>
                <button onclick="exportDepartments()" class="action-button outline">
                    <i class="fas fa-download mr-2"></i>
                    Exportar
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-icon blue">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-value">{{ total_departments }}</div>
            <div class="stat-label">Total de Departamentos</div>
            <div class="stat-change">
                <i class="fas fa-users"></i>
                {{ total_employees }} funcionários
            </div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-icon green">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">{{ avg_employees_per_dept|floatformat:0 }}</div>
            <div class="stat-label">Média por Departamento</div>
            <div class="stat-change">
                <i class="fas fa-balance-scale"></i>
                Distribuição equilibrada
            </div>
        </div>
        
        <div class="stat-card yellow">
            <div class="stat-icon yellow">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="stat-value">{{ departments_with_manager }}</div>
            <div class="stat-label">Com Gerente</div>
            <div class="stat-change">
                <i class="fas fa-percentage"></i>
                {{ manager_coverage_percentage }}% cobertura
            </div>
        </div>
        
        <div class="stat-card purple">
            <div class="stat-icon purple">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ top_performing_dept_score|floatformat:1 }}</div>
            <div class="stat-label">Melhor Performance</div>
            <div class="stat-change positive">
                <i class="fas fa-crown"></i>
                {{ top_performing_dept }}
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="filter-bar">
        <form method="GET" class="flex flex-wrap gap-4 items-center" id="filter-form">
            <!-- Search Input -->
            <div class="search-input-container flex-1 min-w-[300px]">
                <i class="search-icon fas fa-search"></i>
                <input type="text" 
                       name="search" 
                       value="{{ request.GET.search }}"
                       placeholder="Buscar departamentos..."
                       class="search-input">
            </div>
            
            <!-- Status Filter -->
            <select name="status" class="filter-select">
                <option value="">Todos os Status</option>
                <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Ativo</option>
                <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>Inativo</option>
            </select>
            
            <!-- Sort By -->
            <select name="sort" class="filter-select">
                <option value="name">Nome</option>
                <option value="employee_count" {% if request.GET.sort == 'employee_count' %}selected{% endif %}>Nº Funcionários</option>
                <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Data Criação</option>
            </select>
            
            <!-- Clear Filters -->
            <a href="{% url 'hr:department_list' %}" class="action-button outline">
                <i class="fas fa-times mr-1"></i>
                Limpar
            </a>
        </form>
    </div>

    <!-- Departments Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for department in departments %}
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                <!-- Department Header -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                <i class="fas {{ department.icon|default:'fa-building' }} text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">{{ department.name }}</h3>
                                <p class="text-blue-100 text-sm">Departamento</p>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if department.is_active %}
                                <span class="inline-block w-3 h-3 bg-green-400 rounded-full"></span>
                            {% else %}
                                <span class="inline-block w-3 h-3 bg-red-400 rounded-full"></span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Department Content -->
                <div class="p-6">
                    <!-- Description -->
                    {% if department.description %}
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ department.description }}</p>
                    {% endif %}

                    <!-- Manager Info -->
                    <div class="mb-4">
                        <div class="flex items-center space-x-3">
                            {% if department.manager %}
                                {% if department.manager.photo %}
                                    <img src="{{ department.manager.photo.url }}" 
                                         alt="{{ department.manager.full_name }}" 
                                         class="w-10 h-10 rounded-full object-cover">
                                {% else %}
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm">
                                        {{ department.manager.get_initials }}
                                    </div>
                                {% endif %}
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ department.manager.full_name }}</div>
                                    <div class="text-xs text-gray-500">Gerente</div>
                                </div>
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                    <i class="fas fa-user-slash text-gray-400"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-500">Sem gerente</div>
                                    <div class="text-xs text-gray-400">Não atribuído</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">{{ department.employee_count }}</div>
                            <div class="text-xs text-gray-500">Funcionários</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">{{ department.avg_performance|floatformat:1|default:"--" }}</div>
                            <div class="text-xs text-gray-500">Performance</div>
                        </div>
                    </div>

                    <!-- Budget Information -->
                    {% if department.budget %}
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Orçamento Anual</span>
                                <span class="text-sm font-semibold text-gray-900">
                                    R$ {{ department.budget|floatformat:2 }}
                                </span>
                            </div>
                            {% if department.budget_used %}
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" 
                                             style="width: {{ department.budget_usage_percentage }}%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Usado: {{ department.budget_usage_percentage }}%</span>
                                        <span>R$ {{ department.budget_remaining|floatformat:2 }} restante</span>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Goals Progress -->
                    {% if department.active_goals %}
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Metas do Departamento</span>
                                <span class="text-xs text-gray-500">{{ department.completed_goals }}/{{ department.total_goals }}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" 
                                     style="width: {{ department.goals_completion_percentage }}%"></div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Recent Activity -->
                    <div class="mb-4">
                        <div class="text-xs text-gray-500 mb-2">Atividade Recente</div>
                        {% if department.recent_activity %}
                            <div class="space-y-1">
                                {% for activity in department.recent_activity|slice:":2" %}
                                    <div class="text-xs text-gray-600 flex items-center">
                                        <i class="fas fa-circle text-blue-400 mr-2" style="font-size: 6px;"></i>
                                        {{ activity.description }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-xs text-gray-400">Nenhuma atividade recente</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions Footer -->
                <div class="bg-gray-50 px-6 py-4 border-t">
                    <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                            <a href="{% url 'hr:department_detail' department.pk %}" 
                               class="text-blue-600 hover:text-blue-800 transition-colors"
                               title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            <a href="{% url 'hr:department_form' department.pk %}" 
                               class="text-green-600 hover:text-green-800 transition-colors"
                               title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            <a href="{% url 'hr:employee_list' %}?department={{ department.pk }}" 
                               class="text-purple-600 hover:text-purple-800 transition-colors"
                               title="Ver Funcionários">
                                <i class="fas fa-users"></i>
                            </a>
                            
                            {% if department.is_active %}
                                <button onclick="toggleDepartmentStatus({{ department.pk }}, false)" 
                                        class="text-yellow-600 hover:text-yellow-800 transition-colors"
                                        title="Desativar">
                                    <i class="fas fa-pause"></i>
                                </button>
                            {% else %}
                                <button onclick="toggleDepartmentStatus({{ department.pk }}, true)" 
                                        class="text-green-600 hover:text-green-800 transition-colors"
                                        title="Ativar">
                                    <i class="fas fa-play"></i>
                                </button>
                            {% endif %}
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            {{ department.updated_at|timesince }} atrás
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-span-full text-center py-12">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-building text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum departamento encontrado</h3>
                <p class="text-gray-500 mb-4">
                    {% if request.GET.search %}
                        Não encontramos departamentos com os filtros aplicados.
                    {% else %}
                        Comece criando o primeiro departamento.
                    {% endif %}
                </p>
                <a href="{% url 'hr:department_form' %}" class="action-button primary">
                    <i class="fas fa-plus mr-2"></i>
                    Criar Departamento
                </a>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-8 flex justify-center">
        <nav class="flex items-center space-x-2">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Primeira
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Anterior
                </a>
            {% endif %}

            <span class="px-3 py-2 text-sm font-medium text-gray-700 bg-blue-50 border border-blue-200 rounded-md">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Próxima
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Última
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<!-- Status Toggle Modal -->
<div id="status-modal" class="hr-modal">
    <div class="hr-modal-content">
        <div class="hr-modal-header">
            <h3 class="hr-modal-title">Alterar Status do Departamento</h3>
            <button class="hr-modal-close" onclick="closeModal('status-modal')">&times;</button>
        </div>
        <div class="mb-6">
            <p>Tem certeza que deseja alterar o status deste departamento?</p>
            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-2 mt-1"></i>
                    <div class="text-sm text-yellow-800">
                        Esta ação pode afetar o acesso dos funcionários e a organização dos dados.
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-3">
            <button onclick="closeModal('status-modal')" class="action-button outline">
                Cancelar
            </button>
            <button id="confirm-status-change" class="action-button primary">
                Confirmar Alteração
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Status Toggle
    let currentDepartmentId = null;
    let currentNewStatus = null;
    
    function toggleDepartmentStatus(departmentId, newStatus) {
        currentDepartmentId = departmentId;
        currentNewStatus = newStatus;
        document.getElementById('status-modal').classList.add('active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    document.getElementById('confirm-status-change').addEventListener('click', function() {
        if (currentDepartmentId && currentNewStatus !== null) {
            // Make AJAX request to update status
            fetch(`/hr/department/${currentDepartmentId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    is_active: currentNewStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload page to show updated status
                } else {
                    alert('Erro ao alterar status: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao alterar status do departamento');
            });
        }
        closeModal('status-modal');
    });
    
    // Export functionality
    function exportDepartments() {
        const form = document.getElementById('filter-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.append('export', 'csv');
        
        window.location.href = `{% url 'hr:department_list' %}?${params.toString()}`;
    }
    
    // Auto-submit form on filter changes
    document.getElementById('filter-form').addEventListener('change', function() {
        this.submit();
    });
    
    // Close modals on outside click
    document.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.hr-modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
    
    // Initialize animations
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.grid > div');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 100}ms`;
            card.classList.add('slide-in-up');
        });
    });
</script>
{% endblock %}
