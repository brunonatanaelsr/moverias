<!-- Etapa 3: Observações e Finalização -->
<div class="space-y-6">
    <!-- Observações Gerais -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-clipboard-list mr-2"></i>
            Observações Gerais
        </h3>
        
        <div class="form-group">
            <label for="{{ wizard.form.observations.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                {{ wizard.form.observations.label }}
            </label>
            {{ wizard.form.observations|add_class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-vertical" }}
            <p class="form-help-text">
                <i class="fas fa-info-circle mr-1"></i>
                Registre observações importantes sobre a situação social da beneficiária, impressões da entrevista, pontos de atenção, etc.
            </p>
            {% if wizard.form.observations.errors %}
                <div class="text-red-600 text-sm mt-1">
                    {{ wizard.form.observations.errors }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Identificação de Vulnerabilidades -->
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-red-800 mb-3">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Vulnerabilidades Identificadas
        </h3>
        
        <div id="vulnerabilities-container">
            <!-- Template para vulnerabilidade -->
            <div class="vulnerability-template hidden" data-vuln-index="0">
                <div class="border border-gray-200 rounded-lg p-4 mb-4 bg-white">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-gray-800">Vulnerabilidade</h4>
                        <button type="button" class="remove-vulnerability text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <select name="vulnerability_category_0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Selecione...</option>
                                <option value="housing">Habitacional</option>
                                <option value="income">Renda/Emprego</option>
                                <option value="health">Saúde</option>
                                <option value="education">Educação</option>
                                <option value="family">Dinâmica Familiar</option>
                                <option value="violence">Violência</option>
                                <option value="substance_abuse">Uso de Substâncias</option>
                                <option value="social_isolation">Isolamento Social</option>
                                <option value="disability">Deficiência</option>
                                <option value="elderly">Pessoa Idosa</option>
                                <option value="children">Crianças/Adolescentes</option>
                                <option value="other">Outras</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Severidade</label>
                            <select name="vulnerability_severity_0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Selecione...</option>
                                <option value="low" class="text-green-600">Baixa</option>
                                <option value="medium" class="text-yellow-600">Média</option>
                                <option value="high" class="text-orange-600">Alta</option>
                                <option value="critical" class="text-red-600">Crítica</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição da vulnerabilidade</label>
                        <textarea name="vulnerability_description_0" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 resize-vertical" placeholder="Descreva detalhadamente a situação de vulnerabilidade..."></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Intervenção necessária</label>
                        <textarea name="vulnerability_intervention_0" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 resize-vertical" placeholder="Que tipo de intervenção é necessária?"></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prazo para intervenção</label>
                        <input type="date" name="vulnerability_deadline_0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
            </div>
        </div>
        
        <button type="button" id="add-vulnerability" class="w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-red-400 hover:text-red-600 transition-colors">
            <i class="fas fa-plus mr-2"></i>
            Adicionar Vulnerabilidade
        </button>
        
        <p class="form-help-text mt-2">
            <i class="fas fa-lightbulb mr-1"></i>
            Identifique todas as situações de vulnerabilidade observadas durante a avaliação
        </p>
    </div>

    <!-- Plano de Acompanhamento -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-green-800 mb-3">
            <i class="fas fa-tasks mr-2"></i>
            Plano de Acompanhamento
        </h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ações prioritárias</label>
                <textarea name="priority_actions" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 resize-vertical" placeholder="Liste as ações que devem ser priorizadas no acompanhamento desta beneficiária..."></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Frequência de acompanhamento sugerida</label>
                    <select name="follow_up_frequency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Selecione...</option>
                        <option value="weekly">Semanal</option>
                        <option value="biweekly">Quinzenal</option>
                        <option value="monthly">Mensal</option>
                        <option value="bimonthly">Bimestral</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="as_needed">Conforme necessidade</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Próxima revisão da anamnese</label>
                    <input type="date" name="next_review_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Encaminhamentos necessários</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="health_services" class="mr-2 text-green-600">
                        <span class="text-sm">Serviços de saúde</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="mental_health" class="mr-2 text-green-600">
                        <span class="text-sm">Saúde mental (CAPS, psicólogo)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="legal_services" class="mr-2 text-green-600">
                        <span class="text-sm">Defensoria Pública</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="education" class="mr-2 text-green-600">
                        <span class="text-sm">Programas educacionais</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="employment" class="mr-2 text-green-600">
                        <span class="text-sm">Programas de capacitação/emprego</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="cras_creas" class="mr-2 text-green-600">
                        <span class="text-sm">CRAS/CREAS</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="referrals" value="specialized_services" class="mr-2 text-green-600">
                        <span class="text-sm">Serviços especializados</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo da Anamnese -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-yellow-800 mb-3">
            <i class="fas fa-clipboard-check mr-2"></i>
            Resumo da Anamnese
        </h3>
        
        <div id="anamnesis-summary" class="text-sm text-gray-700">
            <!-- Resumo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- Termo de Consentimento -->
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-purple-800 mb-3">
            <i class="fas fa-file-signature mr-2"></i>
            Termo de Consentimento
        </h3>
        
        <div class="space-y-3">
            <label class="flex items-start">
                <input type="checkbox" name="consent_data_use" required class="mr-3 mt-1 text-purple-600">
                <span class="text-sm">
                    Declaro que autorizo o uso das informações fornecidas nesta anamnese social para fins de acompanhamento psicossocial no âmbito do programa Move Marias, respeitando os princípios de confidencialidade e sigilo profissional.
                </span>
            </label>
            
            <label class="flex items-start">
                <input type="checkbox" name="consent_information_accuracy" required class="mr-3 mt-1 text-purple-600">
                <span class="text-sm">
                    Confirmo que todas as informações fornecidas são verdadeiras e estou ciente de que alterações na minha situação devem ser comunicadas à equipe técnica.
                </span>
            </label>
            
            <label class="flex items-start">
                <input type="checkbox" name="consent_follow_up" required class="mr-3 mt-1 text-purple-600">
                <span class="text-sm">
                    Concordo em participar do acompanhamento social proposto e comprometo-me a comparecer aos atendimentos agendados.
                </span>
            </label>
        </div>
        
        <div class="mt-4 p-3 bg-white rounded border">
            <p class="text-xs text-gray-600">
                <strong>Data:</strong> <span id="current-date"></span><br>
                <strong>Técnica responsável:</strong> {{ request.user.get_full_name|default:request.user.username }}<br>
                <strong>Local:</strong> Instituto Move Marias
            </p>
        </div>
    </div>

    <!-- Dicas e Orientações -->
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-purple-800 mb-2">
            <i class="fas fa-lightbulb mr-2"></i>
            Antes de Finalizar
        </h3>
        <ul class="text-sm text-purple-700 space-y-1">
            <li>• Revise todas as informações preenchidas</li>
            <li>• Certifique-se de que todas as vulnerabilidades foram identificadas</li>
            <li>• Verifique se o plano de acompanhamento está adequado</li>
            <li>• Confirme que todos os termos de consentimento foram aceitos</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let vulnCount = 0;
    const container = document.getElementById('vulnerabilities-container');
    const template = document.querySelector('.vulnerability-template');
    const addButton = document.getElementById('add-vulnerability');

    // Adicionar vulnerabilidade
    addButton.addEventListener('click', function() {
        const newVuln = template.cloneNode(true);
        newVuln.classList.remove('vulnerability-template', 'hidden');
        newVuln.setAttribute('data-vuln-index', vulnCount);
        
        // Atualizar os names dos inputs
        const inputs = newVuln.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            const name = input.getAttribute('name');
            if (name) {
                input.setAttribute('name', name.replace('_0', `_${vulnCount}`));
            }
        });
        
        // Adicionar evento de remoção
        const removeBtn = newVuln.querySelector('.remove-vulnerability');
        removeBtn.addEventListener('click', function() {
            newVuln.remove();
            updateSummary();
        });
        
        container.appendChild(newVuln);
        vulnCount++;
        updateSummary();
    });

    // Atualizar data atual
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');

    // Função para atualizar o resumo
    function updateSummary() {
        const summaryDiv = document.getElementById('anamnesis-summary');
        let summary = '';
        
        // Beneficiária
        const beneficiary = document.querySelector('select[name="1-beneficiary"]');
        if (beneficiary && beneficiary.selectedOptions[0]) {
            summary += `<strong>Beneficiária:</strong> ${beneficiary.selectedOptions[0].text}<br>`;
        }
        
        // Renda familiar
        const familyIncome = document.querySelector('input[name="1-family_income"]');
        if (familyIncome && familyIncome.value) {
            summary += `<strong>Renda familiar:</strong> R$ ${parseFloat(familyIncome.value).toFixed(2)}<br>`;
        }
        
        // Situação habitacional
        const housing = document.querySelector('textarea[name="1-housing_situation"]');
        if (housing && housing.value.trim()) {
            summary += `<strong>Situação habitacional:</strong> ${housing.value.substring(0, 100)}${housing.value.length > 100 ? '...' : ''}<br>`;
        }
        
        // Rede de apoio
        const support = document.querySelector('textarea[name="2-support_network"]');
        if (support && support.value.trim()) {
            summary += `<strong>Rede de apoio:</strong> ${support.value.substring(0, 100)}${support.value.length > 100 ? '...' : ''}<br>`;
        }
        
        // Vulnerabilidades
        const vulnerabilities = document.querySelectorAll('[data-vuln-index]:not(.vulnerability-template)');
        if (vulnerabilities.length > 0) {
            summary += `<strong>Vulnerabilidades identificadas:</strong> ${vulnerabilities.length}<br>`;
        }
        
        summaryDiv.innerHTML = summary || '<em>Nenhuma informação preenchida ainda.</em>';
    }

    // Atualizar resumo quando houver mudanças
    document.addEventListener('input', updateSummary);
    document.addEventListener('change', updateSummary);
    
    // Atualizar resumo inicial
    updateSummary();

    // Validação final
    const form = document.getElementById('wizard-form');
    form.addEventListener('submit', function(e) {
        const consentBoxes = document.querySelectorAll('input[name^="consent_"]:checked');
        
        if (consentBoxes.length < 3) {
            e.preventDefault();
            alert('Todos os termos de consentimento devem ser aceitos para finalizar a anamnese.');
            return;
        }
        
        // Confirmação final
        if (!confirm('Tem certeza que deseja finalizar esta anamnese? Após a finalização, ela será bloqueada para edição.')) {
            e.preventDefault();
        }
    });
});
</script>
